<!doctype html>
<html>
  <head>
<style>

/* PrismJS 1.22.0
https://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript+solidity&plugins=line-numbers+autolinker+match-braces */
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
  color: black;
  background: none;
  text-shadow: 0 1px white;
  font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace;
  font-size: 1em;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre[class*="language-"]::-moz-selection,
pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection,
code[class*="language-"] ::-moz-selection {
  text-shadow: none;
  background: #b3d4fc;
}

pre[class*="language-"]::selection,
pre[class*="language-"] ::selection,
code[class*="language-"]::selection,
code[class*="language-"] ::selection {
  text-shadow: none;
  background: #b3d4fc;
}

@media print {
  code[class*="language-"],
  pre[class*="language-"] {
    text-shadow: none;
  }
}

/* Code blocks */
pre[class*="language-"] {
  padding: 1em;
  margin: 0.5em 0;
  overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
  background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: 0.1em;
  border-radius: 0.3em;
  white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
  color: slategray;
}

.token.punctuation {
  color: #999;
}

.token.namespace {
  opacity: 0.7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
  color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
  color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
  color: #9a6e3a;
  /* This background color was intended by the author of this theme. */
  background: hsla(0, 0%, 100%, 0.5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
  color: #07a;
}

.token.function,
.token.class-name {
  color: #dd4a68;
}

.token.regex,
.token.important,
.token.variable {
  color: #e90;
}

.token.important,
.token.bold {
  font-weight: bold;
}
.token.italic {
  font-style: italic;
}

.token.entity {
  cursor: help;
}

pre[class*="language-"].line-numbers {
  position: relative;
  padding-left: 3.8em;
  counter-reset: linenumber;
}

pre[class*="language-"].line-numbers > code {
  position: relative;
  white-space: inherit;
}

.line-numbers .line-numbers-rows {
  position: absolute;
  pointer-events: none;
  top: 0;
  font-size: 100%;
  left: -3.8em;
  width: 3em; /* works for line-numbers below 1000 lines */
  letter-spacing: -1px;
  border-right: 1px solid #999;

  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.line-numbers-rows > span {
  display: block;
  counter-increment: linenumber;
}

.line-numbers-rows > span:before {
  content: counter(linenumber);
  color: #999;
  display: block;
  padding-right: 0.8em;
  text-align: right;
}

.token a {
  color: inherit;
}
.token.punctuation.brace-hover,
.token.punctuation.brace-selected {
  outline: solid 1px;
}

.rainbow-braces .token.punctuation.brace-level-1,
.rainbow-braces .token.punctuation.brace-level-5,
.rainbow-braces .token.punctuation.brace-level-9 {
  color: #e50;
  opacity: 1;
}
.rainbow-braces .token.punctuation.brace-level-2,
.rainbow-braces .token.punctuation.brace-level-6,
.rainbow-braces .token.punctuation.brace-level-10 {
  color: #0b3;
  opacity: 1;
}
.rainbow-braces .token.punctuation.brace-level-3,
.rainbow-braces .token.punctuation.brace-level-7,
.rainbow-braces .token.punctuation.brace-level-11 {
  color: #26f;
  opacity: 1;
}
.rainbow-braces .token.punctuation.brace-level-4,
.rainbow-braces .token.punctuation.brace-level-8,
.rainbow-braces .token.punctuation.brace-level-12 {
  color: #e0e;
  opacity: 1;
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">

<style>

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
h1 {
  font-size: 1.5em;
}

h2 {
  font-size: 1.32em;
}

h3 {
  font-size: 1.17em;
}

.level {
  display: flex;
  flex-direction: row;
  line-height: 1.4;
  align-items: baseline;
  position: relative;
}

.level:first-child {
  padding-top: 3rem;
}

.level.scrollHighlighted {
  background: rgb(150 159 228 / 48%);
  border-right: 10px solid #515ba27a;
}

.titleLevel .left-background  {
  padding-top: 2em;
  //border-bottom: 4px solid #e5e5ee;
}

.left, .right {
  //border: 1px solid red;
}
.left-background {
  background: #f5f5ff;
  border-right: 1px solid #e5e5ee;
  width: 34rem;
  position: absolute;
  top: 0px;
  bottom: 0px;
  left: -1px;
  z-index: -1;
  padding-left: 4em;
}

.hover-background {
  border-top: 1px solid rgb(229 229 238 / 0.8);
  border-bottom: 1px solid rgb(229 229 238 / 0.3);
  right: 0px;
  width: auto;
  background: rgb(254 255 227 / 0.1);
  position: absolute;
  top: 0px;
  bottom: 0px;
  left: -1px;
  z-index: -1;
  padding-left: 4em;
  visibility: hidden;
}

body:not(.bodyFocusing) .level:hover .hover-background {
  visibility: visible;
}

.left {
  padding-left: 4rem;
  width: 34rem;
  align-items: stretch;
  font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
  text-align:right;
  flex-shrink: 0;
  flex-grow: 0;
}

.level .left {
  font-size: 1.1em;
  line-height: 1.44;
}


.lineComment {
  max-width: 80%;
  font-size:0.9em;
  text-align: right;
  background: white;
  display: inline-flex;
  flex-direction: column;
  //margin-right: calc(-1px);
  padding-top: 0.2rem;
  padding-bottom: 0.2rem;
  border: 1px solid #e5e5ee;
  border-right: none;
  padding-right: 1rem;
  padding-left: 1rem;
  margin-bottom: 2px;
  margin-left: 1rem;
  border-radius: 5px 0px 0px 5px;
}

.lineComment p {
  margin: 0
}

.blockComment {
  margin-right: 3rem;
  text-align: justify;
}

.blockComment *:not(li,code,.katex *) {
  margin-top: 0px;
  margin-bottom: 1.44em;
}

.blockComment *:last-child:not(li,code,.katex *) {
  margin-bottom: 0.72em;
}

.blockComment *:first-child:not(li,code,.katex *) {
  margin-top: 0.72em;
}

.blockComment p + ul,
.blockComment p + ol
{
  margin-top: -0.72em;
}

.blockComment ul, .blockComment ol {
  margin-bottom: 0.72em;
}

// fixme not working like I want
.blockCommont:not(:first-child) {
  margin-top: 1em;
}
.blockComment pre {
  white-space: pre-wrap;
  font-size: 0.84em;
  line-height: 1.44;
  margin-top: -1.055em;
  margin-bottom: 1.055em;
  background: hsl(240 21% 102% / 1);
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  padding-left: 0.5em;
  padding-right: 2em;
}

p code, ul code, ol code {
  background: hsl(240 21% 102% / 1);
  padding: 0.2em;
}



.right {
  position: relative;
  top: 0px;
  width: 50%;
  //padding-left: 0.5rem;
  display: flex;
} 

.right, .lines {
  line-height: 1.95;
}

.focusing {
  background: rgb(254 255 227);
}

.right:hover {
  //border: 1px solid blue;
}
.right code {
}

.codewrap {
  display: flex;
  flex-direction: row;
  transition: transform 300ms ease-in-out;
}

.focuser {
  align-self: stretch;
  flex-shrink: 0;
  font-size: 1.3rem;
  text-align: center;
  display: flex;
  flex-direction: row;
  justify-content: flex-start;
  color: white;
  z-index: 1000;
  position: absolute;
  left: 0;
  top: 0;
  width: 3.2rem;
  height: 100%;
}

.focus-icon {
  //line-height: 0.85;
  font-size: 1.5rem;
  width: 1em;
  flex-grow: 0;
  flex-shrink: 0;
}

.focus-icon:before, .focus-icon:after {
  position: absolute;
  text-align: center;
  display: block;
  left: 0;
  width: 1em;
  visibility: hidden;
  color: #797979;
}

.focus-icon:before {
  content:"↡";
  top: -1.55em;
  pointer-events: none;
}


.focus-icon:after {
  content:"↟";
  bottom: -1.45em;
  pointer-events: none;
}

body:not(.bodyFocusing) .focuser:hover,
body:not(.bodyFocusing) .focusing .focuser {
  border-top: 1px dashed #797979;
  border-bottom: 1px dashed #797979;
  cursor: pointer;
}

body:not(.bodyFocusing) .focuser:hover .focus-icon:before, 
body:not(.bodyFocusing) .focuser:hover .focus-icon:after,
body:not(.bodyFocusing) .focusing .focus-icon:before, 
body:not(.bodyFocusing) .focusing .focus-icon:after {
  visibility: visible;
}

pre {
  margin: 0;
}

.right {
  position: relative;
}
.lines {
  width: content;
  flex-shrink: 0;
  margin-right: 0;
  color: #797979;
  text-align: right;
  display: flex;
  justify-content: flex-end;
  margin-right: 1em;
}
.lines pre {
  width: 3.5em;
  pointer-events: none;
}

body {
  display: flex;
  flex-direction: row;
}

nav {
  width: 22em;
  flex-shrink: 0;
  background: hsl(240 47% 17% / 1);
  position: sticky;
  top: 0px;
  font-size: 0.9em;
  padding-top: 3rem;
  padding-bottom: 3rem;
  height: calc(100vh - 6rem);
  font-family: 'Lato', sans-serif;
  background: #f5f5ff;
  overflow-y: auto;
}

nav a {
  color: hsl(240 82% 98% / 1);
  color: black;
  display: block;
  text-decoration: none;
  line-height: 1;
  padding-left: 3rem;
}

nav a:hover {
  background: white;
}

nav a.highlight {
  background: white;
}

nav a.toc-file:hover {
  background: black;
}

.toc-file {
  font-family: monospace;
  font-size: 1.3em;
  padding-top: 0.7em;
  padding-bottom: 0.6em;
  border-top: 1px solid #e5e5ee;
  border-bottom: 1px solid #e5e5ee;
  background: #37718E;
  color: white;
}

* + .toc-file {
  margin-top: 2em;
}

.toc-h1 {
  font-size: 1.2em;
  font-weight: 600;
  padding-top: 0.6em;
  padding-bottom: 0.55em;
}

.toc-h2 {
  font-size: 1em;
  padding-left: 3.5rem;
  padding-top: 0.4em;
  padding-bottom: 0.4em;
}

.toc-h3 + .toc-h2 {
  margin-top: .4em;
}

.toc-h3 + .toc-h1,
.toc-h2 + .toc-h1 {
  margin-top: .4em;
}

.toc-h3 {
  font-size: 0.8em;
  padding-left: 6.5rem;
  padding-top: 0.4em;
  padding-botom: 0.6em;
}

a {
  color: black;
}

.filebreak {
  width: calc(100% - 4em - 2px);
  font-family: monospace;
  /*background: #e5e5ee;*/
  background: #37718E;
  color: white;
  text-align: left;
  font-size: 1.18em !important;
  padding-top: 0.7em;
  padding-bottom: 0.6em;
  line-height: 1 !important;
  border-top: 1px solid #e5e5ee;
  border-bottom: 1px solid #e5e5ee;
}

.katex { 
  font-size: 1em;
}
</style>
<script>

/* Bounds of DOM element, including margin */
let bounds = (el,wsy) => {
  const rect = el.getBoundingClientRect();
  const style = getComputedStyle(el);
  return {
    top: wsy + rect.top - parseInt(style.marginTop),
    bottom: wsy + rect.bottom + parseInt(style.marginBottom)
  };
};

window.addEventListener('DOMContentLoaded', () => {

  /* For future reference. The current TOC highlight fails when you scroll up into a no-headings zone. Then the highlighted heading is the one below the bottom of the viewport; it should be the one above the top of the viewport. A more complete decision tree for future implementation:
  * have an array of all heading elements, and they know their position in the array
  * have a pointer to "lowest heading above viewport lower edge ("the fold").
  * keep set of visible elements
  * when an element comes in or out of the set, run:
  lowestAboveFold = i
  point = lower above fold
  for entry in entries
    if entry.out
      if entry.too_low
        if point below or is entry
          point = entry.prev
        else ()
      else (entry.too_high)
        if nobody_visible () [???]
        else () [???]
    else (entry.in)
      if point above or is entry
        point = entry
  */

  /* Keep roughly track of currently viewed section, highlight corresponding toc in nav */
  const visibleHeadings = new Set();
  const observer = new IntersectionObserver(entries => {
    for (const entry of entries)
      visibleHeadings[entry.isIntersecting ? 'add' : 'delete'](entry.target);
    }, {threshold:0});
    const headingsSelector = Array.from({length: 2 }, (_,i) => `h${i+1}`).join(', ');
    const headings = document.querySelectorAll(headingsSelector);


    for (const heading of headings) observer.observe(heading);

    let curHeading = null;
    window.addEventListener('scroll', e => {
      let minBelow = [Infinity,null];
      for (const heading of visibleHeadings) {
        const b = heading.getBoundingClientRect().bottom;
        if (b < minBelow[0]) minBelow = [b,heading];
      }
      if (minBelow[1] !== curHeading) {
        if (minBelow[1] && curHeading) {
          document.querySelector(`a[href="#${curHeading.id}"]`).classList.remove('highlight');
        }
        if (minBelow[1]) {
          curHeading = minBelow[1];
          document.querySelector(`a[href="#${curHeading.id}"]`).classList.add('highlight');
        }
      }
    });

  /* Initialize cache _translate to 0 */
  for (const focuser of document.querySelectorAll('.codewrap')) {
    focuser._translate = 0;
  }

  /* Loop through all codewraps. Treat codewraps before t (which is a codewrap)
  * in reverse order. Stack codewraps above and below t. */
  const focus = (t) => {
    const wsy = window.scrollY; // cache value for performance, big difference in chrome
    let isBefore = true;
    const tBounds = bounds(t,wsy);
    let prevBottom = tBounds.bottom - t._translate;
    let prevTop = tBounds.top - t._translate;
    t._translate = 0;
    let befores = [];
    // apply changes after t from t downwards
    for (const cur of document.querySelectorAll(".codewrap")) {
      if (cur === t) {
        isBefore = false;
      } else if (isBefore) {
        befores.push(cur);
      } else {
        const cBounds = bounds(cur,wsy);
        const _translate = prevBottom - cBounds.top;
        cur._translate = cur._translate + _translate;
        prevBottom = prevBottom + (cBounds.bottom - cBounds.top);
      }
    }

    // apply changes before t from t upwards
    let cur;
    while ((cur = befores.pop())) {
      const cBounds = bounds(cur,wsy);
      const _translate = prevTop - cBounds.bottom;
      cur._translate = cur._translate + _translate;
      prevTop = prevTop - (cBounds.bottom - cBounds.top);
    }

    // batch changes after reading layout to avoid layout thrashing
    for (const cur of document.querySelectorAll('.codewrap')) {
      cur.style.transform = `translate(0px,${cur._translate}px)`;
    }

  };

  /* Stop focusing */
  let currentFocuser;

  const defocus = () => {
    currentFocuser.parentNode.classList.remove("focusing");
    document.body.classList.remove('bodyFocusing');
    currentFocuser = undefined;
    for (const t of document.querySelectorAll(".codewrap")) {
      t.style.transform = "translate(0px,0px)";
      t._translate = 0;
    }
  };

  /* Defocus when clicking anywhere and currently in focus */
  document.body.addEventListener('click', e => {
    if (currentFocuser) defocus();
  });

  /* Focus when clicking a focuser. Disabled when in focus.  */
  for (const focuser of document.querySelectorAll('.focuser')) {
    focuser.addEventListener('click', e => {
      if (currentFocuser) return;
      currentFocuser = e.currentTarget;
      focus(currentFocuser.parentNode.querySelector('.codewrap'));
      currentFocuser.parentNode.classList.add("focusing");
      document.body.classList.add('bodyFocusing');
      e.stopPropagation();
    });
  }

  /* Avoid horizontal scrolling when clicking on internal anchors */
  let scrollHighlighted = null;

  const doScroll = target => target.scrollIntoView({behavior: "auto", block: "start", inline: "end"});

  for (const anchor of document.querySelectorAll("a[href^='#']")) {
    anchor.addEventListener('click', e => {
      e.preventDefault();
      history.pushState(null, null, anchor.getAttribute('href'));
      // Must use [id=] syntax instead of # syntax to escape forward slash in anchor name.
      const target = document.querySelector(`[id='${anchor.getAttribute("href").slice(1)}']`);
      if (scrollHighlighted) {
        scrollHighlighted.classList.remove('scrollHighlighted');
      }
      scrollHighlighted = target.closest('.level');
      if (scrollHighlighted) {
        doScroll(scrollHighlighted);
        scrollHighlighted.classList.add('scrollHighlighted');
      } else {
        doScroll(target);
      }
    });
  };
});
</script>
</head>
  <body>
    <nav>
      <a href="#structs.ts" class="toc-file">structs.ts</a>
      <a href="#structs.ts-mangrove-summary" class="toc-h1">Mangrove Summary</a>
      <a href="#structs.ts-ratio-and-price" class="toc-h2">Ratio and price</a>
      <a href="#structs.ts-tickspacing" class="toc-h2">tickSpacing</a>
      <a href="#structs.ts-tree-storage" class="toc-h2">Tree storage</a>
      <a href="#structs.ts-caching" class="toc-h2">Caching</a>
      <a href="#structs.ts-some-numbers" class="toc-h2">Some numbers</a>
      <a href="#structs.ts-preprocessing" class="toc-h1">Preprocessing</a>
      <a href="#structs.ts-data-structures" class="toc-h1">Data structures</a>
      <a href="#structs.ts-structs" class="toc-h1">Structs</a>
      <a href="#structs.ts-offer" class="toc-h2">Offer</a>
      <a href="#structs.ts-offerdetail" class="toc-h2">OfferDetail</a>
      <a href="#structs.ts-global-configuration" class="toc-h2">Global Configuration</a>
      <a href="#structs.ts-local-configuration" class="toc-h2">Local configuration</a>
      <a href="#constants.sol" class="toc-file">Constants.sol</a>
      <a href="#mgvlib.sol" class="toc-file">MgvLib.sol</a>
      <a href="#mgvlib.sol-structs-0" class="toc-h1">Structs</a>
      <a href="#mgvlib.sol-events" class="toc-h1">Events</a>
      <a href="#mgvlib.sol-imaker-interface" class="toc-h1">IMaker interface</a>
      <a href="#mgvlib.sol-monitor-interface" class="toc-h1">Monitor interface</a>
      <a href="#mgvcommon.sol" class="toc-file">MgvCommon.sol</a>
      <a href="#mgvcommon.sol-state-variables" class="toc-h1">State variables</a>
      <a href="#mgvcommon.sol-gatekeeping" class="toc-h1">Gatekeeping</a>
      <a href="#mgvcommon.sol-token-transfer-functions" class="toc-h1">Token transfer functions</a>
      <a href="#mgvcommon.sol-permit-related-functionality" class="toc-h1">Permit-related functionality</a>
      <a href="#mgvhasoffers.sol" class="toc-file">MgvHasOffers.sol</a>
      <a href="#mgvhasoffers.sol-provision-debit%2Fcredit-utility-functions" class="toc-h1">Provision debit/credit utility functions</a>
      <a href="#mgvhasoffers.sol-misc.-low-level-functions" class="toc-h1">Misc. low-level functions</a>
      <a href="#mgvhasoffers.sol-offer-deletion" class="toc-h2">Offer deletion</a>
      <a href="#mgvhasoffers.sol-removing-an-offer-from-the-tick-tree" class="toc-h2">Removing an offer from the tick tree</a>
      <a href="#mgvoffermaking.sol" class="toc-file">MgvOfferMaking.sol</a>
      <a href="#mgvoffermaking.sol-public-maker-operations" class="toc-h1">Public Maker operations</a>
      <a href="#mgvoffermaking.sol-new-offer" class="toc-h2">New Offer</a>
      <a href="#mgvoffermaking.sol-update-offer" class="toc-h2">Update Offer</a>
      <a href="#mgvoffermaking.sol-retract-offer" class="toc-h2">Retract Offer</a>
      <a href="#mgvoffermaking.sol-provisioning" class="toc-h2">Provisioning</a>
      <a href="#mgvoffermaking.sol-low-level-maker-functions" class="toc-h1">Low-level Maker functions</a>
      <a href="#mgvoffermaking.sol-write-offer" class="toc-h2">Write Offer</a>
      <a href="#mgvoffertaking.sol" class="toc-file">MgvOfferTaking.sol</a>
      <a href="#mgvoffertaking.sol-multiorder-struct" class="toc-h1">MultiOrder struct</a>
      <a href="#mgvoffertaking.sol-market-orders" class="toc-h1">Market Orders</a>
      <a href="#mgvoffertaking.sol-market-order" class="toc-h2">Market Order</a>
      <a href="#mgvoffertaking.sol-general-market-order" class="toc-h1">General Market Order</a>
      <a href="#mgvoffertaking.sol-internal-market-order" class="toc-h2">Internal market order</a>
      <a href="#mgvoffertaking.sol-cleaning" class="toc-h1">Cleaning</a>
      <a href="#mgvoffertaking.sol-general-execution" class="toc-h1">General execution</a>
      <a href="#mgvoffertaking.sol-execute" class="toc-h2">Execute</a>
      <a href="#mgvoffertaking.sol-flashloan" class="toc-h2">Flashloan</a>
      <a href="#mgvoffertaking.sol-maker-execute" class="toc-h2">Maker Execute</a>
      <a href="#mgvoffertaking.sol-post-execute" class="toc-h2">Post execute</a>
      <a href="#mgvoffertaking.sol-maker-posthook" class="toc-h2">Maker Posthook</a>
      <a href="#mgvoffertaking.sol-controlledcall" class="toc-h2">controlledCall</a>
      <a href="#mgvoffertaking.sol-penalties" class="toc-h1">Penalties</a>
      <a href="#mgvoffertaking.sol-misc.-functions" class="toc-h1">Misc. functions</a>
      <a href="#mgvoffertakingwithpermit.sol" class="toc-file">MgvOfferTakingWithPermit.sol</a>
      <a href="#mgvoffertakingwithpermit.sol-delegation-public-functions" class="toc-h1">Delegation public functions</a>
      <a href="#mgvoffertakingwithpermit.sol-misc.-low-level-functions-0" class="toc-h1">Misc. low-level functions</a>
      <a href="#mgvgovernable.sol" class="toc-file">MgvGovernable.sol</a>
      <a href="#mgvgovernable.sol-authonly-check" class="toc-h2">authOnly check</a>
      <a href="#mgvgovernable.sol-transfer-erc20-tokens-to-governance." class="toc-h2">Transfer ERC20 tokens to governance.</a>
      <a href="#mgvgovernable.sol-set-configuration-and-mangrove-state" class="toc-h1">Set configuration and Mangrove state</a>
      <a href="#mgvgovernable.sol-locals" class="toc-h2">Locals</a>
      <a href="#mgvgovernable.sol-globals" class="toc-h2">Globals</a>
      <a href="#mgvview.sol" class="toc-file">MgvView.sol</a>
      <a href="#mgvview.sol-configuration-reads" class="toc-h1">Configuration Reads</a>
      <a href="#mgvview.sol-tick-tree-view-functions" class="toc-h1">Tick tree view functions</a>
      <a href="#mgvview.sol-offer-list-view-functions" class="toc-h1">Offer list view functions</a>
      <a href="#mgvview.sol-offer-view-functions" class="toc-h1">Offer view functions</a>
      <a href="#mgvappendix.sol" class="toc-file">MgvAppendix.sol</a>
      <a href="#mangrove.sol" class="toc-file">Mangrove.sol</a>
      <a href="#densitylib.sol" class="toc-file">DensityLib.sol</a>
      <a href="#ticktreelib.sol" class="toc-file">TickTreeLib.sol</a>
      <a href="#ticktreelib.sol-libraries-for-tick-tree-manipulation" class="toc-h1">Libraries for tick tree manipulation</a>
      <a href="#ticktreelib.sol-clean%2Fdirty-fields-and-leaves" class="toc-h2">Clean/Dirty Fields and Leaves</a>
      <a href="#ticklib.sol" class="toc-file">TickLib.sol</a>
      <a href="#ticklib.sol-ticklib" class="toc-h1">TickLib</a>
      <a href="#ticklib.sol-conversion-functions" class="toc-h2">Conversion functions</a>
      <a href="#ticklib.sol-ratio-representation" class="toc-h2">Ratio representation</a>
      <a href="#bitlib.sol" class="toc-file">BitLib.sol</a>
      <a href="#offerextra.sol" class="toc-file">OfferExtra.sol</a>
      <a href="#offerdetailextra.sol" class="toc-file">OfferDetailExtra.sol</a>
      <a href="#localextra.sol" class="toc-file">LocalExtra.sol</a>
    </nav>
    <main>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="structs.ts" class="left filebreak">structs.ts</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="structs.ts-mangrove-summary">Mangrove Summary</h1>
<ul>
<li>Mangrove holds offer lists for <code>outbound_tkn</code>,<code>inbound_tkn</code> pairs with a given <code>tickSpacing</code>.</li>
<li>Offers are sorted in a tree (the “tick tree”) where each available price point (a <code>bin</code>) holds a doubly linked list of offers.</li>
<li>Each offer promises <code>outbound_tkn</code> and requests <code>inbound_tkn</code>.</li>
<li>Each offer has an attached <code>maker</code> address.</li>
<li>When an offer is executed, Mangrove does the following:
<ol>
<li>Flashloan some <code>inbound_tkn</code> to the offer’s <code>maker</code>.</li>
<li>Call an arbitrary <code>execute</code> function on that address.</li>
<li>Transfer back some <code>outbound_tkn</code>.</li>
<li>Call back the <code>maker</code> so they can update their offers.</li>
</ol>
</li>
</ul>
<p><strong>Let the devs know about any error, typo etc, by contacting 	devs@mangrove.exchange</strong></p>
<p>More documentation / discussions can be found at https://docs.mangrove.exchange/.</p>
<p>There is one Mangrove contract that manages all tradeable offer lists. This reduces deployment costs for new offer lists and lets market makers have all their provision for all offer lists in the same place.</p>
<p>The interaction map between the different actors is as follows:
<img src="./contactMap.png" width="190%"></img></p>
<p>The sequence diagram of a market order is as follows:
<img src="./sequenceChart.png" width="190%"></img></p>
<h2 id="structs.ts-ratio-and-price">Ratio and price</h2>
<p>In the comments, we use the word ‘price’ to refer to the ratio between the amount promised by an offer and the amount of requests in return. In the code however, we use the generic word <code>ratio</code> to avoid confusion with notions of price based on concepts such as ‘quote’ and ‘base’ tokens,etc.</p>
<h2 id="structs.ts-tickspacing"><code>tickSpacing</code></h2>
<p>The granularity of available price points in an offer list is controlled by the <code>tickSpacing</code> parameter. With a high <code>tickSpacing</code>, fewer price points are available, but the gas cost of market orders is lower since a smaller part of the tick tree has to be explored.</p>
<p>The available prices in an offer list are <code>1.0001^i</code> for all <code>MIN_TICK &lt;= i &lt;= MAX_TICK</code> such that <code>i % tickSpacing = 0</code>.</p>
<h2 id="structs.ts-tree-storage">Tree storage</h2>
<p>Offers are stored in a tree we call a “tick tree”. Thanks to this tree structure, offer operations (insert, update, and retract) take constant time (the height of the tree is fixed).</p>
<h3>Bins</h3>
<p><img src="./bin.png" width="80%"></img></p>
<p>Below the bottom of the tree are <em>bins</em>. A bin is a doubly linked list of offers. All offers in a bin have the same tick. During a market order, offers in a bin are executed in order, from the first to the last. Inserted offers are always appended at the end of a bin.</p>
<p>Bins are laid in sequence. In the context of an offer list, each bin has an associated tick (and a tick determines a price). If a bin has tick <code>t</code>, the following bin has tick <code>t+tickSpacing</code>.</p>
<p>Bins are identified by their index in the bin sequence, from the first (<code>MIN_BIN</code>) to the last (<code>MAX_BIN</code>). The number of available bins is larger than the number of available ticks, so some bins will never be used.</p>
<h3>Tree structure</h3>
<p>The structure of the tick tree is as follows:
<img src="./tick_tree_structure.png" width="190%"></img></p>
<p>At the bottom of the tree, leaves contain information about 4 bins: their first and last offer. Offer ids use 32 bits, so leaves use 256 bits.</p>
<p>When a market order runs, execution starts with the first offer of the lowest-numbered nonempty bin and continues from there.</p>
<p>Once all the offers in the smallest bin have been executed, the next non-empty bin is found. If the leaf of the current bin now only has empty bins, the tree must be searched for the next non-empty bin, starting at the node above the leaf:</p>
<p>A non-leaf node contains a bit field with information about all its children: if the <em>i</em>th bit of the node is set, its <em>i</em>th child has at least one non-empty bin. Otherwise, its <em>i</em>th child only has empty bins.</p>
<p>To find the next non-empty bin, it may be necessary to keep going up the tree until the root is reached. At each level above, the bit field rule applies similarly: the <em>i</em>th bit of a node is set iff its <em>i</em>th child has at least one set bit.</p>
<p>Once a node with a set bit is found, its rightmost nonempty child is examined, and so on until the next nonempty bin is reached, and the first offer of that bin gets executed.</p>
<h2 id="structs.ts-caching">Caching</h2>
<p>At any time, if there is at least one offer in the offer list, the best offer is the first offer of the bin containing the cheapest offers; and that bin is the best bin. Its parent is the best <code>level3</code>, whose parent is the best <code>level2</code>, and whose parent is the best <code>level1</code> (whose parent is the <code>root</code>).</p>
<p>The <code>root</code>, the best <code>level1</code>, the  best <code>level2</code>, and the best <code>level3</code> are always stored in <code>local</code>. The position of the best bin in the best leaf is also stored in <code>local</code>.</p>
<p>This data is useful for two things:</p>
<ul>
<li>Read and modify the tree branch of the best offer without additional storage reads and writes (except for modifying the best leaf).</li>
<li>Know the price of the best offer without an additional storage read (it can be computed using the set bit positions in each level, the position of the best bin in the best leaf, and the value of <code>tickSpacing</code>).</li>
</ul>
<p>The structure of the local config is as follows:
<img src="./local_config.png" width="140%"></img></p>
<p>This caching means that as the price oscillates within a more restricted range, fewer additional storage read/writes have to be performed (as most of the information is available in <code>local</code>) when there is a market order or an offer insertion/update.</p>
<h2 id="structs.ts-some-numbers">Some numbers</h2>
<p>Here are some useful numbers, for reference:
<img src="./numbers.png" width="70%"></img></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="structs.ts-preprocessing">Preprocessing</h1>
<p>The current file (<code>structs.js</code>) is used in <code>Structs.pre.sol</code> (not shown here) to generate the libraries in <code>Struct.pre.sol</code>. Here is an example of js struct specification and of a generated library:</p>
<pre><code>struct_defs = {
universe: [
 {name: &quot;serialnumber&quot;, bits: 16, type: &quot;uint&quot;},
 {name: &quot;hospitable&quot;,bits: 8, type:&quot;bool&quot;}
]
}
</code></pre>
<p>The generated file will store all data in a single EVM stack slot (seen as an abstract type <code>&lt;TypeName&gt;</code> by Solidity); here is a simplified version:</p>
<pre><code>struct UniverseUnpacked {
uint serialnumber;
bool hospitable;
}

library Library {
// use Solidity 0.8* custom types
type Universe is uint;

// test word equality
function eq(Universe ,Universe) returns (bool);

// word &lt;-&gt; struct conversion
function to_struct(Universe) returns (UniverseUnpacked memory);
function t_of_struct(UniverseUnpacked memory) returns (Universe);

// arguments &lt;-&gt; word conversion
function unpack(Universe) returns (uint serialnumber, bool hospitable);
function pack(uint serialnumber, bool hospitable) returns(Universe);

// read and write first property
function serialnumber(Universe) returns (uint);
function serialnumber(Universe,uint) returns (Universe);

// read and write second property
function hospitable(Universe) returns (bool);
function hospitable(Universe,bool) returns (Universe);
}
</code></pre>
<p>Then, in Solidity code, one can write:</p>
<pre><code>Universe uni = UniverseLib.pack(32,false);
uint num = uni.serialnumber();
uni.hospitable(true);
</code></pre>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="structs.ts-data-structures">Data structures</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Struct-like data structures are stored in storage and memory as 256 bits words. We avoid using structs due to significant gas savings gained by extracting data from words only when needed. This is exacerbated by the fact that Mangrove uses one recursive call per executed offer; it is much cheaper to accumulate used stack space than memory space throughout the recursive calls.</p>
<p>The generation is defined in <code>lib/preproc.ts</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Struct fields that are common to multiple structs are factored here. Multiple field names refer to offer identifiers, so the <code>id_field</code> is a function that takes a name as argument and returns a field with the right size &amp; type.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>151
152
153
154
155
156
157
158
159
160
161
162</pre></code>
          <pre>
<span class="token keyword">const</span> fields <span class="token operator">=</span> <span class="token punctuation">{</span>
  gives<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"gives"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">127</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  gasprice<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"gasprice"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  gasreq<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"gasreq"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  kilo_offer_gasbase<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"kilo_offer_gasbase"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">id_field</span> <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="structs.ts-structs">Structs</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="structs.ts-offer"><code>Offer</code></h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>Offer</code>s hold doubly linked list pointers to their prev and next offers, as well as price and volume information. 256 bits wide, so one storage read is enough. They have the following fields:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>169
170
171</pre></code>
          <pre><span class="token keyword">const</span> struct_defs <span class="token operator">=</span> <span class="token punctuation">{</span>
  offer<span class="token operator">:</span> <span class="token punctuation">{</span>
    fields<span class="token operator">:</span> <span class="token punctuation">[</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>prev</code> points to immediately better offer at the same price point, if any, and 0 if there is none. <em>32 bits wide</em>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>173</pre></code>
          <pre>      <span class="token function">id_field</span><span class="token punctuation">(</span><span class="token string">"prev"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>next</code> points to immediately worse offer at the same price point, if any, and 0 if there is none. <em>32 bits wide</em>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>175</pre></code>
          <pre>      <span class="token function">id_field</span><span class="token punctuation">(</span><span class="token string">"next"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>tick</code> is the log base 1.0001 of the price of the offer. <em>21 bits wide</em>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>177</pre></code>
          <pre>      <span class="token punctuation">{</span>name<span class="token operator">:</span><span class="token string">"tick"</span><span class="token punctuation">,</span>bits<span class="token operator">:</span><span class="token number">21</span><span class="token punctuation">,</span>type<span class="token operator">:</span><span class="token string">"Tick"</span><span class="token punctuation">,</span>underlyingType<span class="token operator">:</span> <span class="token string">"int"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>gives</code> is the amount of <code>outbound_tkn</code> the offer will give if successfully executed. <em>127 bits wide</em>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>179
180
181
182
183
184
185
186
187
188
189</pre></code>
          <pre>      fields<span class="token punctuation">.</span>gives<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    additionalDefinitions<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import {Bin} from "@mgv/lib/core/TickTreeLib.sol";
import {Tick} from "@mgv/lib/core/TickLib.sol";
import {OfferExtra,OfferUnpackedExtra} from "@mgv/lib/core/OfferExtra.sol";

using OfferExtra for Offer global;
using OfferUnpackedExtra for OfferUnpacked global;
</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="structs.ts-offerdetail"><code>OfferDetail</code></h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>OfferDetail</code>s hold the maker’s address and provision/penalty-related information.
They have the following fields:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>194
195</pre></code>
          <pre>  offerDetail<span class="token operator">:</span> <span class="token punctuation">{</span>
    fields<span class="token operator">:</span> <span class="token punctuation">[</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>maker</code> is the address that created the offer. It will be called when the offer is executed and later during the posthook phase.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>197</pre></code>
          <pre>      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"maker"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">160</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"address"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><a id="structs.js/gasreq"></a><code>gasreq</code> gas will be provided to <code>execute</code>. <em>24 bits wide</em>, i.e. around 16M gas. Note that if more room was needed, we could bring it down to 16 bits and have it represent 1k gas increments.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>201</pre></code>
          <pre>      fields<span class="token punctuation">.</span>gasreq<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><a id="structs.js/gasbase"></a>  <code>kilo_offer_gasbase</code> represents the gas overhead used by processing the offer inside Mangrove + the overhead of initiating an entire order, in 1k gas increments.</li>
</ul>
<p>The gas considered ‘used’ by an offer is the sum of</p>
<ul>
<li>gas consumed during the call to the offer</li>
<li><code>kilo_offer_gasbase * 1e3</code></li>
</ul>
<p>(There is an inefficiency here. The overhead could be split into an “offer-local overhead” and a “general overhead”. That general overhead gas penalty could be spread between all offers executed during an order, or all failing offers. It would still be possible for a cleaner to execute a failing offer alone and make them pay the entire general gas overhead. For the sake of simplicity we keep only one “offer overhead” value.)</p>
<p>If an offer fails, <code>gasprice</code> Mwei is taken from the
provision per unit of gas used. <code>gasprice</code> should approximate the average gas
price at offer creation time.</p>
<p><code>kilo_offer_gasbase</code> is the actual field name, is <em>9 bits wide</em>, and represents 1k gas increments. The accessor <code>offer_gasbase</code> returns <code>kilo_offer_gasbase * 1e3</code>.</p>
<p><code>kilo_offer_gasbase</code> is also the name of a local Mangrove
parameter. When an offer is created, its current value is copied from Mangrove local configuration. The maker does not choose it.</p>
<p>So, when an offer is created, the maker is asked to provision the
following amount of wei:</p>
<pre><code>(gasreq + offer_gasbase) * gasprice * 1e6
</code></pre>
<p>where <code>offer_gasbase</code> and <code>gasprice</code> are Mangrove’s current configuration values (or a higher value for <code>gasprice</code> if specified by the maker).</p>
<p>When an offer fails, the following amount is given to the taker as compensation:</p>
<pre><code>(gasused + offer_gasbase) * gasprice * 1e6
</code></pre>
<p>where <code>offer_gasbase</code> and <code>gasprice</code> are Mangrove’s current configuration values.  The rest is given back to the maker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>237</pre></code>
          <pre>      fields<span class="token punctuation">.</span>kilo_offer_gasbase<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>gasprice</code> is in Mwei/gas and <em>26 bits wide</em>, which accommodates 0.001 to ~67k gwei / gas.  <code>gasprice</code> is also the name of a global Mangrove parameter. When an offer is created, the offer’s <code>gasprice</code> is set to the max of the user-specified <code>gasprice</code> and Mangrove’s global <code>gasprice</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>239
240
241
242
243
244
245
246</pre></code>
          <pre>      fields<span class="token punctuation">.</span>gasprice<span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function-variable function">additionalDefinitions</span><span class="token operator">:</span> <span class="token punctuation">(</span>struct<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import {OfferDetailExtra,OfferDetailUnpackedExtra} from "@mgv/lib/core/OfferDetailExtra.sol";
using OfferDetailExtra for OfferDetail global;
using OfferDetailUnpackedExtra for OfferDetailUnpacked global;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="structs.ts-global-configuration">Global Configuration</h2>
<p>Configuration information for an offer list is split between a <code>global</code> struct (common to all offer lists) and a <code>local</code> struct specific to each offer list. Global configuration fields are:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>250
251</pre></code>
          <pre>  global<span class="token operator">:</span> <span class="token punctuation">{</span>
    fields<span class="token operator">:</span> <span class="token punctuation">[</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>The <code>monitor</code> can provide real-time values for <code>gasprice</code> and <code>density</code> to Mangrove. It can also receive liquidity event notifications.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>253</pre></code>
          <pre>      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"monitor"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">160</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"address"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>If <code>useOracle</code> is true, Mangrove will use the monitor address as an oracle for <code>gasprice</code> and <code>density</code>, for every outbound_tkn/inbound_tkn pair, except if the oracle-provided values do not pass a check performed by Mangrove. In that case the oracle values are ignored.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>255</pre></code>
          <pre>      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"useOracle"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"bool"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>If <code>notify</code> is true, Mangrove will notify the monitor address after every offer execution.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>257</pre></code>
          <pre>      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"notify"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"bool"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>The <code>gasprice</code> is the amount of penalty paid by failed offers, in Mwei per gas used. <code>gasprice</code> should approximate the average gas price and will be subject to regular updates.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>259</pre></code>
          <pre>      fields<span class="token punctuation">.</span>gasprice<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>gasmax</code> specifies how much gas an offer may ask for at execution time. An offer which asks for more gas than the block limit would live forever on the book. Nobody could take it or remove it, except its creator (who could cancel it). In practice, we will set this parameter to a reasonable limit taking into account both practical transaction sizes and the complexity of maker contracts.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>262</pre></code>
          <pre>      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"gasmax"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>dead</code>: if necessary, Mangrove can be entirely deactivated by governance (offers can still be retracted and provisions can still be withdrawn). Once killed, Mangrove must be redeployed; It cannot be resurrected.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>264</pre></code>
          <pre>      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"dead"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"bool"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>maxRecursionDepth</code> is the maximum number of times a market order can recursively execute offers. This is a protection against stack overflows.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>266</pre></code>
          <pre>      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"maxRecursionDepth"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>      </pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>maxGasreqForFailingOffers</code> is the maximum gasreq failing offers can consume in total. This is used in a protection against failing offers collectively consuming the block gas limit in a market order. Setting it too high would make it possible for successive failing offers to consume up to that limit then trigger a revert (thus the failing offer would not be removed). During a market order, Mangrove keeps a running sum of the <code>gasreq</code> of the failing offers it has executed and stops the market order when that sum exceeds <code>maxGasreqForFailingOffers</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>268
269
270
271</pre></code>
          <pre>      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"maxGasreqForFailingOffers"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>      
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="structs.ts-local-configuration">Local configuration</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>273
274</pre></code>
          <pre>  local<span class="token operator">:</span> <span class="token punctuation">{</span>
    fields<span class="token operator">:</span> <span class="token punctuation">[</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>An offer list is not <code>active</code> by default, but may be activated/deactivated by governance.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>276</pre></code>
          <pre>      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"active"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"bool"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>fee</code>, in basis points, of <code>outbound_tkn</code> given to the taker. This fee is sent to Mangrove. Fee is capped to ~2.5%.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>278</pre></code>
          <pre>      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"fee"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>density</code> is similar to a ‘dust’ parameter. We prevent spamming of low-volume offers by asking for a minimum ‘density’ in <code>outbound_tkn</code> per gas requested. For instance, if <code>density</code> is worth 10, <code>offer_gasbase == 5000</code>, an offer with <code>gasreq == 30000</code> must promise at least <em>10 × (30000 + 5000) = 350000</em> <code>outbound_tkn</code>. <em>9 bits wide</em>.</li>
</ul>
<p>We store the density as a float with 2 bits for the mantissa, 7 for the exponent, and an exponent bias of 32, so that density ranges from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mrow><mo>−</mo><mn>32</mn></mrow></msup></mrow><annotation encoding="application/x-tex">2^{-32}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.75</mn><mo>×</mo><msup><mn>2</mn><mn>95</mn></msup></mrow><annotation encoding="application/x-tex">1.75 \times 2^{95}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mord">.</span><span class="mord">7</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">9</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span>. For more information, see <code>DensityLib</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>284</pre></code>
          <pre>      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"density"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"Density"</span><span class="token punctuation">,</span> underlyingType<span class="token operator">:</span> <span class="token string">"uint"</span><span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>To save gas, Mangrove caches the entire tick tree branch of the bin that contains the best offer in each offer list’s <code>local</code> parameter. Taken together, <code>binPosInLeaf</code>, <code>level3</code>, <code>level2</code>, <code>level1</code>, and <code>root</code> provide the following info:</p>
<ul>
<li>What the current bin is (see <code>BinLib.bestBinFromLocal</code>)</li>
<li>When a leaf is emptied and the next offer must be fetched, the information in the fields <code>level3</code>, <code>level2</code>, <code>level1</code> and <code>root</code> avoid multiple storage reads</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>289
290
291
292
293</pre></code>
          <pre>      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"binPosInLeaf"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"level3"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"Field"</span><span class="token punctuation">,</span> underlyingType<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"level2"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"Field"</span><span class="token punctuation">,</span> underlyingType<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"level1"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"Field"</span><span class="token punctuation">,</span> underlyingType<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"Field"</span><span class="token punctuation">,</span> underlyingType<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>offer_gasbase</code> represents the gas overhead used by processing the offer inside Mangrove + the overhead of initiating an entire order. Mangrove considers that a failed offer has used at least <code>offer_gasbase</code> gas. The actual field name is <code>kilo_offer_gasbase</code> and the accessor <code>offer_gasbase</code> returns <code>kilo_offer_gasbase*1e3</code>. Local to an offer list, because the costs of calling <code>outbound_tkn</code> and <code>inbound_tkn</code>’s <code>transferFrom</code> are part of <code>offer_gasbase</code>. Should only be updated when ERC20 contracts change or when opcode prices change.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>295</pre></code>
          <pre>      fields<span class="token punctuation">.</span>kilo_offer_gasbase<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>If <code>lock</code> is true, orders may not be added nor executed, nor the offer list read by external contracts.</li>
</ul>
<p>Reentrancy during offer execution is not considered safe:</p>
<ul>
<li>during execution, an offer could consume other offers further up in the list, effectively front-running the taker currently executing the offer.</li>
<li>it could also cancel other offers, creating a discrepancy between the advertised and actual market price at no cost to the maker.</li>
<li>a maker could potentially distinguish between a clean and a market order based on the current state of the offer list</li>
</ul>
<p>Note: An optimization in the <code>marketOrder</code> function relies on reentrancy being forbidden.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>305</pre></code>
          <pre>      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"lock"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"bool"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>last</code> is a counter for offer ids, incremented every time a new offer is created. It can’t go above <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{32}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>307
308</pre></code>
          <pre>      <span class="token function">id_field</span><span class="token punctuation">(</span><span class="token string">"last"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Import additional libraries for <code>Local</code> and <code>LocalExtra</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>310
311</pre></code>
          <pre>    <span class="token function-variable function">additionalDefinitions</span><span class="token operator">:</span> <span class="token punctuation">(</span>struct<span class="token punctuation">)</span> <span class="token operator">=></span> `<span class="token keyword">import</span> <span class="token punctuation">{</span>Density<span class="token punctuation">,</span> DensityLib<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/DensityLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Bin<span class="token punctuation">,</span>TickTreeLib<span class="token punctuation">,</span>Field<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/TickTreeLib.sol"</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Globally enable global.method(…)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>313
314
315
316
317
318
319
320</pre></code>
          <pre><span class="token keyword">import</span> <span class="token punctuation">{</span>LocalExtra<span class="token punctuation">,</span>LocalUnpackedExtra<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/LocalExtra.sol"</span><span class="token punctuation">;</span>
using LocalExtra <span class="token keyword">for</span> Local global<span class="token punctuation">;</span>
using LocalUnpackedExtra <span class="token keyword">for</span> LocalUnpacked global<span class="token punctuation">;</span>
`<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> struct_defs<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="constants.sol" class="left filebreak">Constants.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.17</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The constants below are written as literals to optimize gas. For all the relevant constants here, the non-literal expression that computes them is checked in <code>Constants.t.sol</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>5
6
7
8
9
10</pre></code>
          <pre>
<span class="token builtin">uint</span> <span class="token keyword">constant</span> ONE <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token builtin">uint</span> <span class="token keyword">constant</span> ONES <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span><span class="token punctuation">.</span>max<span class="token punctuation">;</span>
<span class="token builtin">uint</span> <span class="token keyword">constant</span> TOPBIT <span class="token operator">=</span> <span class="token number">0x8000000000000000000000000000000000000000000000000000000000000000</span><span class="token punctuation">;</span>
<span class="token builtin">uint</span> <span class="token keyword">constant</span> NOT_TOPBIT <span class="token operator">=</span> <span class="token number">0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><strong>sizes must match field sizes in <code>structs.ts</code> where relevant</strong></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Number of bits used to represent a tick</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>14</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> TICK_BITS <span class="token operator">=</span> <span class="token number">21</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Number of bits used to represent an offer id</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>16</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> OFFER_BITS <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Maximum possible size of a field – protects against wrong code changes. Constraint given by <code>BitLib.ctz64</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>18
19</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> MAX_FIELD_SIZE <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>X_SIZE_BITS</code> is 1+log2 of the size of <code>X</code>, where size is the number of elements it holds.In a field, an element is a bit; in a leaf, an element is a pair of offer ids. For <code>LEVEL</code>s and <code>ROOT</code>, the value must be exact, so only power-of-2 sizes are allowed.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>21
22
23
24</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> LEAF_SIZE_BITS <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> 
<span class="token builtin">uint</span> <span class="token keyword">constant</span> LEVEL_SIZE_BITS <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token builtin">uint</span> <span class="token keyword">constant</span> ROOT_SIZE_BITS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>X_SIZE</code> is <code>2**X_SIZE_BITS</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>26
27
28
29</pre></code>
          <pre><span class="token builtin">int</span> <span class="token keyword">constant</span> LEAF_SIZE <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token builtin">int</span> <span class="token keyword">constant</span> LEVEL_SIZE <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">;</span>
<span class="token builtin">int</span> <span class="token keyword">constant</span> ROOT_SIZE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>X_SIZE_MASK</code> is <code>0...01...1</code> where the number of 1s is <code>X_SIZE_BITS</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>31
32
33</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> LEAF_SIZE_MASK <span class="token operator">=</span> <span class="token number">0x3</span><span class="token punctuation">;</span>
<span class="token builtin">uint</span> <span class="token keyword">constant</span> LEVEL_SIZE_MASK <span class="token operator">=</span> <span class="token number">0x3f</span><span class="token punctuation">;</span>
<span class="token builtin">uint</span> <span class="token keyword">constant</span> ROOT_SIZE_MASK <span class="token operator">=</span> <span class="token number">0x1</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>0...01...1</code> with <code>OFFER_BITS</code> 1s at the end</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>35
36</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> OFFER_MASK <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Same as <code>ROOT_SIZE</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>38</pre></code>
          <pre><span class="token builtin">int</span> <span class="token keyword">constant</span> NUM_LEVEL1 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Same as <code>NUM_LEVEL1 * LEVEL_SIZE</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>40</pre></code>
          <pre><span class="token builtin">int</span> <span class="token keyword">constant</span> NUM_LEVEL2 <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Same as <code>NUM_LEVEL2 * LEVEL_SIZE</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>42</pre></code>
          <pre><span class="token builtin">int</span> <span class="token keyword">constant</span> NUM_LEVEL3 <span class="token operator">=</span> <span class="token number">8192</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Same as <code>NUM_LEVEL3 * LEVEL_SIZE</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>44</pre></code>
          <pre><span class="token builtin">int</span> <span class="token keyword">constant</span> NUM_LEAFS <span class="token operator">=</span> <span class="token number">524288</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Same as <code>NUM_LEAFS * LEAF</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>46</pre></code>
          <pre><span class="token builtin">int</span> <span class="token keyword">constant</span> NUM_BINS <span class="token operator">=</span> <span class="token number">2097152</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>min and max bins are defined like min and max int.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>48
49
50</pre></code>
          <pre><span class="token builtin">int</span> <span class="token keyword">constant</span> MIN_BIN <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1048576</span><span class="token punctuation">;</span>
<span class="token builtin">int</span> <span class="token keyword">constant</span> MAX_BIN <span class="token operator">=</span> <span class="token number">1048575</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The tick range is the largest such that the mantissa of <code>1.0001^MAX_TICK</code> fits on 128 bits (and thus can be multiplied by volumes).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>52
53</pre></code>
          <pre><span class="token builtin">int</span> <span class="token keyword">constant</span> MIN_TICK <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">887272</span><span class="token punctuation">;</span>
<span class="token builtin">int</span> <span class="token keyword">constant</span> MAX_TICK <span class="token operator">=</span> <span class="token number">887272</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>These are reference values for what the function <code>tickFromRatio</code> function will return, not the most possible accurate values for the min and max tick.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>55
56
57
58</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> MIN_RATIO_MANTISSA <span class="token operator">=</span> <span class="token number">170153974464283981435225617938057077692</span><span class="token punctuation">;</span>
<span class="token builtin">int</span> <span class="token keyword">constant</span> MIN_RATIO_EXP <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>
<span class="token builtin">uint</span> <span class="token keyword">constant</span> MAX_RATIO_MANTISSA <span class="token operator">=</span> <span class="token number">340256786836388094050805785052946541084</span><span class="token punctuation">;</span>
<span class="token builtin">int</span> <span class="token keyword">constant</span> MAX_RATIO_EXP <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MANTISSA_BITS</code> is the number of bits used in the mantissa of normalized floats that represent ratios. 128 means we can multiply all allowed volumes by the mantissa and not overflow.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>60
61</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> MANTISSA_BITS <span class="token operator">=</span> <span class="token number">128</span><span class="token punctuation">;</span>
<span class="token builtin">uint</span> <span class="token keyword">constant</span> MANTISSA_BITS_MINUS_ONE <span class="token operator">=</span> <span class="token number">127</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>With <code>|tick|&lt;=887272</code> and normalized mantissas on 128 bits, the maximum possible mantissa is <code>340282295208261841796968287475569060645</code>, so the maximum safe volume before overflow is <code>NO_OVERFLOW_AMOUNT = 340282438633630198193436196978374475856</code> (slightly above <code>2**128</code>).</p>
<p>For ease of use, we could pick a simpler, slightly smaller max safe volume: <code>(1&lt;&lt;128)-1</code>.</p>
<p>However the <code>*ByVolume</code> functions get a price by (abstractly) performing <code>outboundAmount/inboundAmount</code>. If we limit all volumes to <code>NO_OVERFLOW_AMOUNT</code> but aren’t more restrictive than that, since <code>type(uint128).max &gt; 1.0001**MAX_TICK</code>, we will get ratios that are outside the price boundaries.</p>
<p>We thus pick a uniform, easy to remember constraint on volumes that works everywhere: <code>(1&lt;&lt;127)-1</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>71
72</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> MAX_SAFE_VOLUME <span class="token operator">=</span> <span class="token number">170141183460469231731687303715884105727</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>When a market order consumes offers, the implementation uses recursion consumes additional EVM stack space at each new offer. To avoid reverting due to stack overflow, Mangrove keeps a counter and stops the market order when it reaches a maximum recursion depth. <code>INITIAL_MAX_RECURSION_DEPTH</code> is the maximum recursion depth given at deployment time.</p>
<p>See <code>maxRecursionDepth</code> in <code>structs.ts</code></p>
<p>Without optimizer enabled it fails above 79. With optimizer and 200 runs it fails above 80. Set default a bit lower to be safe.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>78
79</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> INITIAL_MAX_RECURSION_DEPTH <span class="token operator">=</span> <span class="token number">75</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>When a market order consumes offers, it may use gas on offers that fail to deliver. To avoid reverts after a string of failing offers that consumes more gas than is available in a block, Mangrove stops a market order after it has gone through failing offers such that their cumulative <code>gasreq</code> is greater than the global <code>maxGasreqForFailingOffers</code> parameter. At deployment, <code>maxGasreqForFailingOffers</code> is set to:</p>
<pre><code>INITIAL_MAX_GASREQ_FOR_FAILING_OFFERS_MULTIPLIER * gasmax
</code></pre>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>84
85</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> INITIAL_MAX_GASREQ_FOR_FAILING_OFFERS_MULTIPLIER <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Those two constants are used in <code>TickLib.ratioFromTick</code> to convert a log base 1.0001 to a log base 2.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>87
88</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> LOG_BP_SHIFT <span class="token operator">=</span> <span class="token number">235</span><span class="token punctuation">;</span>
<span class="token builtin">uint</span> <span class="token keyword">constant</span> LOG_BP_2X235 <span class="token operator">=</span> <span class="token number">382733217082594961806491056566382061424140926068392360945012727618364717537</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvlib.sol" class="left filebreak">MgvLib.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MgvLib</code> contains data structures returned by external calls to Mangrove and the interfaces it uses for its own external calls.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>4
5
6
7
8
9
10
11
12</pre></code>
          <pre>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.10</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@mgv/src/preprocessed/Structs.post.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>IERC20<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/IERC20.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Density<span class="token punctuation">,</span> DensityLib<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/DensityLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"@mgv/lib/core/TickTreeLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"@mgv/lib/core/TickLib.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>OLKey</code> (for “OfferListKey”) contains the information that characterizes an offer list:</p>
<ul>
<li><code>outbound_tkn</code>, token that goes from the maker to the taker (to remember the direction, imagine the token as going out of the Mangrove offer, towards the taker)</li>
<li><code>inbound_tkn</code>, token that goes from the taker to the maker (to remember the direction, imagine the token as going into Mangrove from the taker)</li>
<li><code>tickSpacing</code>, how many ticks should be jumped between available price points. More volatile outbound/inbound pairs should have a larger <code>tickSpacing</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>17
18
19
20
21
22</pre></code>
          <pre><span class="token keyword">struct</span> <span class="token class-name">OLKey</span> <span class="token punctuation">{</span>
  <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">;</span>
  <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">;</span>
  <span class="token builtin">uint</span> tickSpacing<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Globally enable <code>olKey.method(...)</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>24
25
26</pre></code>
          <pre><span class="token keyword">using</span> <span class="token class-name">OLLib</span> <span class="token keyword">for</span> OLKey global<span class="token punctuation">;</span>

<span class="token keyword">library</span> <span class="token class-name">OLLib</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The id of an <code>OLKey</code> should be <code>keccak256(abi.encode(olKey))</code>
To save gas, <code>id()</code> directly hashes the memory (which matches the ABI encoding; there is a fuzz test on that). If the memory layout changes, this function must be updated.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>29
30
31
32
33
34</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">hash</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes32</span> _id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _id <span class="token operator">:=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>olKey<span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Creates a flipped copy of the <code>olKey</code> with same <code>tickSpacing</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>36
37
38
39</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">flipped</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">OLKey</span><span class="token punctuation">(</span>olKey<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span> olKey<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span> olKey<span class="token punctuation">.</span>tickSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Convert <code>tick</code> to bin according to <code>olKey.tickSpacing</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>41
42
43
44</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">nearestBin</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> Tick _tick<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Bin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _tick<span class="token punctuation">.</span><span class="token function">nearestBin</span><span class="token punctuation">(</span>olKey<span class="token punctuation">.</span>tickSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Convert <code>bin</code> to <code>tick</code> according to <code>olKey.tickSpacing</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>46
47
48
49
50</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">tick</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Tick<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> bin<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span>olKey<span class="token punctuation">.</span>tickSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvlib.sol-structs-0">Structs</h1>
<p>The structs defined in <code>structs.js</code> have their counterpart as solidity structs that are easy to manipulate for outside contracts / callers of view functions.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>53
54</pre></code>
          <pre>
<span class="token keyword">library</span> <span class="token class-name">MgvLib</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Some miscellaneous data types useful to <code>Mangrove</code> and external contracts</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>SingleOrder</code> holds data about an order-offer match in a struct. Used by <code>marketOrder</code> (and some of its nested functions) to avoid stack too deep errors. It is used in market order and cleaning.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>60
61
62</pre></code>
          <pre>  <span class="token keyword">struct</span> <span class="token class-name">SingleOrder</span> <span class="token punctuation">{</span>
    OLKey olKey<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> offerId<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>offer</code> given to the maker will be cleaned of <code>prev</code>/<code>next</code> pointers.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>64</pre></code>
          <pre>    Offer offer<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>takerWants</code>/<code>takerGives</code> mutate over execution. Initially the <code>wants</code>/<code>gives</code> from the taker’s pov, then actual <code>wants</code>/<code>gives</code> adjusted by offer’s price and volume.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>66
67</pre></code>
          <pre>    <span class="token builtin">uint</span> takerWants<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> takerGives<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>offerDetail</code> is only populated when necessary.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>69
70</pre></code>
          <pre>    OfferDetail offerDetail<span class="token punctuation">;</span>
    Global global<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>local</code> given to the maker will be cleaned of tick tree information.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>72
73
74</pre></code>
          <pre>    Local local<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="MgvLib/OrderResult"></a> <code>OrderResult</code> holds additional data for the maker and is given to them <em>after</em> they fulfilled an offer. It gives them their own returned data from the previous call, and an <code>mgvData</code> specifying whether Mangrove encountered an error.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>76
77</pre></code>
          <pre>
  <span class="token keyword">struct</span> <span class="token class-name">OrderResult</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>makerData</code> holds a message that was either returned by the maker or passed as revert message at the end of the trade execution</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>79</pre></code>
          <pre>    <span class="token builtin">bytes32</span> makerData<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>mgvData</code> is an <a href="#MgvOfferTaking/statusCodes">internal Mangrove status code</a> code.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>81
82
83</pre></code>
          <pre>    <span class="token builtin">bytes32</span> mgvData<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>CleanTarget</code> holds data about an offer that should be cleaned, i.e. made to fail by executing it with the specified volume. It is used in <code>MgvOfferTaking.cleanByImpersonation</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>85
86
87
88
89
90
91
92</pre></code>
          <pre>  <span class="token keyword">struct</span> <span class="token class-name">CleanTarget</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> offerId<span class="token punctuation">;</span>
    Tick tick<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gasreq<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> takerWants<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvlib.sol-events">Events</h1>
<p>The events emitted are listed here:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>95</pre></code>
          <pre><span class="token keyword">interface</span> <span class="token class-name">HasMgvEvents</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Events in solidity is a hard thing to do in a optimal way. If you look at it as a purely gas efficient issue, you want to emit as few events as possible and with as few fields as possible. But as events also has to be usable for an off chain user, then doing this is not always the best solution.</p>
<p>We tried to list the main forces that drive which events and data to emit:</p>
<ol>
<li>Use as little gas as possible.</li>
<li>An indexer should be able to keep track of the state of Mangrove.</li>
<li>Doing RPC calls directly, should be able to find offers and other information based on offer list, maker, taker, offer id, etc.</li>
</ol>
<p>These forces are in conflict and it is impossible to find a solution that is optimal for all three.
The following events are therefore an attempt to balance the trade-offs.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Mangrove Creation</h3>
<p>Emitted at the creation of the new Mangrove contract</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>112
113</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">NewMgv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Mangrove adds or removes wei from <code>maker</code>’s account</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Credit event occurs when an offer is removed from Mangrove or when the <code>fund</code> function is called
This is emitted when a user’s account on Mangrove is credited with some native funds, to be used as provision for offers.</li>
</ul>
<p>It emits the <code>maker</code>’s address and the <code>amount</code> credited</p>
<p>The <code>maker</code> address is indexed so that we can filter on it when doing RPC calls.</p>
<p>These are the scenarios where it can happen:</p>
<ul>
<li>Fund Mangrove directly</li>
<li>Fund Mangrove when posting an offer</li>
<li>When updating an offer
<ul>
<li>Funding Mangrove or</li>
<li>the updated offer needs less provision, than it already has. Meaning the user gets credited the difference.</li>
</ul>
</li>
<li>When retracting an offer and deprovisioning it. Meaning the user gets credited the provision that was locked by the offer.</li>
<li>When an offer fails. The remaining provision gets credited back to the maker</li>
</ul>
<p>A challenge for an indexer is to know how much provision each offer locks. With the current events, an indexer is going to have to know the liveness, gasreq and gasprice of the offer. If the offer is not live, then also know if it has been deprovisioned. And know what the gasbase of the offer list was when the offer was posted. With this information an indexer can calculate the exact provision locked by the offer.</p>
<p>The indexer also cannot deduce what scenario the credit event happened. E.g., we don’t know if the credit event happened because an offer failed or because the user simply funded Mangrove.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>137</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">Credit</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> maker<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Debit event occurs when an offer is posted or when the <code>withdraw</code> function is called
This is emitted when a user’s account on Mangrove is debited with some native funds.</li>
</ul>
<p>It emits the <code>maker</code>’s address and the <code>amount</code> debited.</p>
<p>The <code>maker</code> address is indexed so that we can filter on it when doing RPC calls.</p>
<p>These are the scenarios where it can happen:</p>
<ul>
<li>Withdraw funds from Mangrove directly</li>
<li>When posting an offer. The user gets debited the provision that the offer locks.</li>
<li>When updating an offer and it requires more provision that it already has. Meaning the user gets debited the difference.</li>
</ul>
<p>Same challenges as for Credit</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>154
155</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">Debit</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token keyword">indexed</span> maker<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Mangrove reconfiguration</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when an offer list is activated or deactivated. Meaning one half of a market is opened.</p>
<p>It emits the <code>olKeyHash</code> and the boolean <code>value</code>. By emitting this, an indexer will be able to keep track of what offer lists are active and what their hash is.</p>
<p>The <code>olKeyHash</code> and both token addresses are indexed, so that we can filter on it when doing RPC calls.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>164
165
166
167</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">SetActive</span><span class="token punctuation">(</span>
    <span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> olKeyHash<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">indexed</span> outbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">indexed</span> inbound_tkn<span class="token punctuation">,</span> <span class="token builtin">uint</span> tickSpacing<span class="token punctuation">,</span> <span class="token builtin">bool</span> value
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when the fee of an offer list is changed.</p>
<p>It emits the <code>olKeyHash</code> and the <code>value</code>. By emitting this, an indexer will be able to keep track of what fee each offer list has.</p>
<p>The <code>olKeyHash</code> is indexed, so that we can filter on it when doing RPC calls.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>175
176
177</pre></code>
          <pre>
  <span class="token keyword">event</span> <span class="token function">SetFee</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> olKeyHash<span class="token punctuation">,</span> <span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when the gasbase of an offer list is changed.</p>
<p>It emits the <code>olKeyHash</code> and the <code>offer_gasbase</code>. By emitting this, an indexer will be able to keep track of what gasbase each offer list has.</p>
<p>The <code>olKeyHash</code> is indexed, so that we can filter on it when doing RPC calls.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>185
186</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">SetGasbase</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> olKeyHash<span class="token punctuation">,</span> <span class="token builtin">uint</span> offer_gasbase<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when the governance of Mangrove is set.</p>
<p>It emits the <code>governance</code> address. By emitting this, an indexer will be able to keep track of what governance address Mangrove has.</p>
<p>No fields are indexed as there is no need for RPC calls to filter on this.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>194
195</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">SetGovernance</span><span class="token punctuation">(</span><span class="token builtin">address</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when the monitor address of Mangrove is set. Be aware that the address for Monitor is also the address for the oracle.</p>
<p>It emits the <code>monitor</code> / <code>oracle</code> address. By emitting this, an indexer will be able to keep track of what monitor/oracle address Mangrove use.</p>
<p>No fields are indexed as there is no need for RPC calls to filter on this.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>203
204</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">SetMonitor</span><span class="token punctuation">(</span><span class="token builtin">address</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when the configuration for whether to use an oracle or not is set.</p>
<p>It emits the <code>useOracle</code>, which is a boolean value, that controls whether or not Mangrove reads its <code>gasprice</code> and <code>density</code> from an oracle or uses its own local values. By emitting this, an indexer will be able to keep track of if Mangrove is using an oracle.</p>
<p>No fields are indexed as there is no need for RPC calls to filter on this.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>212
213</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">SetUseOracle</span><span class="token punctuation">(</span><span class="token builtin">bool</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when the configuration for notify on Mangrove is set.</p>
<p>It emits a boolean value, to tell whether or not notify is active. By emitting this, an indexer will be able to keep track of whether or not Mangrove notifies the Monitor/Oracle when and offer is taken, either successfully or not.</p>
<p>No fields are indexed as there is no need for RPC calls to filter on this.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>221
222</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">SetNotify</span><span class="token punctuation">(</span><span class="token builtin">bool</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when the gasmax of Mangrove is set.</p>
<p>It emits the <code>gasmax</code>. By emitting this, an indexer will be able to keep track of what gasmax Mangrove has. Read more about Mangroves gasmax on <a href="https://docs.mangrove.exchange">docs.mangrove.exchange</a></p>
<p>No fields are indexed as there is no need for RPC calls to filter on this.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>230
231</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">SetGasmax</span><span class="token punctuation">(</span><span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when the density of an offer list is changed.</p>
<p>It emits the <code>olKeyHash</code> and the <code>density</code>. By emitting this, an indexer will be able to keep track of what density each offer list has.</p>
<p>The <code>olKeyHash</code> is indexed, so that we can filter on it when doing RPC calls.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>239
240</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">SetDensity96X32</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> olKeyHash<span class="token punctuation">,</span> <span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when the max recursion depth of Mangrove is set.</p>
<p>It emits the max depth <code>value</code>. By emitting this, an indexer will be able to keep track of what max recursion depth Mangrove has. Read more about Mangroves max recursion depth on <a href="https://docs.mangrove.exchange">docs.mangrove.exchange</a></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>246
247
248</pre></code>
          <pre>
  <span class="token keyword">event</span> <span class="token function">SetMaxRecursionDepth</span><span class="token punctuation">(</span><span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when the max gasreq for failing offers of Mangrove is set.</p>
<p>It emits the max gasreq for failing offers <code>value</code>. By emitting this, an indexer will be able to keep track of what max gasreq for failing offers Mangrove has. Read more about Mangroves max gasreq for failing offers on <a href="https://docs.mangrove.exchange">docs.mangrove.exchange</a></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>254
255</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">SetMaxGasreqForFailingOffers</span><span class="token punctuation">(</span><span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when the gasprice of Mangrove is set.</p>
<p>It emits the <code>gasprice</code>. By emitting this, an indexer will be able to keep track of what gasprice Mangrove has. Read more about Mangroves gasprice on <a href="https://docs.mangrove.exchange">docs.mangrove.exchange</a></p>
<p>No fields are indexed as there is no need for RPC calls to filter on this.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>263</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">SetGasprice</span><span class="token punctuation">(</span><span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Clean order execution</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when a user tries to clean offers on Mangrove, using the build in clean functionality.</p>
<p>It emits the <code>olKeyHash</code>, the <code>taker</code> address and <code>offersToBeCleaned</code>, which is the number of offers that should be cleaned. By emitting this event, an indexer can save what <code>offer list</code> the user is trying to clean and what <code>taker</code> is being used.
This way it can keep a context for the following events being emitted (Just like <code>OrderStart</code>). The <code>offersToBeCleaned</code> is emitted so that an indexer can keep track of how many offers the user tried to clean.
Combining this with the amount of <code>OfferFail</code> events emitted, then an indexer can know how many offers the user actually managed to clean. This could be used for analytics.</p>
<p>The fields <code>olKeyHash</code> and <code>taker</code> are indexed, so that we can filter on them when doing RPC calls.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>274
275</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">CleanStart</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> olKeyHash<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">indexed</span> taker<span class="token punctuation">,</span> <span class="token builtin">uint</span> offersToBeCleaned<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when a Clean operation is completed.</p>
<p>It does not emit any fields. This event is only needed in order to know that the clean operation is completed. This way an indexer can know exactly in what context we are in.
It could emit the total bounty received, but in order to know who got the bounty, an indexer would still be needed or we would have to emit the taker address as well, in order for an RPC call to find the data.
But an indexer would still be able to find this info, by collecting all the previous events. So we do not emit the bounty.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>283
284</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">CleanComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Market order execution</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when a market order is started on Mangrove.</p>
<p>It emits the <code>olKeyHash</code>, the <code>taker</code>, the <code>maxTick</code>, <code>fillVolume</code> and <code>fillWants</code>.</p>
<p>The fields <code>olKeyHash</code> and <code>taker</code> are indexed, so that we can filter on them when doing RPC calls.</p>
<p>By emitting this an indexer can keep track of what context the current market order is in.
E.g. if a user starts a market order and one of the offers taken also starts a market order, then we can in an indexer have a stack of started market orders and thereby know exactly what offer list the order is running on and the taker.</p>
<p>By emitting <code>maxTick</code>, <code>fillVolume</code> and <code>fillWants</code>, we can now also know how much of the market order was filled and if it matches the price given. See OrderComplete for more.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>298
299</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">OrderStart</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> olKeyHash<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">indexed</span> taker<span class="token punctuation">,</span> Tick maxTick<span class="token punctuation">,</span> <span class="token builtin">uint</span> fillVolume<span class="token punctuation">,</span> <span class="token builtin">bool</span> fillWants<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when a market order is finished.</p>
<p>It emits <code>olKeyHash</code>, the <code>taker</code> and the total <code>fee paid</code>. We need this event, in order to know that a market order is completed. This way an indexer can know exactly in what context we are in.
The total <code>fee paid</code> for that market order, is needed, as we do not emit this any other places. The fields <code>olKeyHash</code> and <code>taker</code> is not needed for an indexer, but they are emitted and indexed in order for RPC calls to filter and find the fee.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>306
307</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">OrderComplete</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> olKeyHash<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">indexed</span> taker<span class="token punctuation">,</span> <span class="token builtin">uint</span> fee<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Offer execution</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when an offer is successfully taken. Meaning both maker and taker has gotten their funds.</p>
<p>It emits the <code>olKeyHash</code>, <code>taker</code> address, the <code>offerId</code> and the <code>takerWants</code> and <code>takerGives</code> that the offer was taken at.
Just as for <code>OfferFail</code>, the <code>olKeyHash</code> and <code>taker</code> are not needed for an indexer to work, but are needed for RPC calls.
<code>olKeyHash</code> <code>taker</code> and <code>id</code> are indexed so that we can filter on them when doing RPC calls. As <code>maker</code> can be a strategy and not the actual owner, then we chose not to emit it here and to mark the field <code>id</code> indexed,
the strat should emit the relation between maker and offerId. This way you can still by RPC calls find the relevant offer successes
So they are emitted and indexed for that reason. Just like <code>OfferFail</code> this event is emitted during posthook end, so it is emitted in reverse order compared to what order they are taken.
This event could be emitted at offer execution, but for consistency we emit it at posthook end.</p>
<p>If the posthook of the offer fails. Then we emit <code>OfferSuccessWithPosthookData</code> instead of just <code>OfferSuccess</code>. This event has one extra field, which is the reason for the posthook failure.
By emitting the posthook data, an indexer can keep track of the reason posthook fails, this could for example be used for analytics.</p>
<p>By emitting <code>offerId</code>, <code>wants</code> and <code>gives</code>, an indexer can keep track of whether the offer was partially or fully taken, by looking at the what the offer was posted at.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>324
325
326
327
328
329
330
331
332
333
334
335
336</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">OfferSuccess</span><span class="token punctuation">(</span>
    <span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> olKeyHash<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">indexed</span> taker<span class="token punctuation">,</span> <span class="token builtin">uint</span> <span class="token keyword">indexed</span> id<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerGives
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">event</span> <span class="token function">OfferSuccessWithPosthookData</span><span class="token punctuation">(</span>
    <span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> olKeyHash<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> taker<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> <span class="token keyword">indexed</span> id<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> posthookData
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when an offer fails, because of a maker error.</p>
<p>It emits <code>olKeyHash</code>, <code>taker</code>, the <code>offerId</code>, the offers <code>takerWants</code>, <code>takerGives</code>, <code>penalty</code> and the <code>reason</code> for failure.
<code>olKeyHash</code> and <code>taker</code> are all fields that we do not need, in order for an indexer to work, as an indexer will be able the get that info from the former <code>OrderStart</code> and <code>OfferWrite</code> events.
But in order for RPC call to filter on this, we need to emit them.
<code>olKeyHash</code> <code>taker</code> and <code>id</code> are indexed so that we can filter on them when doing RPC calls. As <code>maker</code> can be a strategy and not the actual owner, then we chose to not emit it here and to mark the field <code>id</code> indexed,
the strat should emit the relation between maker and offerId. This way you can still by RPC calls find the relevant offer successes</p>
<p>If the posthook of the offer fails. Then we emit <code>OfferFailWithPosthookData</code> instead of just <code>OfferFail</code>.
This event has one extra field, which is the reason for the posthook failure. By emitting the posthook data, an indexer can keep track of the reason posthook fails, this could for example be used for analytics.</p>
<p>This event is emitted during posthook end, we wait to emit this event to the end, because we need the information of <code>penalty</code>, which is only available at the end of the posthook.
This means that <code>OfferFail</code> events are emitted in reverse order, compared to what order they are taken. This is due to the way we handle posthooks. The same goes for <code>OfferSuccess</code>.</p>
<p>By emitting this event, an indexer can keep track of, if an offer failed and thereby if the offer is live.
By emitting the <code>takerWants</code> and <code>takerGives</code> that the offer was taken with, then an indexer can keep track of these amounts, which could be useful for e.g. strategy manager, to know if their offers fail at a certain amount.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>355
356
357
358
359
360
361</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">OfferFail</span><span class="token punctuation">(</span>
    <span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> olKeyHash<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> taker<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> <span class="token keyword">indexed</span> id<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> penalty<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><code>mgvData</code> may only be <code>&quot;mgv/makerRevert&quot;</code>, <code>&quot;mgv/makerTransferFail&quot;</code> or <code>&quot;mgv/makerReceiveFail&quot;</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>363
364
365
366
367
368
369
370
371
372</pre></code>
          <pre>    <span class="token builtin">bytes32</span> mgvData
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">event</span> <span class="token function">OfferFailWithPosthookData</span><span class="token punctuation">(</span>
    <span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> olKeyHash<span class="token punctuation">,</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> taker<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> <span class="token keyword">indexed</span> id<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> penalty<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><code>mgvData</code> may only be <code>&quot;mgv/makerRevert&quot;</code>, <code>&quot;mgv/makerTransferFail&quot;</code> or <code>&quot;mgv/makerReceiveFail&quot;</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>374
375
376
377</pre></code>
          <pre>    <span class="token builtin">bytes32</span> mgvData<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> posthookData
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>After <code>permit</code> and <code>approve</code></h3>
<p>This is emitted when a user permits another address to use a certain amount of its funds to do market orders, or when a user revokes another address to use a certain amount of its funds.</p>
<p>Approvals are based on the pair of outbound and inbound token. Be aware that it is not offer list bases, as an offer list also holds the tick spacing.</p>
<p>We emit <code>outbound</code> token, <code>inbound</code> token, <code>owner</code>, msg.sender (<code>spender</code>), <code>value</code>. Where <code>owner</code> is the one who owns the funds, <code>spender</code> is the one who is allowed to use the funds and <code>value</code> is the amount of funds that is allowed to be used.</p>
<p>Outbound, inbound and owner is indexed, this way one can filter on these fields when doing RPC calls. If we could somehow combine outbound and inbound into one field, then we could also index the spender.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>388
389
390
391</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">Approval</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> <span class="token keyword">indexed</span> outbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">indexed</span> inbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">indexed</span> owner<span class="token punctuation">,</span> <span class="token builtin">address</span> spender<span class="token punctuation">,</span> <span class="token builtin">uint</span> value
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Mangrove closure</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>393
394</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">Kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>An offer was created or updated.</h3>
<p>This event is emitted when an offer is posted on Mangrove.</p>
<p>It emits the <code>olKeyHash</code>, the <code>maker</code> address, the <code>tick</code>, the <code>gives</code>, the <code>gasprice</code>, <code>gasreq</code> and the offers <code>id</code>.</p>
<p>By emitting the <code>olKeyHash</code> and <code>id</code>, an indexer will be able to keep track of each offer, because offer list and id together create a unique id for the offer. By emitting the <code>maker</code> address, we are able to keep track of who has posted what offer. The <code>tick</code> and <code>gives</code>, enables an indexer to know exactly how much an offer is willing to give and at what price, this could for example be used to calculate a return. The <code>gasprice</code> and <code>gasreq</code>, enables an indexer to calculate how much provision is locked by the offer, see <code>Credit</code> for more information.</p>
<p>The fields <code>olKeyHash</code> and <code>maker</code> are indexed, so that we can filter on them when doing RPC calls.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>404
405
406
407</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">OfferWrite</span><span class="token punctuation">(</span>
    <span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> olKeyHash<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">indexed</span> maker<span class="token punctuation">,</span> <span class="token builtin">int</span> tick<span class="token punctuation">,</span> <span class="token builtin">uint</span> gives<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span> <span class="token builtin">uint</span> id
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This event is emitted when a user retracts his offer.</p>
<p>It emits the <code>olKeyHash</code>, the <code>maker</code> address, <code>offerId</code> and whether or not the user chose to <code>deprovision</code> the offer.</p>
<p>By emitting this event an indexer knows whether or not an offer is live. And whether or not an offer is deprovisioned. This is important because we need to know this, when we try to calculate how much an offer locks in provision. See the description of <code>Credit</code> for more info.</p>
<p>The <code>maker</code> is not needed for an indexer to work, but is needed for RPC calls, so it is emitted and indexed for that reason. The <code>olKeyHash</code> is only indexed because it is needed for RPC calls.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>417
418
419</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">OfferRetract</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token keyword">indexed</span> olKeyHash<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">indexed</span> maker<span class="token punctuation">,</span> <span class="token builtin">uint</span> id<span class="token punctuation">,</span> <span class="token builtin">bool</span> deprovision<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvlib.sol-imaker-interface">IMaker interface</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>421</pre></code>
          <pre><span class="token keyword">interface</span> <span class="token class-name">IMaker</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Called upon offer execution.</p>
<ul>
<li>If the call throws, Mangrove will not try to transfer funds and the first 32 bytes of revert reason are passed to <code>makerPosthook</code> as <code>makerData</code></li>
<li>If the call returns normally, <code>returnData</code> is passed to <code>makerPosthook</code> as <code>makerData</code> and Mangrove will attempt to transfer the funds.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>426
427</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">makerExecute</span><span class="token punctuation">(</span>MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> order<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Called after all offers of an order have been executed. Posthook of the last executed order is called first and full reentrancy into Mangrove is enabled at this time. <code>order</code> recalls key arguments of the order that was processed and <code>result</code> recalls important information for updating the current offer. (see <a href="#MgvLib/OrderResult">above</a>)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>429
430
431</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">makerPosthook</span><span class="token punctuation">(</span>MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> order<span class="token punctuation">,</span> MgvLib<span class="token punctuation">.</span>OrderResult <span class="token keyword">calldata</span> result<span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvlib.sol-monitor-interface">Monitor interface</h1>
<p>If enabled, the monitor receives notification after each offer execution and is read for each offer list’s <code>gasprice</code> and <code>density</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>434
435
436
437
438
439
440</pre></code>
          <pre><span class="token keyword">interface</span> <span class="token class-name">IMgvMonitor</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">notifySuccess</span><span class="token punctuation">(</span>MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">notifyFail</span><span class="token punctuation">(</span>MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">read</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span> Density density<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvcommon.sol" class="left filebreak">MgvCommon.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MgvCommon</code> and its descendants describe an orderbook-based exchange (“Mangrove”) where market makers <em>do not have to provision their offer</em>. In a nutshell: each offer created by a maker specifies an address (<code>maker</code>) to call upon offer execution by a taker. When an offer is executed, Mangrove transfers the amount to be paid by the taker to the maker, calls the maker, attempts to transfer the amount promised by the maker to the taker, and reverts if it cannot.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>5
6
7
8
9</pre></code>
          <pre>
<span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.10</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@mgv/src/core/MgvLib.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MgvCommon</code> contains state variables used everywhere in the operation of Mangrove and related gatekeeping functions. The main <code>Mangrove</code> contract inherits from <code>MgvCommon</code>, and the auxiliary <code>MgvAppendix</code> contract inherits from <code>MgvCommon</code> as well. This way, when <code>Mangrove</code> delegatecalls to <code>MgvAppendix</code>, the storage slots match.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>11</pre></code>
          <pre><span class="token keyword">contract</span> <span class="token class-name">MgvCommon</span> <span class="token keyword">is</span> HasMgvEvents <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvcommon.sol-state-variables">State variables</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>governance</code> address. Governance is the only address that can configure parameters.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>16
17</pre></code>
          <pre>  <span class="token builtin">address</span> <span class="token keyword">public</span> governance<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Global mgv configuration, encoded in a 256 bits word. The information encoded is detailed in <a href="#structs.js"><code>structs.js</code></a>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>19
20</pre></code>
          <pre>  Global <span class="token keyword">internal</span> internal_global<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>OfferData</code> contains all the information related to an offer. Each field contains packed information such as the volumes and the gas required. See <a href="#structs.js"><code>structs.js</code></a> for more information.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>22
23
24
25
26</pre></code>
          <pre>  <span class="token keyword">struct</span> <span class="token class-name">OfferData</span> <span class="token punctuation">{</span>
    Offer offer<span class="token punctuation">;</span>
    OfferDetail detail<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>OfferList</code> contains all data specific to an offer list.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>28</pre></code>
          <pre>  <span class="token keyword">struct</span> <span class="token class-name">OfferList</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>local</code> is the Mangrove configuration specific to the <code>outbound,inbound,tickSpacing</code> offer list. It contains e.g. the minimum offer <code>density</code>. It contains packed information, see <a href="#structs.js"><code>structs.js</code></a> for more.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>30</pre></code>
          <pre>    Local local<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>level1s</code> maps a level1 index to a (dirty) field. Each field holds 64 bits marking the (non)empty state of 64 level2 fields.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>32</pre></code>
          <pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">int</span> <span class="token operator">=></span> DirtyField<span class="token punctuation">)</span> level1s<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>level2s</code> maps a level2 index to a (dirty) field. Each field holds 64 bits marking the (non)empty state of 64 level3 fields.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>34</pre></code>
          <pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">int</span> <span class="token operator">=></span> DirtyField<span class="token punctuation">)</span> level2s<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>level3s</code> maps a level3 index to a (dirty) field. Each field holds 64 bits marking the (non)empty state of 64 leaves.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>36</pre></code>
          <pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">int</span> <span class="token operator">=></span> DirtyField<span class="token punctuation">)</span> level3s<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>leafs</code> (intentionally not <code>leaves</code> for clarity) maps a leaf index to a leaf. Each leaf holds the first&amp;last offer id of 4 bins.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>38</pre></code>
          <pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">int</span> <span class="token operator">=></span> DirtyLeaf<span class="token punctuation">)</span> leafs<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>OfferData maps an offer id to a struct that holds the two storage words where the packed offer information resides. For more information see <code>Offer</code> and <code>OfferDetail</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>40
41
42</pre></code>
          <pre>    <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint</span> <span class="token operator">=></span> OfferData<span class="token punctuation">)</span> offerData<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>OLKeys (see <code>MgvLib.sol</code>) are hashed to a bytes32 OLKey identifier, which get mapped to an <code>OfferList</code> struct. Having a single mapping instead of one mapping per field in <code>OfferList</code> means we can pass around a storage reference to that struct.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>44</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token operator">=></span> OfferList<span class="token punctuation">)</span> <span class="token keyword">internal</span> offerLists<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>For convenience, and to enable future functions that access offer lists by directly supplying an OLKey identifier, Mangrove maintains an inverse <code>id -&gt; key</code> mapping.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>46
47</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> <span class="token operator">=></span> OLKey<span class="token punctuation">)</span> <span class="token keyword">internal</span> _olKeys<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Makers provision their possible penalties in the <code>balanceOf</code> mapping.</p>
<p>Offers specify the amount of gas they require for successful execution (<a href="#structs.js/gasreq"><code>gasreq</code></a>). To minimize book spamming, market makers must provision an amount of native tokens that depends on their <code>gasreq</code> and on the offer list’s <a href="#structs.js/gasbase"><code>offer_gasbase</code></a>. This provision is deducted from their <code>balanceOf</code>. If an offer fails, part of that provision is given to the taker as a <code>penalty</code>. The exact amount depends on the gas used by the offer before failing and during the execution of its posthook.</p>
<p>Mangrove keeps track of available balances in the <code>balanceOf</code> map, which is decremented every time a maker creates a new offer, and may be modified on offer updates/cancellations/takings.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>54
55</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> maker <span class="token operator">=></span> <span class="token builtin">uint</span> balance<span class="token punctuation">)</span> <span class="token keyword">internal</span> _balanceOf<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvcommon.sol-gatekeeping">Gatekeeping</h1>
<p>Gatekeeping functions are safety checks called in various places.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>unlockedOfferListOnly</code> protects modifying the offer list while an order is in progress. Since external contracts are called during orders, allowing reentrancy would, for instance, let a market maker replace offers currently on the book with worse ones. Note that the external contracts <em>will</em> be called again after the order is complete, this time without any lock on the offer list.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>63
64
65
66</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>Local local<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token operator">!</span>local<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/reentrancyLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="Mangrove/definition/liveMgvOnly"></a>
In case of emergency, Mangrove can be <code>kill</code>ed. It cannot be resurrected. When a Mangrove is dead, the following operations are disabled :</p>
<ul>
<li>Executing an offer</li>
<li>Sending ETH to Mangrove the normal way. Usual <a href="https://medium.com/@alexsherbuck/two-ways-to-force-ether-into-a-contract-1543c1311c56">shenanigans</a> are possible.</li>
<li>Creating a new offer</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>73
74
75
76</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">liveMgvOnly</span><span class="token punctuation">(</span>Global _global<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token operator">!</span>_global<span class="token punctuation">.</span><span class="token function">dead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/dead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>When Mangrove is deployed, all offer lists are inactive by default (since <code>locals[outbound_tkn][inbound_tkn]</code> is 0 by default). Offers on inactive offer lists cannot be taken or created. They can be updated and retracted.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>78
79
80
81
82</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">activeOfferListOnly</span><span class="token punctuation">(</span>Global _global<span class="token punctuation">,</span> Local _local<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span>
    <span class="token function">liveMgvOnly</span><span class="token punctuation">(</span>_global<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>_local<span class="token punctuation">.</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/inactive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>_config is the lower-level variant which opportunistically returns a pointer to the storage offer list induced by (<code>outbound_tkn,inbound_tkn,tickSpacing</code>).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>84
85
86
87
88
89
90
91
92
93
94</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">_config</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
    <span class="token keyword">view</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span>Global _global<span class="token punctuation">,</span> Local _local<span class="token punctuation">,</span> OfferList <span class="token keyword">storage</span> offerList<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      _global <span class="token operator">=</span> internal_global<span class="token punctuation">;</span>
      _local <span class="token operator">=</span> offerList<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_global<span class="token punctuation">.</span><span class="token function">useOracle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span> Density density<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">IMgvMonitor</span><span class="token punctuation">(</span>_global<span class="token punctuation">.</span><span class="token function">monitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>olKey<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Gas gasprice can be ignored by making sure the oracle’s set gasprice does not pass the check below.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>96
97
98</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>GlobalLib<span class="token punctuation">.</span><span class="token function">gasprice_check</span><span class="token punctuation">(</span>gasprice<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          _global <span class="token operator">=</span> _global<span class="token punctuation">.</span><span class="token function">gasprice</span><span class="token punctuation">(</span>gasprice<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Oracle density can be ignored by making sure the oracle’s set density does not pass the checks below.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Checking the size of <code>density</code> is necessary to prevent overflow when <code>density</code> is used in calculations.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>102
103
104
105
106
107
108</pre></code>
          <pre>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>LocalLib<span class="token punctuation">.</span><span class="token function">density_check</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          _local <span class="token operator">=</span> _local<span class="token punctuation">.</span><span class="token function">density</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvcommon.sol-token-transfer-functions">Token transfer functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>transferTokenFrom</code> is adapted from <a href="https://soliditydeveloper.com/safe-erc20">existing code</a> and in particular avoids the
“no return value” bug. It never throws and returns true iff the transfer was successful according to <code>tokenAddress</code>.</p>
<p>Note that any spurious exception due to an error in Mangrove code will be falsely blamed on <code>from</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">transferTokenFrom</span><span class="token punctuation">(</span><span class="token builtin">address</span> tokenAddress<span class="token punctuation">,</span> <span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span> <span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint</span> value<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">bytes</span> <span class="token keyword">memory</span> cd <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span>IERC20<span class="token punctuation">.</span>transferFrom<span class="token punctuation">.</span>selector<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span><span class="token builtin">bool</span> noRevert<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data<span class="token punctuation">)</span> <span class="token operator">=</span> tokenAddress<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>cd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>noRevert <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> abi<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">transferToken</span><span class="token punctuation">(</span><span class="token builtin">address</span> tokenAddress<span class="token punctuation">,</span> <span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">uint</span> value<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">bytes</span> <span class="token keyword">memory</span> cd <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span>IERC20<span class="token punctuation">.</span>transfer<span class="token punctuation">.</span>selector<span class="token punctuation">,</span> to<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span><span class="token builtin">bool</span> noRevert<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data<span class="token punctuation">)</span> <span class="token operator">=</span> tokenAddress<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>cd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>noRevert <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> abi<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvcommon.sol-permit-related-functionality">Permit-related functionality</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Takers may provide allowances on specific offer lists, so other addresses can execute orders in their name. Allowance may be set using the usual <code>approve</code> function, or through an <a href="https://eips.ethereum.org/EIPS/eip-712">EIP712</a> <code>permit</code>.</p>
<p>The mapping is <code>outbound_tkn =&gt; inbound_tkn =&gt; owner =&gt; spender =&gt; allowance</code>. There is no <code>tickSpacing</code> specified since we assume the natural semantics of a permit are “<code>spender</code> has the right to trade token A against token B at any tickSpacing”.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>137
138
139
140</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn
      <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> inbound_tkn <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> owner <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> spender <span class="token operator">=></span> <span class="token builtin">uint</span> allowance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> _allowance<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Storing nonces avoids replay attacks.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>142
143</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> owner <span class="token operator">=></span> <span class="token builtin">uint</span> nonce<span class="token punctuation">)</span> <span class="token keyword">internal</span> _nonces<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Following <a href="https://eips.ethereum.org/EIPS/eip-712">EIP712</a>, structured data signing has <code>keccak256(&quot;Permit(address outbound_tkn,address inbound_tkn,address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)&quot;)</code> in its prefix.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>145</pre></code>
          <pre>  <span class="token builtin">bytes32</span> <span class="token keyword">internal</span> <span class="token keyword">constant</span> _PERMIT_TYPEHASH <span class="token operator">=</span> <span class="token number">0xf0ea0a7146fb6eedb561d97b593d57d9b7df3c94d689372dc01302e5780248f4</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If you are looking for <code>DOMAIN_SEPARATOR</code>, it is defined in <code>MgvOfferTakingWithPermit</code>.</p>
<p>If you define an immutable C, you must initialize it in the constructor of C, unless you use solidity &gt;= 0.8.21. Then you can initialize it in the constructor of a contract that inherits from C. At the time of the writing 0.8.21 is too recent so we move <code>DOMAIN_SEPARATOR</code> to <code>MgvOfferTakingWithPermit</code>, which has a constructor and also initializes <code>DOMAIN_SEPARATOR</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>149</pre></code>
          <pre><span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvhasoffers.sol" class="left filebreak">MgvHasOffers.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.10</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@mgv/src/core/MgvLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvCommon<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvCommon.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MgvHasOffers</code> contains the state variables and functions common to both market-maker operations and market-taker operations. Mostly: storing offers, removing them, updating market makers’ provisions.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>8</pre></code>
          <pre><span class="token keyword">contract</span> <span class="token class-name">MgvHasOffers</span> <span class="token keyword">is</span> MgvCommon <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvhasoffers.sol-provision-debit%2Fcredit-utility-functions">Provision debit/credit utility functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>balanceOf</code> is in wei of ETH.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">debitWei</span><span class="token punctuation">(</span><span class="token builtin">address</span> maker<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> makerBalance <span class="token operator">=</span> _balanceOf<span class="token punctuation">[</span>maker<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>makerBalance <span class="token operator">>=</span> amount<span class="token punctuation">,</span> <span class="token string">"mgv/insufficientProvision"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      _balanceOf<span class="token punctuation">[</span>maker<span class="token punctuation">]</span> <span class="token operator">=</span> makerBalance <span class="token operator">-</span> amount<span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">Debit</span><span class="token punctuation">(</span>maker<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">creditWei</span><span class="token punctuation">(</span><span class="token builtin">address</span> maker<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      _balanceOf<span class="token punctuation">[</span>maker<span class="token punctuation">]</span> <span class="token operator">+=</span> amount<span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">Credit</span><span class="token punctuation">(</span>maker<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvhasoffers.sol-misc.-low-level-functions">Misc. low-level functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvhasoffers.sol-offer-deletion">Offer deletion</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>When an offer is deleted, it is marked as such by setting <code>gives</code> to 0 and leaving other fields intact. Note that provision accounting in Mangrove aims to minimize writes. Each maker <code>fund</code>s Mangrove to increase its balance. When an offer is created/updated, we compute how much should be reserved to pay for possible penalties. That amount can always be recomputed with</p>
<pre><code>offerDetail.gasprice * 1e6 * (offerDetail.gasreq + offerDetail.offer_gasbase)
</code></pre>
<p>The balance is updated to reflect the remaining available ethers.</p>
<p>Now, when an offer is deleted, the offer can stay provisioned, or be <code>deprovision</code>ed. In the latter case, we set <code>gasprice</code> to 0, which induces a provision of 0. All code calling <code>dirtyDeleteOffer</code> with <code>deprovision</code> set to <code>true</code> must be careful to correctly account for where that provision is going (back to the maker’s <code>balanceOf</code>, or sent to a taker as compensation).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>40
41
42
43
44
45
46
47
48
49
50
51
52</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">dirtyDeleteOffer</span><span class="token punctuation">(</span>OfferData <span class="token keyword">storage</span> offerData<span class="token punctuation">,</span> Offer offer<span class="token punctuation">,</span> OfferDetail offerDetail<span class="token punctuation">,</span> <span class="token builtin">bool</span> deprovision<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      offer <span class="token operator">=</span> offer<span class="token punctuation">.</span><span class="token function">gives</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>deprovision<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        offerDetail <span class="token operator">=</span> offerDetail<span class="token punctuation">.</span><span class="token function">gasprice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      offerData<span class="token punctuation">.</span>offer <span class="token operator">=</span> offer<span class="token punctuation">;</span>
      offerData<span class="token punctuation">.</span>detail <span class="token operator">=</span> offerDetail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvhasoffers.sol-removing-an-offer-from-the-tick-tree">Removing an offer from the tick tree</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>To remove an offer from the tick tree, we do the following:</p>
<ul>
<li>Remove the offer from the bin</li>
<li>If the bin is now empty, mark it as empty in its leaf</li>
<li>If the leaf is now empty, mark it as empty in its level3</li>
<li>If the level3 is now empty, mark it as empty in its level2
<ul>
<li>If the level2 is now empty, mark it as empty in its level1
<ul>
<li>If the level1 is now empty, mark it as empty in the root
<ul>
<li>If the root is now empty, return</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Once we are done marking leaves/fields as empty, if the removed offer was the best there is at least one remaining offer, and if the caller requested it by setting <code>shouldUpdateBranch=true</code>, go down the tree and find the new best offer.</li>
</ul>
<p>Each step must take into account the fact that the branch of the best offer is cached in <code>local</code>, and that loading a new best offer requires caching a different branch in <code>local</code>.</p>
<p>The reason why the caller might set <code>shouldUpdateBranch=false</code> is that it is itself about to insert an offer better than the current best offer. In that case, it will take care of caching the branch of the new best offer after calling <code>dislodgeOffer</code>.</p>
<p>The new updated local is returned, along with whether the branch in local ended up being updated.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>71
72
73
74
75
76
77
78
79
80
81
82</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">dislodgeOffer</span><span class="token punctuation">(</span>
    OfferList <span class="token keyword">storage</span> offerList<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> tickSpacing<span class="token punctuation">,</span>
    Offer offer<span class="token punctuation">,</span>
    Local local<span class="token punctuation">,</span>
    Bin bestBin<span class="token punctuation">,</span>
    <span class="token builtin">bool</span> shouldUpdateBranch
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Local<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      Leaf leaf<span class="token punctuation">;</span>
      Bin offerBin <span class="token operator">=</span> offer<span class="token punctuation">.</span><span class="token function">bin</span><span class="token punctuation">(</span>tickSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>save stack space</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>84
85</pre></code>
          <pre>        <span class="token builtin">uint</span> prevId <span class="token operator">=</span> offer<span class="token punctuation">.</span><span class="token function">prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint</span> nextId <span class="token operator">=</span> offer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Only load <code>offer</code>’s leaf if the offer leaf must be updated. If <code>offer</code> is in the middle of a bin’s linked list, the bin’s first&amp;last offers will not change, so the leaf does not have to be loaded.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>87
88
89
90</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevId <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> nextId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          leaf <span class="token operator">=</span> offerList<span class="token punctuation">.</span>leafs<span class="token punctuation">[</span>offerBin<span class="token punctuation">.</span><span class="token function">leafIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Update the forward pointer to <code>offer</code> (either in a leaf or in an offer’s next pointer)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>92</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>offer</code> was its bin’s first offer, the new first offer is <code>nextId</code> (may be 0).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>94
95</pre></code>
          <pre>          leaf <span class="token operator">=</span> leaf<span class="token punctuation">.</span><span class="token function">setBinFirst</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">,</span> nextId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Otherwise, the next pointer of <code>offer</code>’s prev becomes <code>nextId</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>97
98
99
100</pre></code>
          <pre>          OfferData <span class="token keyword">storage</span> prevOfferData <span class="token operator">=</span> offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>prevId<span class="token punctuation">]</span><span class="token punctuation">;</span>
          prevOfferData<span class="token punctuation">.</span>offer <span class="token operator">=</span> prevOfferData<span class="token punctuation">.</span>offer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>nextId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Update the backward pointer to <code>offer</code> (either in a leaf or in an offer’s prev pointer)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>102</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>offer</code> was its bin’s last offer, the new last offer is <code>prevId</code> (may be 0).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>104
105</pre></code>
          <pre>          leaf <span class="token operator">=</span> leaf<span class="token punctuation">.</span><span class="token function">setBinLast</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">,</span> prevId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Otherwise, the prev pointer of <code>offer</code>’s next becomes <code>prevId</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>107
108
109
110</pre></code>
          <pre>          OfferData <span class="token keyword">storage</span> nextOfferData <span class="token operator">=</span> offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>nextId<span class="token punctuation">]</span><span class="token punctuation">;</span>
          nextOfferData<span class="token punctuation">.</span>offer <span class="token operator">=</span> nextOfferData<span class="token punctuation">.</span>offer<span class="token punctuation">.</span><span class="token function">prev</span><span class="token punctuation">(</span>prevId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If previous pointer updates only updated offer pointers, <code>offer</code>’s leaf has not changed and we can return early</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>112
113
114
115</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevId <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> nextId <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">(</span>local<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Only plan on updating the branch if the caller requested it and if <code>offer</code> is the best.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>117
118
119</pre></code>
          <pre>        shouldUpdateBranch <span class="token operator">=</span> shouldUpdateBranch <span class="token operator">&amp;&amp;</span> prevId <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bestBin<span class="token punctuation">.</span><span class="token function">strictlyBetter</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since <code>offer</code> was the first or last of its bin, its leaf must be updated</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>121</pre></code>
          <pre>      offerList<span class="token punctuation">.</span>leafs<span class="token punctuation">[</span>offerBin<span class="token punctuation">.</span><span class="token function">leafIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> leaf<span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the leaf is now empty, flip off its bit in <code>offer</code>’s level3</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>123</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>leaf<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We reuse the same <code>index</code> variable for all 3 level indices and for the leaf index.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>125</pre></code>
          <pre>        <span class="token builtin">int</span> index <span class="token operator">=</span> offerBin<span class="token punctuation">.</span><span class="token function">level3Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We reuse the same <code>field</code> variable for all 3 level indices.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>127</pre></code>
          <pre>        Field field<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><em>Local cache management conditional</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>129</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> bestBin<span class="token punctuation">.</span><span class="token function">level3Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>offer</code>’s level3 is cached, update it in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>131
132</pre></code>
          <pre>          field <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flipBitAtLevel3</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">)</span><span class="token punctuation">;</span>
          local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>shouldUpdateBranch=true</code> and the level3 is now empty, another level3 may take its place. We immediately evict the empty value of level3 to storage. (If the level3 is not empty, then the new best offer will use that level3, so no eviction necessary).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>134</pre></code>
          <pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdateBranch <span class="token operator">&amp;&amp;</span> field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Clean/dirty management. <code>if</code>s are nested to avoid a useless SLOAD.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>136
137
138
139
140</pre></code>
          <pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>offerList<span class="token punctuation">.</span>level3s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>DirtyFieldLib<span class="token punctuation">.</span>CLEAN_EMPTY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              offerList<span class="token punctuation">.</span>level3s<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> DirtyFieldLib<span class="token punctuation">.</span>DIRTY_EMPTY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>offer</code>’s level3 is not cached, update it in storage.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>142
143
144</pre></code>
          <pre>          field <span class="token operator">=</span> offerList<span class="token punctuation">.</span>level3s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flipBitAtLevel3</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">)</span><span class="token punctuation">;</span>
          offerList<span class="token punctuation">.</span>level3s<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>offer</code>’s level3 is now empty, flip off its bit in the removed offer’s level2</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>146
147</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          index <span class="token operator">=</span> offerBin<span class="token punctuation">.</span><span class="token function">level2Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><em>Local cache management conditional</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>149</pre></code>
          <pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> bestBin<span class="token punctuation">.</span><span class="token function">level2Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>offer</code>’s level2 is cached, update it in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>151
152</pre></code>
          <pre>            field <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flipBitAtLevel2</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level2</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>shouldUpdateBranch=true</code> and the level2 is now empty, another level2 may take its place. We immediately evict the empty value of level2 to storage. (If the level2 is not empty, then the new best offer will use that level2, so no eviction necessary).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>154</pre></code>
          <pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdateBranch <span class="token operator">&amp;&amp;</span> field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Clean/dirty management. Ifs are nested to avoid a useless SLOAD.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>156
157
158
159
160</pre></code>
          <pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>offerList<span class="token punctuation">.</span>level2s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>DirtyFieldLib<span class="token punctuation">.</span>CLEAN_EMPTY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                offerList<span class="token punctuation">.</span>level2s<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> DirtyFieldLib<span class="token punctuation">.</span>DIRTY_EMPTY<span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>offer</code>’s level2 is not cached, update it in storage.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>162
163
164</pre></code>
          <pre>            field <span class="token operator">=</span> offerList<span class="token punctuation">.</span>level2s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flipBitAtLevel2</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            offerList<span class="token punctuation">.</span>level2s<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>offer</code>’s level2 is now empty, flip off its bit in <code>offer</code>’s level1</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>166
167</pre></code>
          <pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            index <span class="token operator">=</span> offerBin<span class="token punctuation">.</span><span class="token function">level1Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><em>Local cache management conditional</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>169</pre></code>
          <pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> bestBin<span class="token punctuation">.</span><span class="token function">level1Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>offer</code>’s level1 is cached, update it in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>171
172</pre></code>
          <pre>              field <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flipBitAtLevel1</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">)</span><span class="token punctuation">;</span>
              local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level1</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>shouldUpdateBranch=true</code> and the level1 is now empty, another level1 may take its place. We immediately evict the empty value of level1 to storage. (If the level1 is not empty, then the new best offer will use that level1, so no eviction necessary).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>174</pre></code>
          <pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdateBranch <span class="token operator">&amp;&amp;</span> field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Unlike with level3 and level2, level1 cannot be <code>CLEAN_EMPTY</code> (it gets dirtied in <code>activate</code>)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>176
177
178</pre></code>
          <pre>                offerList<span class="token punctuation">.</span>level1s<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>offer</code>’s level1 is not cached, update it in storage.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>180
181
182</pre></code>
          <pre>              field <span class="token operator">=</span> offerList<span class="token punctuation">.</span>level1s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flipBitAtLevel1</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">)</span><span class="token punctuation">;</span>
              offerList<span class="token punctuation">.</span>level1s<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>offer</code>’s level1 is now empty, flip off its bit in the root field.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>184</pre></code>
          <pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>root is always in <code>local</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>186
187
188</pre></code>
          <pre>              field <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flipBitAtRoot</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">)</span><span class="token punctuation">;</span>
              local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">root</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the root is now empty, return the updated <code>local</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>190
191
192</pre></code>
          <pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>local<span class="token punctuation">,</span> shouldUpdateBranch<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since <code>offer</code>’s level1 became empty, if we have to update the branch, load the level1 containing the new best offer in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>194
195
196
197
198
199</pre></code>
          <pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdateBranch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                index <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">firstLevel1Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                field <span class="token operator">=</span> offerList<span class="token punctuation">.</span>level1s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level1</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since <code>offer</code>’s level2 became empty, if we have to update the branch, load the level2 containing the new best offer in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>201
202
203
204
205
206</pre></code>
          <pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdateBranch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              index <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">firstLevel2Index</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
              field <span class="token operator">=</span> offerList<span class="token punctuation">.</span>level2s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level2</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since <code>offer</code>’s level3 became empty, if we have to update the branch, load the level3 containing the new best offer in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>208
209
210
211
212
213</pre></code>
          <pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdateBranch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            index <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">firstLevel3Index</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            field <span class="token operator">=</span> offerList<span class="token punctuation">.</span>level3s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since <code>offer</code>’s leaf became empty, if we have to update the branch, load the leaf containing the new best offer in <code>leaf</code> (so that we can find the position of the first non-empty bin in the leaf).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>215
216
217
218</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdateBranch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          leaf <span class="token operator">=</span> offerList<span class="token punctuation">.</span>leafs<span class="token punctuation">[</span>field<span class="token punctuation">.</span><span class="token function">firstLeafIndex</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since <code>offer</code>’s bin became empty if we have to update the branch, load the position of the first non-empty bin in the current leaf in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>220
221
222
223
224
225
226</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdateBranch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">binPosInLeaf</span><span class="token punctuation">(</span>leaf<span class="token punctuation">.</span><span class="token function">bestNonEmptyBinPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>local<span class="token punctuation">,</span> shouldUpdateBranch<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvoffermaking.sol" class="left filebreak">MgvOfferMaking.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.10</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@mgv/src/core/MgvLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvHasOffers<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvHasOffers.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MgvOfferMaking</code> contains market-making-related functions.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>8</pre></code>
          <pre><span class="token keyword">contract</span> <span class="token class-name">MgvOfferMaking</span> <span class="token keyword">is</span> MgvHasOffers <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffermaking.sol-public-maker-operations">Public Maker operations</h1>
<h2 id="mgvoffermaking.sol-new-offer">New Offer</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In Mangrove, makers and takers call separate functions. Market makers call <code>newOffer</code> to fill the book, and takers call functions such as <code>marketOrder</code> to consume it.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The following structs holds offer creation/update parameters in memory. This frees up stack space for local variables.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>17
18
19
20
21
22
23
24</pre></code>
          <pre>  <span class="token keyword">struct</span> <span class="token class-name">OfferPack</span> <span class="token punctuation">{</span>
    OLKey olKey<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gives<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> id<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gasreq<span class="token punctuation">;</span>
    <span class="token builtin">uint</span> gasprice<span class="token punctuation">;</span>
    Global global<span class="token punctuation">;</span>
    Local local<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>used on update only</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>26
27
28</pre></code>
          <pre>    Offer oldOffer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The function <code>newOffer</code> is for market makers only; no match with the existing offer list is done. The maker specifies how much <code>olKey.outbound_tkn</code> token it <code>gives</code>, and at which <code>tick</code> (which is a power of 1.0001 and induces a price). The actual tick of the offer will be the smallest tick offerTick &gt; tick that satisfies offerTick % tickSpacing == 0.</p>
<p>It also specify with <code>gasreq</code> how much gas should be given when executing their offer.</p>
<p><code>gasprice</code> indicates an upper bound on the gasprice (in Mwei) at which the maker is ready to be penalised if their offer fails. Any value below Mangrove’s internal <code>gasprice</code> configuration value will be ignored.</p>
<p><code>gasreq</code>, together with <code>gasprice</code>, will contribute to determining the penalty provision set aside by Mangrove from the market maker’s <code>balanceOf</code> balance.</p>
<p>An offer cannot be inserted in a closed market, nor when a reentrancy lock for <code>outbound_tkn</code>,<code>inbound_tkn</code> is on.</p>
<p>No more than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>32</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{32}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> offers can ever be created for one (<code>outbound</code>,<code>inbound</code>, <code>tickSpacing</code>) offer list.</p>
<p>The actual contents of the function is in <code>writeOffer</code>, which is called by both <code>newOffer</code> and <code>updateOffer</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>42
43
44
45
46
47
48</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">newOfferByTick</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> Tick tick<span class="token punctuation">,</span> <span class="token builtin">uint</span> gives<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasprice<span class="token punctuation">)</span>
    <span class="token keyword">public</span>
    <span class="token keyword">payable</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> offerId<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In preparation for calling <code>writeOffer</code>, we read the <code>outbound_tkn</code>,<code>inbound_tkn</code>, <code>tickSpacing</code> offer list configuration, check for reentrancy and offer list liveness, fill the <code>OfferPack</code> struct and increment the offer list’s <code>last</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre></code>
          <pre>      OfferPack <span class="token keyword">memory</span> ofp<span class="token punctuation">;</span>
      OfferList <span class="token keyword">storage</span> offerList<span class="token punctuation">;</span>
      <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>global<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">,</span> offerList<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_config</span><span class="token punctuation">(</span>olKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">activeOfferListOnly</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>global<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">creditWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      ofp<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint32</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token operator">==</span> ofp<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"mgv/offerIdOverflow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      ofp<span class="token punctuation">.</span>local <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">last</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

      ofp<span class="token punctuation">.</span>olKey <span class="token operator">=</span> olKey<span class="token punctuation">;</span>
      ofp<span class="token punctuation">.</span>gives <span class="token operator">=</span> gives<span class="token punctuation">;</span>
      ofp<span class="token punctuation">.</span>gasreq <span class="token operator">=</span> gasreq<span class="token punctuation">;</span>
      ofp<span class="token punctuation">.</span>gasprice <span class="token operator">=</span> gasprice<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The last parameter to writeOffer indicates that we are creating a new offer, not updating an existing one.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>69
70</pre></code>
          <pre>      <span class="token function">writeOffer</span><span class="token punctuation">(</span>offerList<span class="token punctuation">,</span> ofp<span class="token punctuation">,</span> tick<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since we locally modified a field of the local configuration (<code>last</code>), we save the change to storage. Note that <code>writeOffer</code> may have further modified the local configuration by updating the currently cached tick tree branch.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>72
73
74
75
76</pre></code>
          <pre>      offerList<span class="token punctuation">.</span>local <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
      <span class="token keyword">return</span> ofp<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>There is a <code>ByVolume</code> variant where the maker specifies how much <code>inbound_tkn</code> it <code>wants</code> and how much <code>outbound_tkn</code> it <code>gives</code>. Volumes should fit on 127 bits.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>80
81
82
83
84
85
86
87
88
89</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">newOfferByVolume</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">uint</span> wants<span class="token punctuation">,</span> <span class="token builtin">uint</span> gives<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasprice<span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    <span class="token keyword">payable</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> offerId<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">newOfferByTick</span><span class="token punctuation">(</span>olKey<span class="token punctuation">,</span> TickLib<span class="token punctuation">.</span><span class="token function">tickFromVolumes</span><span class="token punctuation">(</span>wants<span class="token punctuation">,</span> gives<span class="token punctuation">)</span><span class="token punctuation">,</span> gives<span class="token punctuation">,</span> gasreq<span class="token punctuation">,</span> gasprice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffermaking.sol-update-offer">Update Offer</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Very similar to <code>newOffer</code>, <code>updateOffer</code> prepares an <code>OfferPack</code> for <code>writeOffer</code>. Makers should use it for updating live offers, but also to save on gas by reusing old, already consumed offers.</p>
<p>Gas use is minimal when:</p>
<ol>
<li>The offer does not move in the offer list</li>
<li>The offer does not change its <code>gasreq</code></li>
<li>The (<code>outbound_tkn</code>,<code>inbound_tkn</code>)'s <code>offer_gasbase</code> has not changed since the offer was last written</li>
<li><code>gasprice</code> has not changed since the offer was last written</li>
<li><code>gasprice</code> is greater than Mangrove’s gasprice estimation</li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">updateOfferByTick</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> Tick tick<span class="token punctuation">,</span> <span class="token builtin">uint</span> gives<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span> <span class="token builtin">uint</span> offerId<span class="token punctuation">)</span>
    <span class="token keyword">public</span>
    <span class="token keyword">payable</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      OfferPack <span class="token keyword">memory</span> ofp<span class="token punctuation">;</span>
      OfferList <span class="token keyword">storage</span> offerList<span class="token punctuation">;</span>
      <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>global<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">,</span> offerList<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_config</span><span class="token punctuation">(</span>olKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">activeOfferListOnly</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>global<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>value <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">creditWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      ofp<span class="token punctuation">.</span>olKey <span class="token operator">=</span> olKey<span class="token punctuation">;</span>
      ofp<span class="token punctuation">.</span>gives <span class="token operator">=</span> gives<span class="token punctuation">;</span>
      ofp<span class="token punctuation">.</span>id <span class="token operator">=</span> offerId<span class="token punctuation">;</span>
      ofp<span class="token punctuation">.</span>gasreq <span class="token operator">=</span> gasreq<span class="token punctuation">;</span>
      ofp<span class="token punctuation">.</span>gasprice <span class="token operator">=</span> gasprice<span class="token punctuation">;</span>
      ofp<span class="token punctuation">.</span>oldOffer <span class="token operator">=</span> offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">.</span>offer<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>Save local config</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>121</pre></code>
          <pre>      Local oldLocal <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The second argument indicates that we are updating an existing offer, not creating a new one.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>123</pre></code>
          <pre>      <span class="token function">writeOffer</span><span class="token punctuation">(</span>offerList<span class="token punctuation">,</span> ofp<span class="token punctuation">,</span> tick<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We saved the current offer list’s local configuration before calling <code>writeOffer</code>, since that function may update it. We now check for any change to the configuration and update it if needed.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>125
126
127
128
129
130
131
132
133
134
135
136
137
138
139</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldLocal<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        offerList<span class="token punctuation">.</span>local <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">updateOfferByVolume</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">uint</span> wants<span class="token punctuation">,</span> <span class="token builtin">uint</span> gives<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span> <span class="token builtin">uint</span> offerId<span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    <span class="token keyword">payable</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">updateOfferByTick</span><span class="token punctuation">(</span>olKey<span class="token punctuation">,</span> TickLib<span class="token punctuation">.</span><span class="token function">tickFromVolumes</span><span class="token punctuation">(</span>wants<span class="token punctuation">,</span> gives<span class="token punctuation">)</span><span class="token punctuation">,</span> gives<span class="token punctuation">,</span> gasreq<span class="token punctuation">,</span> gasprice<span class="token punctuation">,</span> offerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffermaking.sol-retract-offer">Retract Offer</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>retractOffer</code> takes the offer <code>offerId</code> out of the book. However, <code>deprovision == true</code> also refunds the provision associated with the offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>143
144
145
146
147
148
149
150
151</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">retractOffer</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">uint</span> offerId<span class="token punctuation">,</span> <span class="token builtin">bool</span> deprovision<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> provision<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token punctuation">,</span> Local local<span class="token punctuation">,</span> OfferList <span class="token keyword">storage</span> offerList<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_config</span><span class="token punctuation">(</span>olKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
      OfferData <span class="token keyword">storage</span> offerData <span class="token operator">=</span> offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span>
      Offer offer <span class="token operator">=</span> offerData<span class="token punctuation">.</span>offer<span class="token punctuation">;</span>
      OfferDetail offerDetail <span class="token operator">=</span> offerData<span class="token punctuation">.</span>detail<span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> offerDetail<span class="token punctuation">.</span><span class="token function">maker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/retractOffer/unauthorized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Here, we are about to un-live an offer, so we start by taking it out of the tick tree. Note that unconditionally calling <code>dislodgeOffer</code> even if the offer is not <code>live</code> would break the offer list since it would connect offers that may have since moved.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>153
154
155</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>offer<span class="token punctuation">.</span><span class="token function">isLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Local oldLocal <span class="token operator">=</span> local<span class="token punctuation">;</span>
        <span class="token punctuation">(</span>local<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">dislodgeOffer</span><span class="token punctuation">(</span>offerList<span class="token punctuation">,</span> olKey<span class="token punctuation">.</span>tickSpacing<span class="token punctuation">,</span> offer<span class="token punctuation">,</span> local<span class="token punctuation">,</span> local<span class="token punctuation">.</span><span class="token function">bestBin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If calling <code>dislodgeOffer</code> has changed the current best offer, we update <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>157
158
159
160</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldLocal<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          offerList<span class="token punctuation">.</span>local <span class="token operator">=</span> local<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Set <code>offer.gives</code> to 0 (which is encodes the fact that the offer is dead). The <code>deprovision</code> argument indicates whether the maker wishes to get their provision back (if true, <code>offer.gasprice</code> will be set to 0 as well).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>162
163</pre></code>
          <pre>      <span class="token function">dirtyDeleteOffer</span><span class="token punctuation">(</span>offerData<span class="token punctuation">,</span> offer<span class="token punctuation">,</span> offerDetail<span class="token punctuation">,</span> deprovision<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the user wants to get their provision back, we compute it from the offer’s <code>gasprice</code>, <code>offer_gasbase</code> and <code>gasreq</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>165
166
167</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>deprovision<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        provision <span class="token operator">=</span> <span class="token number">1e6</span> <span class="token operator">*</span> offerDetail<span class="token punctuation">.</span><span class="token function">gasprice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//gasprice is 0 if offer was deprovisioned</span>
          <span class="token operator">*</span> <span class="token punctuation">(</span>offerDetail<span class="token punctuation">.</span><span class="token function">gasreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offerDetail<span class="token punctuation">.</span><span class="token function">offer_gasbase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>credit <code>balanceOf</code> and log transfer</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>169
170
171
172
173
174
175</pre></code>
          <pre>        <span class="token function">creditWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> provision<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">emit</span> <span class="token function">OfferRetract</span><span class="token punctuation">(</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offerDetail<span class="token punctuation">.</span><span class="token function">maker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offerId<span class="token punctuation">,</span> deprovision<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffermaking.sol-provisioning">Provisioning</h2>
<p>Market makers must have enough provisions for possible penalties. These provisions are in native tokens. Every time a new offer is created or an offer is updated, <code>balanceOf</code> is adjusted to provision the offer’s maximum possible penalty (<code>gasprice * (gasreq + offer_gasbase)</code>).</p>
<p>For instance, if the current <code>balanceOf</code> of a maker is 1 ether and they create an offer that requires a provision of 0.01 ethers, their <code>balanceOf</code> will be reduced to 0.99 ethers. No ethers will move; this is just an internal accounting movement to make sure the maker cannot <code>withdraw</code> the provisioned amounts.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Fund should be called with a nonzero value (hence the <code>payable</code> modifier). The provision will be given to <code>maker</code>, not <code>msg.sender</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>185
186
187
188
189
190
191
192
193
194
195
196
197
198</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">fund</span><span class="token punctuation">(</span><span class="token builtin">address</span> maker<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>Global _global<span class="token punctuation">,</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_config</span><span class="token punctuation">(</span><span class="token function">OLKey</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">liveMgvOnly</span><span class="token punctuation">(</span>_global<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">creditWei</span><span class="token punctuation">(</span>maker<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">fund</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">fund</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>A transfer with enough gas to Mangrove will increase the caller’s available <code>balanceOf</code> balance. <em>You should send enough gas to execute this function when sending money to Mangrove.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>200
201
202
203
204
205</pre></code>
          <pre>  <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">fund</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Any provision not currently held to secure an offer’s possible penalty is available for withdrawal.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>207
208</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span> noRevert<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since we only ever send money to the caller, we do not need to provide any particular amount of gas, the caller should manage this herself.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>210
211
212
213
214</pre></code>
          <pre>      <span class="token function">debitWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span>noRevert<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span>call<span class="token punctuation">{</span>value<span class="token punctuation">:</span> amount<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffermaking.sol-low-level-maker-functions">Low-level Maker functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffermaking.sol-write-offer">Write Offer</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Used by <code>updateOfferBy*</code> and <code>newOfferBy*</code>, this function optionally removes an offer then (re)inserts it in the tick tree. The <code>update</code> argument indicates whether the call comes from <code>updateOfferBy*</code> or <code>newOfferBy*</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>220
221</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">writeOffer</span><span class="token punctuation">(</span>OfferList <span class="token keyword">storage</span> offerList<span class="token punctuation">,</span> OfferPack <span class="token keyword">memory</span> ofp<span class="token punctuation">,</span> Tick insertionTick<span class="token punctuation">,</span> <span class="token builtin">bool</span> update<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>gasprice</code>’s floor is Mangrove’s own gasprice estimate, <code>ofp.global.gasprice</code>. We first check that gasprice fits in 26 bits. Otherwise it could be that <code>uint26(gasprice) &lt; global_gasprice &lt; gasprice</code>, and the actual value we store is <code>uint26(gasprice)</code> (using pseudocode here since the type uint26 does not exist).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>223
224
225
226
227
228</pre></code>
          <pre>      <span class="token keyword">require</span><span class="token punctuation">(</span>GlobalLib<span class="token punctuation">.</span><span class="token function">gasprice_check</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gasprice<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/writeOffer/gasprice/tooBig"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gasprice <span class="token operator">&lt;</span> ofp<span class="token punctuation">.</span>global<span class="token punctuation">.</span><span class="token function">gasprice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ofp<span class="token punctuation">.</span>gasprice <span class="token operator">=</span> ofp<span class="token punctuation">.</span>global<span class="token punctuation">.</span><span class="token function">gasprice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Check <code>gasreq</code> below limit. Implies <code>gasreq</code> at most 24 bits wide, which ensures no overflow in computation of <code>provision</code> (see below).</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>230</pre></code>
          <pre>      <span class="token keyword">require</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gasreq <span class="token operator">&lt;=</span> ofp<span class="token punctuation">.</span>global<span class="token punctuation">.</span><span class="token function">gasmax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/writeOffer/gasreq/tooHigh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Make sure <code>gives &gt; 0</code> – division by 0 would throw in several places otherwise, and <code>isLive</code> relies on it.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>232</pre></code>
          <pre>      <span class="token keyword">require</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gives <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"mgv/writeOffer/gives/tooLow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Make sure that the maker is posting a ‘dense enough’ offer: the ratio of <code>outbound_tkn</code> offered per gas consumed must be high enough. The actual gas cost paid by the taker is overapproximated by adding <code>offer_gasbase</code> to <code>gasreq</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>234
235
236
237
238</pre></code>
          <pre>      <span class="token keyword">require</span><span class="token punctuation">(</span>
        ofp<span class="token punctuation">.</span>gives <span class="token operator">>=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">density</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">multiply</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gasreq <span class="token operator">+</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">offer_gasbase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"mgv/writeOffer/density/tooLow"</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The following checks are for the maker’s convenience only.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>240
241
242</pre></code>
          <pre>      <span class="token keyword">require</span><span class="token punctuation">(</span>OfferLib<span class="token punctuation">.</span><span class="token function">gives_check</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gives<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/writeOffer/gives/tooBig"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token builtin">uint</span> tickSpacing <span class="token operator">=</span> ofp<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span>tickSpacing<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Derive bin from given tick, then normalize the tick: available ticks in an offer list are those who are equal to 0 modulo tickSpacing.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>244
245
246
247</pre></code>
          <pre>      Bin insertionBin <span class="token operator">=</span> insertionTick<span class="token punctuation">.</span><span class="token function">nearestBin</span><span class="token punctuation">(</span>tickSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
      insertionTick <span class="token operator">=</span> insertionBin<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span>tickSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>insertionTick<span class="token punctuation">.</span><span class="token function">inRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/writeOffer/tick/outOfRange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Log the write offer event.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>249
250
251
252
253</pre></code>
          <pre>      <span class="token builtin">uint</span> ofrId <span class="token operator">=</span> ofp<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">OfferWrite</span><span class="token punctuation">(</span>
        ofp<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>insertionTick<span class="token punctuation">)</span><span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>gives<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>gasprice<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>gasreq<span class="token punctuation">,</span> ofrId
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We now write the new <code>offerDetails</code> and remember the previous provision (0 by default, for new offers) to balance out maker’s <code>balanceOf</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>255
256
257
258
259
260
261
262
263</pre></code>
          <pre>      <span class="token punctuation">{</span>
        <span class="token builtin">uint</span> oldProvision<span class="token punctuation">;</span>
        OfferData <span class="token keyword">storage</span> offerData <span class="token operator">=</span> offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>ofrId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        OfferDetail offerDetail <span class="token operator">=</span> offerData<span class="token punctuation">.</span>detail<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> offerDetail<span class="token punctuation">.</span><span class="token function">maker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/updateOffer/unauthorized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          oldProvision <span class="token operator">=</span> <span class="token number">1e6</span> <span class="token operator">*</span> offerDetail<span class="token punctuation">.</span><span class="token function">gasprice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>offerDetail<span class="token punctuation">.</span><span class="token function">gasreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offerDetail<span class="token punctuation">.</span><span class="token function">offer_gasbase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the offer is new, has a new <code>gasprice</code>, <code>gasreq</code>, or if Mangrove’s <code>offer_gasbase</code> configuration parameter has changed, we also update <code>offerDetails</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>265
266
267
268
269
270
271
272
273
274
275
276
277</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          <span class="token operator">!</span>update <span class="token operator">||</span> offerDetail<span class="token punctuation">.</span><span class="token function">gasreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ofp<span class="token punctuation">.</span>gasreq <span class="token operator">||</span> offerDetail<span class="token punctuation">.</span><span class="token function">gasprice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ofp<span class="token punctuation">.</span>gasprice
            <span class="token operator">||</span> offerDetail<span class="token punctuation">.</span><span class="token function">offer_gasbase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">offer_gasbase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token builtin">uint</span> offer_gasbase <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">offer_gasbase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          offerData<span class="token punctuation">.</span>detail <span class="token operator">=</span> OfferDetailLib<span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            __maker<span class="token punctuation">:</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span>
            __gasreq<span class="token punctuation">:</span> ofp<span class="token punctuation">.</span>gasreq<span class="token punctuation">,</span>
            __kilo_offer_gasbase<span class="token punctuation">:</span> offer_gasbase <span class="token operator">/</span> <span class="token number">1e3</span><span class="token punctuation">,</span>
            __gasprice<span class="token punctuation">:</span> ofp<span class="token punctuation">.</span>gasprice
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>With every change to an offer, a maker may deduct provisions from its <code>balanceOf</code> balance. It may also get provisions back if the updated offer requires fewer provisions than before.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>279
280
281
282
283
284
285
286</pre></code>
          <pre>        <span class="token builtin">uint</span> provision <span class="token operator">=</span> <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gasreq <span class="token operator">+</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">offer_gasbase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> ofp<span class="token punctuation">.</span>gasprice <span class="token operator">*</span> <span class="token number">1e6</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>provision <span class="token operator">></span> oldProvision<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">debitWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> provision <span class="token operator">-</span> oldProvision<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>provision <span class="token operator">&lt;</span> oldProvision<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">creditWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> oldProvision <span class="token operator">-</span> provision<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We now cache the current best bin in a stack variable. Since the current best bin is derived from <code>ofp.local</code>, and since <code>ofp.local</code> may change as a new branch is cached in <code>local</code>, not caching that value means potentially losing access to it.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>288</pre></code>
          <pre>      Bin cachedBestBin<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>Check if tick tree is currently empty. As an invariant, <code>local.level3</code> if empty, iff <code>local.level2</code> is empty, iff <code>local.level1</code> is empty, iff <code>local.root</code> is empty.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>290</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the tick tree is empty, we consider the current best bin to be the bin of the written offer. This makes later comparisons between them pick the right conditional branch every time.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>292
293</pre></code>
          <pre>        cachedBestBin <span class="token operator">=</span> insertionBin<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the tick tree is currently not empty, we cache the current best bin.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>295</pre></code>
          <pre>        cachedBestBin <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">bestBin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer is currently stored in the tick tree, it must be removed.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>297</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>oldOffer<span class="token punctuation">.</span><span class="token function">isLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the insertion bin of the offer is better than the current best bin, the later call to <code>dislodgeOffer</code> does not need to update the cached branch in <code>local</code> since we (<code>writeOffer</code>) will take care of updating the branch as part of insertion the offer in its new bin. Otherwise, we may need <code>dislodgeOffer</code> to take care of updating the cached branch in <code>local</code>. However, that is only th the case if the written offer is currently the best offer of the tick tree. <code>dislodgeOffer</code> will make that determination.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>299
300</pre></code>
          <pre>          <span class="token builtin">bool</span> shouldUpdateBranch <span class="token operator">=</span> <span class="token operator">!</span>insertionBin<span class="token punctuation">.</span><span class="token function">strictlyBetter</span><span class="token punctuation">(</span>cachedBestBin<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>local</code> is updated, and <code>shouldUpdateBranch</code> now means “did update branch”.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>302
303</pre></code>
          <pre>          <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>local<span class="token punctuation">,</span> shouldUpdateBranch<span class="token punctuation">)</span> <span class="token operator">=</span>
            <span class="token function">dislodgeOffer</span><span class="token punctuation">(</span>offerList<span class="token punctuation">,</span> tickSpacing<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>oldOffer<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">,</span> cachedBestBin<span class="token punctuation">,</span> shouldUpdateBranch<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>dislodgeOffer</code> did update the information in <code>local</code>, it means the cached best bin may be stale – the best offer may now be in a different bin. So we update it.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>305
306</pre></code>
          <pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldUpdateBranch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>A call to <code>bestBin()</code> is invalid when the branch cached in <code>local</code> is for an empty tick tree. In that case, as we did earlier if the tick tree was already empty, we set the current best bin to the bin of the written offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>308
309
310
311
312
313
314
315</pre></code>
          <pre>              cachedBestBin <span class="token operator">=</span> insertionBin<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              cachedBestBin <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">bestBin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We will now insert the offer to its new position in the tick tree. If the offer is now the best offer, we update the cached “bin position in leaf” information in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>317
318
319
320</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cachedBestBin<span class="token punctuation">.</span><span class="token function">strictlyBetter</span><span class="token punctuation">(</span>insertionBin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ofp<span class="token punctuation">.</span>local <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">binPosInLeaf</span><span class="token punctuation">(</span>insertionBin<span class="token punctuation">.</span><span class="token function">posInLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Next, we load the leaf of the offer to check whether it needs updating.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>322
323</pre></code>
          <pre>      Leaf leaf <span class="token operator">=</span> offerList<span class="token punctuation">.</span>leafs<span class="token punctuation">[</span>insertionBin<span class="token punctuation">.</span><span class="token function">leafIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer’s leaf was empty, the level3 above it needs updating.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>325</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>leaf<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We reuse the same <code>field</code> variable for all 3 level indices.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>327</pre></code>
          <pre>        Field field<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We reuse the same <code>insertionIndex</code> and <code>currentIndex</code> variables for all 3 level indices and for the leaf index.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>329
330
331</pre></code>
          <pre>        <span class="token builtin">int</span> insertionIndex <span class="token operator">=</span> insertionBin<span class="token punctuation">.</span><span class="token function">level3Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">int</span> currentIndex <span class="token operator">=</span> cachedBestBin<span class="token punctuation">.</span><span class="token function">level3Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>insertionIndex <span class="token operator">==</span> currentIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer’s level3 is the cached level3, we load the written offer’s level3 from <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>333
334</pre></code>
          <pre>          field <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Otherwise we load the written offer’s level3 from storage.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>336</pre></code>
          <pre>          field <span class="token operator">=</span> offerList<span class="token punctuation">.</span>level3s<span class="token punctuation">[</span>insertionIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer’s level3 is strictly better than the cached level3, we evict the cached level3.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>338
339
340</pre></code>
          <pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>insertionIndex <span class="token operator">&lt;</span> currentIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Field localLevel3 <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token builtin">bool</span> shouldSaveLevel3 <span class="token operator">=</span> <span class="token operator">!</span>localLevel3<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Clean/dirty management. <code>if</code>s are sequenced to avoid a useless SLOAD.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>342
343
344
345
346
347
348
349
350
351</pre></code>
          <pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldSaveLevel3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              shouldSaveLevel3 <span class="token operator">=</span> <span class="token operator">!</span>offerList<span class="token punctuation">.</span>level3s<span class="token punctuation">[</span>currentIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>DirtyFieldLib<span class="token punctuation">.</span>CLEAN_EMPTY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldSaveLevel3<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              offerList<span class="token punctuation">.</span>level3s<span class="token punctuation">[</span>currentIndex<span class="token punctuation">]</span> <span class="token operator">=</span> localLevel3<span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>insertionIndex <span class="token operator">&lt;=</span> currentIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer’s level3 is as good as or better than the cached level3, we cache the written offer’s level3 in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>353
354</pre></code>
          <pre>          ofp<span class="token punctuation">.</span>local <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">flipBitAtLevel3</span><span class="token punctuation">(</span>insertionBin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Otherwise, we put it in storage</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>356
357
358</pre></code>
          <pre>          offerList<span class="token punctuation">.</span>level3s<span class="token punctuation">[</span>insertionIndex<span class="token punctuation">]</span> <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">flipBitAtLevel3</span><span class="token punctuation">(</span>insertionBin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer’s level3 was empty, the level2 above it needs updating.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>360
361
362
363
364</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          insertionIndex <span class="token operator">=</span> insertionBin<span class="token punctuation">.</span><span class="token function">level2Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          currentIndex <span class="token operator">=</span> cachedBestBin<span class="token punctuation">.</span><span class="token function">level2Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>insertionIndex <span class="token operator">==</span> currentIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer’s level2 is the cached level2, we load the written offer’s level2 from <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>366
367</pre></code>
          <pre>            field <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">level2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Otherwise we load the written offer’s level2 from storage.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>369
370</pre></code>
          <pre>            field <span class="token operator">=</span> offerList<span class="token punctuation">.</span>level2s<span class="token punctuation">[</span>insertionIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer’s level2 is strictly better than the cached level2, we evict the cached level2.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>372
373
374
375</pre></code>
          <pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>insertionIndex <span class="token operator">&lt;</span> currentIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              Field localLevel2 <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">level2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token builtin">bool</span> shouldSaveLevel2 <span class="token operator">=</span> <span class="token operator">!</span>localLevel2<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Clean/dirty management. <code>if</code>s are sequenced to avoid a useless SLOAD.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>377
378
379
380
381
382
383
384
385
386</pre></code>
          <pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldSaveLevel2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                shouldSaveLevel2 <span class="token operator">=</span> <span class="token operator">!</span>offerList<span class="token punctuation">.</span>level2s<span class="token punctuation">[</span>currentIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>DirtyFieldLib<span class="token punctuation">.</span>CLEAN_EMPTY<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldSaveLevel2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                offerList<span class="token punctuation">.</span>level2s<span class="token punctuation">[</span>currentIndex<span class="token punctuation">]</span> <span class="token operator">=</span> localLevel2<span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span>insertionIndex <span class="token operator">&lt;=</span> currentIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer’s level3 is as good as or better than the cached level3, we cache the written offer’s level3 in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>388
389</pre></code>
          <pre>            ofp<span class="token punctuation">.</span>local <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">level2</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">flipBitAtLevel2</span><span class="token punctuation">(</span>insertionBin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Otherwise, we put it in storage</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>391
392</pre></code>
          <pre>            offerList<span class="token punctuation">.</span>level2s<span class="token punctuation">[</span>insertionIndex<span class="token punctuation">]</span> <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">flipBitAtLevel2</span><span class="token punctuation">(</span>insertionBin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer’s level2 was empty, the level1 above it needs updating.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>394
395
396
397
398</pre></code>
          <pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            insertionIndex <span class="token operator">=</span> insertionBin<span class="token punctuation">.</span><span class="token function">level1Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            currentIndex <span class="token operator">=</span> cachedBestBin<span class="token punctuation">.</span><span class="token function">level1Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>insertionIndex <span class="token operator">==</span> currentIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer’s level1 is the cached level1, we load the written offer’s level1 from <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>400
401</pre></code>
          <pre>              field <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">level1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Otherwise we load the written offer’s level1 from storage.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>403</pre></code>
          <pre>              field <span class="token operator">=</span> offerList<span class="token punctuation">.</span>level1s<span class="token punctuation">[</span>insertionIndex<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer’s level1 is strictly better than the cached level1, we evict the cached level1.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>405</pre></code>
          <pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span>insertionIndex <span class="token operator">&lt;</span> currentIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Unlike with level2 and level3, level1 cannot be <code>CLEAN_EMPTY</code> (it gets dirtied in <code>activate</code>)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>407
408
409
410
411</pre></code>
          <pre>                offerList<span class="token punctuation">.</span>level1s<span class="token punctuation">[</span>currentIndex<span class="token punctuation">]</span> <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">level1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>insertionIndex <span class="token operator">&lt;=</span> currentIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer’s level1 is as good as or better than the cached level1, we cache the written offer’s level1 in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>413
414</pre></code>
          <pre>              ofp<span class="token punctuation">.</span>local <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">level1</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">flipBitAtLevel1</span><span class="token punctuation">(</span>insertionBin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Otherwise, we put it in storage</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>416
417</pre></code>
          <pre>              offerList<span class="token punctuation">.</span>level1s<span class="token punctuation">[</span>insertionIndex<span class="token punctuation">]</span> <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">flipBitAtLevel1</span><span class="token punctuation">(</span>insertionBin<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the written offer’s level1 was empty, the root needs updating.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>419
420
421
422
423
424
425</pre></code>
          <pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              ofp<span class="token punctuation">.</span>local <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">root</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flipBitAtRoot</span><span class="token punctuation">(</span>insertionBin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Now that we are done checking the current state of the leaf, we can update it. By reading the last id of the written offer’s bin in the offer’s leaf, we can check if the bin is currently empty or not (as an invariant, an empty bin has both <code>firstId</code> and <code>lastId</code> equal to 0, and a nonempty bin has both ids different from 0.</p>
<p>Note that offers are always inserted at the end of their bin, so that earlier offer are taken first during market orders.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>430
431
432</pre></code>
          <pre>
      <span class="token builtin">uint</span> lastId <span class="token operator">=</span> leaf<span class="token punctuation">.</span><span class="token function">lastOfBin</span><span class="token punctuation">(</span>insertionBin<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>lastId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the bin was empty, we update the bin’s first id (a bin with a single offer has that offer id as <code>firstId</code> and as <code>lastId</code>).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>434
435</pre></code>
          <pre>        leaf <span class="token operator">=</span> leaf<span class="token punctuation">.</span><span class="token function">setBinFirst</span><span class="token punctuation">(</span>insertionBin<span class="token punctuation">,</span> ofrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Otherwise, the written offer will become the new last offer of the bin, and the current last offer will have the written offer as next offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>437
438
439
440</pre></code>
          <pre>        OfferData <span class="token keyword">storage</span> offerData <span class="token operator">=</span> offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>lastId<span class="token punctuation">]</span><span class="token punctuation">;</span>
        offerData<span class="token punctuation">.</span>offer <span class="token operator">=</span> offerData<span class="token punctuation">.</span>offer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>ofrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We now store the written offer id as the last offer of the bin.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>442
443
444</pre></code>
          <pre>      leaf <span class="token operator">=</span> leaf<span class="token punctuation">.</span><span class="token function">setBinLast</span><span class="token punctuation">(</span>insertionBin<span class="token punctuation">,</span> ofrId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      offerList<span class="token punctuation">.</span>leafs<span class="token punctuation">[</span>insertionBin<span class="token punctuation">.</span><span class="token function">leafIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> leaf<span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Finally, we store the offer information, including a pointer to the previous last offer of the bin (it may be 0).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>446
447
448
449
450</pre></code>
          <pre>      Offer ofr <span class="token operator">=</span> OfferLib<span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>__prev<span class="token punctuation">:</span> lastId<span class="token punctuation">,</span> __next<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> __tick<span class="token punctuation">:</span> insertionTick<span class="token punctuation">,</span> __gives<span class="token punctuation">:</span> ofp<span class="token punctuation">.</span>gives<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>ofrId<span class="token punctuation">]</span><span class="token punctuation">.</span>offer <span class="token operator">=</span> ofr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvoffertaking.sol" class="left filebreak">MgvOfferTaking.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.10</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"./MgvLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvHasOffers<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvHasOffers.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>TickTreeLib<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/TickTreeLib.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>There are 2 ways to take offers in Mangrove:</p>
<ul>
<li><strong>Market order</strong>. A market order walks the offer list from the best offer and up, can specify a limit price, as well as a buy/sell behaviour (i.e. whether to limit the order buy the amount bought or by the amount sold).</li>
<li><strong>Clean</strong>. Since offers can fail, bots can ‘clean’ specific offers and walk away with the bounty. If an offer does not fail, cleaning it reverts and leaves it in place.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>12</pre></code>
          <pre>abstract <span class="token keyword">contract</span> <span class="token class-name">MgvOfferTaking</span> <span class="token keyword">is</span> MgvHasOffers <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-multiorder-struct">MultiOrder struct</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>MultiOrder</code> struct is used by market orders and cleans. Some of its fields are only used by market orders. We need a common data structure for both since low-level calls are shared between market orders and cleans. The struct is helpful in decreasing stack use.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></code>
          <pre>  <span class="token keyword">struct</span> <span class="token class-name">MultiOrder</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> totalGot<span class="token punctuation">;</span> <span class="token comment">// used globally by market order, per-offer by cleans</span>
    <span class="token builtin">uint</span> totalGave<span class="token punctuation">;</span> <span class="token comment">// used globally by market order, per-offer by cleans</span>
    <span class="token builtin">uint</span> totalPenalty<span class="token punctuation">;</span> <span class="token comment">// used globally</span>
    <span class="token builtin">address</span> taker<span class="token punctuation">;</span> <span class="token comment">// used globally</span>
    <span class="token builtin">bool</span> fillWants<span class="token punctuation">;</span> <span class="token comment">// used globally</span>
    <span class="token builtin">uint</span> fillVolume<span class="token punctuation">;</span> <span class="token comment">// used globally</span>
    <span class="token builtin">uint</span> feePaid<span class="token punctuation">;</span> <span class="token comment">// used globally</span>
    Leaf leaf<span class="token punctuation">;</span> <span class="token comment">// used by market order</span>
    Tick maxTick<span class="token punctuation">;</span> <span class="token comment">// used globally</span>
    <span class="token builtin">uint</span> maxGasreqForFailingOffers<span class="token punctuation">;</span> <span class="token comment">// used by market order</span>
    <span class="token builtin">uint</span> gasreqForFailingOffers<span class="token punctuation">;</span> <span class="token comment">// used by market order</span>
    <span class="token builtin">uint</span> maxRecursionDepth<span class="token punctuation">;</span> <span class="token comment">// used by market order</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-market-orders">Market Orders</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-market-order">Market Order</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>A market order specifies a (<code>outbound</code>, <code>inbound</code>,<code>tickSpacing</code>) offer list, a limit price it is ready to pay (in the form of <code>maxTick</code>, the log base 1.0001 of the price), and a volume <code>fillVolume</code>. If <code>fillWants</code> is true, that volume is the amount of <code>olKey.outbound_tkn</code> the taker wants to buy. If <code>fillWants</code> is false, that volume is the amount of <code>olKey.inbound_tkn</code> the taker wants to sell.</p>
<p>It returns four <code>uint</code>s: the total amount of <code>olKey.outbound_tkn</code> received, the total amount of <code>olKey.inbound_tkn</code> spent, the penalty received by msg.sender (in wei), and the fee paid by the taker (in wei of <code>olKey.outbound_tkn</code>).</p>
<p>The market order stops when the price exceeds (an approximation of) 1.0001^<code>maxTick</code>, or when the end of the book has been reached, or:</p>
<ul>
<li>If <code>fillWants</code> is true, the market order stops when <code>fillVolume</code> units of <code>olKey.outbound_tkn</code> have been obtained. To buy a specific volume of <code>olKey.outbound_tkn</code> at any price, set <code>fillWants</code> to true, set <code>fillVolume</code> to volume you want to buy, and set <code>maxTick</code> to the <code>MAX_TICK</code> constant.</li>
<li>If <code>fillWants</code> is false, the market order stops when <code>fillVolume</code> units of <code>olKey.inbound_tkn</code> have been paid. To sell a specific volume of <code>olKey.inbound_tkn</code> at any price, set <code>fillWants</code> to false, set <code>fillVolume</code> to the volume you want to sell, and set <code>maxTick</code> to the <code>MAX_TICK</code> constant.</li>
</ul>
<p>For a maximum <code>fillVolume</code> and a maximum (when <code>fillWants=true</code>) or minimum (when <code>fillWants=false</code>) price, the taker can end up receiving a volume of about <code>2**255</code> tokens.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>45
46
47
48
49
50
51
52
53
54</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">marketOrderByTick</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> Tick maxTick<span class="token punctuation">,</span> <span class="token builtin">uint</span> fillVolume<span class="token punctuation">,</span> <span class="token builtin">bool</span> fillWants<span class="token punctuation">)</span>
    <span class="token keyword">public</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> takerGot<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerGave<span class="token punctuation">,</span> <span class="token builtin">uint</span> bounty<span class="token punctuation">,</span> <span class="token builtin">uint</span> feePaid<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">generalMarketOrder</span><span class="token punctuation">(</span>olKey<span class="token punctuation">,</span> maxTick<span class="token punctuation">,</span> fillVolume<span class="token punctuation">,</span> fillWants<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>There is a <code>ByVolume</code> variant where the taker specifies a desired total amount of <code>olKey.outbound_tkn</code> tokens (<code>takerWants</code>), and an available total amount of <code>olKey.inbound_tkn</code> (<code>takerGives</code>). Volumes should fit on 127 bits.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>56
57
58
59
60
61
62
63
64</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">marketOrderByVolume</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span> <span class="token builtin">bool</span> fillWants<span class="token punctuation">)</span>
    <span class="token keyword">public</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> takerGot<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerGave<span class="token punctuation">,</span> <span class="token builtin">uint</span> bounty<span class="token punctuation">,</span> <span class="token builtin">uint</span> feePaid<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> fillVolume <span class="token operator">=</span> fillWants <span class="token operator">?</span> takerWants <span class="token punctuation">:</span> takerGives<span class="token punctuation">;</span>
    Tick maxTick <span class="token operator">=</span> TickLib<span class="token punctuation">.</span><span class="token function">tickFromVolumes</span><span class="token punctuation">(</span>takerGives<span class="token punctuation">,</span> takerWants<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">generalMarketOrder</span><span class="token punctuation">(</span>olKey<span class="token punctuation">,</span> maxTick<span class="token punctuation">,</span> fillVolume<span class="token punctuation">,</span> fillWants<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the offer list is filled with failing offers such that the default <code>maxGasreqForFailingOffers</code> is inadequate, this version of the market order lets the taker specify an upper bound on the gas they are ready to spend on failing offers.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>66
67
68
69
70
71
72
73
74
75
76
77</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">marketOrderByTickCustom</span><span class="token punctuation">(</span>
    OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span>
    Tick maxTick<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> fillVolume<span class="token punctuation">,</span>
    <span class="token builtin">bool</span> fillWants<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> maxGasreqForFailingOffers
  <span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> takerGot<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerGave<span class="token punctuation">,</span> <span class="token builtin">uint</span> bounty<span class="token punctuation">,</span> <span class="token builtin">uint</span> feePaid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">generalMarketOrder</span><span class="token punctuation">(</span>olKey<span class="token punctuation">,</span> maxTick<span class="token punctuation">,</span> fillVolume<span class="token punctuation">,</span> fillWants<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> maxGasreqForFailingOffers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Get offer after current offer. Will also remove the current offer and return the corresponding updated <code>local</code>.</p>
<p>During a market order, once an offer has been executed, the next one must be fetched. Since offers are structured in a tick tree, the next offer might be:</p>
<ul>
<li>In the same bin, referred to by the <code>currentOffer.next</code> pointer.</li>
<li>In the same leaf, but in another bin.</li>
<li>In a bin that descend from the same level3 but not the same leaf.</li>
<li>In a bin that descend from the same level2 but not the same level3.</li>
<li>In a bin that descend from the same level1 but not the same level1.</li>
<li>In a bin that descend from a different level1.
Or there might not be a next offer.</li>
</ul>
<p>In any case, the ‘current branch’ is now the branch of the next offer, so <code>local</code> must be updated.</p>
<p><code>getNextBest</code> returns the id of the next offer if there is one (and id 0 otherwise), as well as the updated <code>local</code>.</p>
<p>However, this function is very unsafe taken in isolation:</p>
<ul>
<li>it does not update offer pointers. Since a market order repeatedly calls it and does not inspect the .prev of an offer, the optimization is correct as long as the market order updates the prev pointer of the last offer it sees to 0. After a call, it is your responsibility to do:</li>
</ul>
<pre><code>OfferData storage = offerList.offerData[offerId];
offerData.offer = offer.prev(0);
</code></pre>
<ul>
<li>it does not flush an updated leaf to storage unless the current leaf has become empty and it needs to load a new one. After a call, it is your responsibility to write the new leaf to storage, if necessary.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>101
102
103
104</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">getNextBest</span><span class="token punctuation">(</span>OfferList <span class="token keyword">storage</span> offerList<span class="token punctuation">,</span> MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> Offer offer<span class="token punctuation">,</span> Local local<span class="token punctuation">,</span> <span class="token builtin">uint</span> tickSpacing<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> offerId<span class="token punctuation">,</span> Local<span class="token punctuation">)</span>
  <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Get tick from current offer tick and tickSpacing</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>106
107
108</pre></code>
          <pre>    Bin offerBin <span class="token operator">=</span> offer<span class="token punctuation">.</span><span class="token function">bin</span><span class="token punctuation">(</span>tickSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> nextId <span class="token operator">=</span> offer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Update the bin’s first offer. If nextId is 0, then the bin’s last offer will be updated immediately after.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>110
111
112</pre></code>
          <pre>    Leaf leaf <span class="token operator">=</span> mor<span class="token punctuation">.</span>leaf<span class="token punctuation">;</span>
    leaf <span class="token operator">=</span> leaf<span class="token punctuation">.</span><span class="token function">setBinFirst</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">,</span> nextId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the current bin is now empty, we go up the tick tree to find the next offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>114</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Mark the bin as empty.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>116</pre></code>
          <pre>      leaf <span class="token operator">=</span> leaf<span class="token punctuation">.</span><span class="token function">setBinLast</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the current leaf is now empty, we keep going up the tick tree.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>118</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>leaf<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Flush the current empty leaf since we will load a new one. Note that the slot cannot be empty since we just emptied the leaf (and unlike fields, leaves don’t stay cached in another slot).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>120
121</pre></code>
          <pre>        offerList<span class="token punctuation">.</span>leafs<span class="token punctuation">[</span>offerBin<span class="token punctuation">.</span><span class="token function">leafIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> leaf<span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We reuse the same <code>field</code> variable for all 3 level indices.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>123</pre></code>
          <pre>        Field field <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flipBitAtLevel3</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We reuse the same <code>index</code> variable for all 3 level indices and for the leaf index.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>125</pre></code>
          <pre>        <span class="token builtin">int</span> index <span class="token operator">=</span> offerBin<span class="token punctuation">.</span><span class="token function">level3Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the current level3 is now empty, we keep going up the tick tree.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>127</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Flush the current empty level3 since we will load a new one. We avoid the write if the slot is already cleanly empty.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>129
130
131
132
133</pre></code>
          <pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>offerList<span class="token punctuation">.</span>level3s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>DirtyFieldLib<span class="token punctuation">.</span>CLEAN_EMPTY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            offerList<span class="token punctuation">.</span>level3s<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> DirtyFieldLib<span class="token punctuation">.</span>DIRTY_EMPTY<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          index <span class="token operator">=</span> offerBin<span class="token punctuation">.</span><span class="token function">level2Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          field <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flipBitAtLevel2</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the current level2 is now empty, we keep going up the tick tree.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>135</pre></code>
          <pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Flush the current empty level2 since we will load a new one. We avoid the write if the slot is already cleanly empty.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>137
138
139
140
141</pre></code>
          <pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>offerList<span class="token punctuation">.</span>level2s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>DirtyFieldLib<span class="token punctuation">.</span>CLEAN_EMPTY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              offerList<span class="token punctuation">.</span>level2s<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> DirtyFieldLib<span class="token punctuation">.</span>DIRTY_EMPTY<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            index <span class="token operator">=</span> offerBin<span class="token punctuation">.</span><span class="token function">level1Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            field <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flipBitAtLevel1</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the current level1 is now empty, we keep going up the tick tree.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>143</pre></code>
          <pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Flush the current empty level1 since we will load a new one. Unlike with level2 and level3, level1 cannot be <code>CLEAN_EMPTY</code> (it gets dirtied in <code>activate</code>)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>145
146
147</pre></code>
          <pre>              offerList<span class="token punctuation">.</span>level1s<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> DirtyFieldLib<span class="token punctuation">.</span>DIRTY_EMPTY<span class="token punctuation">;</span>
              field <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flipBitAtRoot</span><span class="token punctuation">(</span>offerBin<span class="token punctuation">)</span><span class="token punctuation">;</span>
              local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">root</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the root is now empty, we mark all fields in local and the current leaf as empty and return the 0 offer id.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>149
150
151
152
153
154
155</pre></code>
          <pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level1</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
                local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level2</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
                local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mor<span class="token punctuation">.</span>leaf <span class="token operator">=</span> LeafLib<span class="token punctuation">.</span>EMPTY<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Last level1 was empty, load the new level1</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>157</pre></code>
          <pre>              index <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">firstLevel1Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>Low-level optim: avoid dirty/clean cycle, dirty bit will be erased anyway.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>159
160</pre></code>
          <pre>              field <span class="token operator">=</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>DirtyField<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>offerList<span class="token punctuation">.</span>level1s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Store current level1 in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>162</pre></code>
          <pre>            local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level1</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Last level2 was empty, load the new level2</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>164</pre></code>
          <pre>            index <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">firstLevel2Index</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>Low-level optim: avoid dirty/clean cycle, dirty bit will be erased anyway.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>166
167</pre></code>
          <pre>            field <span class="token operator">=</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>DirtyField<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>offerList<span class="token punctuation">.</span>level2s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Store current level2 in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>169</pre></code>
          <pre>          local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level2</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Last level3 was empty, load the new level3</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>171</pre></code>
          <pre>          index <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">firstLevel3Index</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>Low-level optim: avoid dirty/clean cycle, dirty bit will be erased anyway.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>173
174</pre></code>
          <pre>          field <span class="token operator">=</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>DirtyField<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>offerList<span class="token punctuation">.</span>level3s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Store current level3 in <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>176</pre></code>
          <pre>        local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Last leaf was empty, load the new leaf.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>178
179</pre></code>
          <pre>        leaf <span class="token operator">=</span> offerList<span class="token punctuation">.</span>leafs<span class="token punctuation">[</span>field<span class="token punctuation">.</span><span class="token function">firstLeafIndex</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Find the position of the best non-empty bin in the current leaf, save it to <code>local</code>, and read the first offer id of that bin.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>181
182
183
184
185
186
187</pre></code>
          <pre>      <span class="token builtin">uint</span> bestNonEmptyBinPos <span class="token operator">=</span> leaf<span class="token punctuation">.</span><span class="token function">bestNonEmptyBinPos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">binPosInLeaf</span><span class="token punctuation">(</span>bestNonEmptyBinPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
      nextId <span class="token operator">=</span> leaf<span class="token punctuation">.</span><span class="token function">firstOfPos</span><span class="token punctuation">(</span>bestNonEmptyBinPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mor<span class="token punctuation">.</span>leaf <span class="token operator">=</span> leaf<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>nextId<span class="token punctuation">,</span> local<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-general-market-order">General Market Order</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>General market orders set up the market order with a given <code>taker</code> (<code>msg.sender</code> in the most common case). Returns <code>(totalGot, totalGave, penaltyReceived, feePaid)</code>.
Note that the <code>taker</code> can be anyone. This is safe when <code>taker == msg.sender</code>, but <code>generalMarketOrder</code> must not be called with <code>taker != msg.sender</code> unless a security check is done after (see <a href="#mgvoffertakingwithpermit.sol"><code>MgvOfferTakingWithPermit</code></a>`.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>192
193
194
195
196
197
198
199
200
201</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">generalMarketOrder</span><span class="token punctuation">(</span>
    OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span>
    Tick maxTick<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> fillVolume<span class="token punctuation">,</span>
    <span class="token builtin">bool</span> fillWants<span class="token punctuation">,</span>
    <span class="token builtin">address</span> taker<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> maxGasreqForFailingOffers
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> takerGot<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerGave<span class="token punctuation">,</span> <span class="token builtin">uint</span> bounty<span class="token punctuation">,</span> <span class="token builtin">uint</span> feePaid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Checking that <code>fillVolume</code> fits in 127 ensures no overflow during the market order recursion.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>203
204
205</pre></code>
          <pre>      <span class="token keyword">require</span><span class="token punctuation">(</span>fillVolume <span class="token operator">&lt;=</span> MAX_SAFE_VOLUME<span class="token punctuation">,</span> <span class="token string">"mgv/mOrder/fillVolume/tooBig"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>maxTick<span class="token punctuation">.</span><span class="token function">inRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/mOrder/tick/outOfRange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MultiOrder</code> (defined above) maintains information related to the entire market order.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>207
208
209
210
211</pre></code>
          <pre>      MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">;</span>
      mor<span class="token punctuation">.</span>maxTick <span class="token operator">=</span> maxTick<span class="token punctuation">;</span>
      mor<span class="token punctuation">.</span>taker <span class="token operator">=</span> taker<span class="token punctuation">;</span>
      mor<span class="token punctuation">.</span>fillWants <span class="token operator">=</span> fillWants<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>SingleOrder</code> is defined in <code>MgvLib.sol</code> and holds information related to the execution of one offer. It also contains <code>olKey</code>, which concerns the entire market order, because it will be sent to the maker, who needs that information.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>213
214
215
216
217</pre></code>
          <pre>      MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">;</span>
      sor<span class="token punctuation">.</span>olKey <span class="token operator">=</span> olKey<span class="token punctuation">;</span>
      OfferList <span class="token keyword">storage</span> offerList<span class="token punctuation">;</span>
      <span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">,</span> offerList<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_config</span><span class="token punctuation">(</span>olKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      mor<span class="token punctuation">.</span>maxRecursionDepth <span class="token operator">=</span> sor<span class="token punctuation">.</span>global<span class="token punctuation">.</span><span class="token function">maxRecursionDepth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We have an upper limit on total gasreq for failing offers to avoid failing offers delivering nothing and exhausting gaslimit for the transaction.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>219
220
221</pre></code>
          <pre>      mor<span class="token punctuation">.</span>maxGasreqForFailingOffers <span class="token operator">=</span>
        maxGasreqForFailingOffers <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> maxGasreqForFailingOffers <span class="token punctuation">:</span> sor<span class="token punctuation">.</span>global<span class="token punctuation">.</span><span class="token function">maxGasreqForFailingOffers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Throughout the execution of the market order, the <code>sor</code>’s offer id and other parameters will change. We start with the current best offer id (0 if the book is empty).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>223
224
225
226
227</pre></code>
          <pre>
      mor<span class="token punctuation">.</span>leaf <span class="token operator">=</span> offerList<span class="token punctuation">.</span>leafs<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">bestBin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">leafIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      sor<span class="token punctuation">.</span>offerId <span class="token operator">=</span> mor<span class="token punctuation">.</span>leaf<span class="token punctuation">.</span><span class="token function">bestOfferId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">.</span>offer<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Throughout the market order, <code>fillVolume</code> represents the amount left to buy (if <code>fillWants</code>) or sell (if <code>!fillWants</code>).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>229
230</pre></code>
          <pre>      mor<span class="token punctuation">.</span>fillVolume <span class="token operator">=</span> fillVolume<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>For the market order to start, the offer list needs to be both active, and not currently protected from reentrancy.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>232
233
234</pre></code>
          <pre>      <span class="token function">activeOfferListOnly</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Initialization</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The market order will operate as follows : it will go through offers from best to worse, starting from <code>offerId</code>, and:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>keep an up-to-date <code>fillVolume</code>.</p>
<ul>
<li>not set <code>prev</code>/<code>next</code> pointers to their correct locations at each offer taken (this is an optimization enabled by forbidding reentrancy).</li>
<li>after consuming a segment of offers, will update the current <code>best</code> offer to be the best remaining offer on the book.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We start be enabling the reentrancy lock for this (<code>olKey.outbound_tkn</code>,<code>olKey.inbound_tkn</code>, <code>olKey.tickSpacing</code>) offer list.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>242
243
244
245
246</pre></code>
          <pre>      sor<span class="token punctuation">.</span>local <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      offerList<span class="token punctuation">.</span>local <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">;</span>

      <span class="token keyword">emit</span> <span class="token function">OrderStart</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> taker<span class="token punctuation">,</span> maxTick<span class="token punctuation">,</span> fillVolume<span class="token punctuation">,</span> fillWants<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Call recursive <code>internalMarketOrder</code> function.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>248
249</pre></code>
          <pre>      <span class="token function">internalMarketOrder</span><span class="token punctuation">(</span>offerList<span class="token punctuation">,</span> mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Over the course of the market order, a penalty reserved for <code>msg.sender</code> has accumulated in <code>mor.totalPenalty</code>. No actual transfers have occurred yet – all the ethers given by the makers as provision are owned by Mangrove. <code>sendPenalty</code> finally gives the accumulated penalty to <code>msg.sender</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>251
252
253
254</pre></code>
          <pre>      <span class="token function">sendPenalty</span><span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalPenalty<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">emit</span> <span class="token function">OrderComplete</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> taker<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>feePaid<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>256
257
258
259</pre></code>
          <pre>      <span class="token keyword">return</span> <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalGot<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>totalGave<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>totalPenalty<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>feePaid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-internal-market-order">Internal market order</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>internalMarketOrder</code> works recursively. Going downward, each successive offer is executed until the market order stops (due to: volume exhausted, bad price, or empty offer list). Then the <a href="#internalMarketOrder/liftReentrancy">reentrancy lock is lifted</a>. As the recursion unrolls, each offer’s <code>maker</code> contract is called again with its remaining gas and given the chance to update its offers on the book.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>263
264
265
266</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">internalMarketOrder</span><span class="token punctuation">(</span>OfferList <span class="token keyword">storage</span> offerList<span class="token punctuation">,</span> MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The market order proceeds only if the following conditions are all met:</p>
<ul>
<li>there is some volume left to buy/sell</li>
<li>the current best offer is not too expensive</li>
<li>there is a current best offer</li>
<li>we are not too deep in the recursive calls (stack overflow risk)</li>
<li>we are not at risk of consuming too much gas because of failing offers</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>274
275
276
277</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        mor<span class="token punctuation">.</span>fillVolume <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>offer<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>mor<span class="token punctuation">.</span>maxTick<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sor<span class="token punctuation">.</span>offerId <span class="token operator">></span> <span class="token number">0</span>
          <span class="token operator">&amp;&amp;</span> mor<span class="token punctuation">.</span>maxRecursionDepth <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mor<span class="token punctuation">.</span>gasreqForFailingOffers <span class="token operator">&lt;=</span> mor<span class="token punctuation">.</span>maxGasreqForFailingOffers
      <span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Market order execution</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>279
280
281
282
283</pre></code>
          <pre>        mor<span class="token punctuation">.</span>maxRecursionDepth<span class="token operator">--</span><span class="token punctuation">;</span>

        <span class="token builtin">uint</span> gasused<span class="token punctuation">;</span> <span class="token comment">// gas used by `makerExecute`</span>
        <span class="token builtin">bytes32</span> makerData<span class="token punctuation">;</span> <span class="token comment">// data returned by maker</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="MgvOfferTaking/statusCodes"></a> <code>mgvData</code> is a Mangrove status code. It appears in an <a href="#MgvLib/OrderResult"><code>OrderResult</code></a>. Its possible values are:</p>
<ul>
<li><code>&quot;mgv/tradeSuccess&quot;</code>: offer execution succeeded.</li>
<li><code>&quot;mgv/makerRevert&quot;</code>: execution of <code>makerExecute</code> reverted.</li>
<li><code>&quot;mgv/makerTransferFail&quot;</code>: maker could not send olKey.outbound_tkn.</li>
<li><code>&quot;mgv/makerReceiveFail&quot;</code>: maker could not receive olKey.inbound_tkn.</li>
</ul>
<p><code>mgvData</code> should not be exploitable by the maker!</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>291
292</pre></code>
          <pre>        <span class="token builtin">bytes32</span> mgvData<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Load additional information about the offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>294
295</pre></code>
          <pre>        sor<span class="token punctuation">.</span>offerDetail <span class="token operator">=</span> offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">.</span>detail<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>execute</code> attempts to execute the offer by calling its maker. <code>execute</code> may modify <code>mor</code> and <code>sor</code>. It is crucial that an error due to <code>taker</code> triggers a revert. That way, if <a href="#MgvOfferTaking/statusCodes"><code>mgvData</code></a> is not <code>&quot;mgv/tradeSuccess&quot;</code>, then the maker is at fault.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Post-execution, <code>sor.takerWants</code>/<code>sor.takerGives</code> reflect how much was sent/taken by the offer. We will need it after the recursive call, so we save it in local variables. Same goes for <code>sor.offerId</code>, <code>sor.offer</code> and <code>sor.offerDetail</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>298
299</pre></code>
          <pre>        <span class="token punctuation">(</span>gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> mgvData<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">execute</span><span class="token punctuation">(</span>offerList<span class="token punctuation">,</span> mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Keep cached copy of current <code>sor</code> values to restore them later to send to posthook.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>301
302
303
304
305
306</pre></code>
          <pre>        <span class="token builtin">uint</span> takerWants <span class="token operator">=</span> sor<span class="token punctuation">.</span>takerWants<span class="token punctuation">;</span>
        <span class="token builtin">uint</span> takerGives <span class="token operator">=</span> sor<span class="token punctuation">.</span>takerGives<span class="token punctuation">;</span>
        <span class="token builtin">uint</span> offerId <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerId<span class="token punctuation">;</span>
        Offer offer <span class="token operator">=</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">;</span>
        OfferDetail offerDetail <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If execution was successful, we decrease <code>fillVolume</code>. This cannot underflow, see the <a href="#MgvOfferTaking/computeVolume"><code>execute</code> function</a> for details.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>308
309
310
311</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mgvData <span class="token operator">==</span> <span class="token string">"mgv/tradeSuccess"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          mor<span class="token punctuation">.</span>fillVolume <span class="token operator">-=</span> mor<span class="token punctuation">.</span>fillWants <span class="token operator">?</span> takerWants <span class="token punctuation">:</span> takerGives<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We move <code>sor</code> to the next offer. Note that the current state is inconsistent, since we have not yet updated <code>sor.offerDetails</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>313
314
315
316</pre></code>
          <pre>        <span class="token punctuation">(</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">getNextBest</span><span class="token punctuation">(</span>offerList<span class="token punctuation">,</span> mor<span class="token punctuation">,</span> offer<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span>tickSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>

        sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">.</span>offer<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Recursive call with the next offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>318
319</pre></code>
          <pre>        <span class="token function">internalMarketOrder</span><span class="token punctuation">(</span>offerList<span class="token punctuation">,</span> mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Restore <code>sor</code> values from before recursive call</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>321
322
323
324
325
326</pre></code>
          <pre>        sor<span class="token punctuation">.</span>takerWants <span class="token operator">=</span> takerWants<span class="token punctuation">;</span>
        sor<span class="token punctuation">.</span>takerGives <span class="token operator">=</span> takerGives<span class="token punctuation">;</span>
        sor<span class="token punctuation">.</span>offerId <span class="token operator">=</span> offerId<span class="token punctuation">;</span>
        sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offer<span class="token punctuation">;</span>
        sor<span class="token punctuation">.</span>offerDetail <span class="token operator">=</span> offerDetail<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>After an offer execution, we may run callbacks and increase the total penalty. As that part is common to market orders and cleaning, it lives in its own <code>postExecute</code> function.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>328
329</pre></code>
          <pre>        <span class="token function">postExecute</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> mgvData<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Market order end</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>331
332
333</pre></code>
          <pre>        Offer offer <span class="token operator">=</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">;</span>
        Bin bin <span class="token operator">=</span> offer<span class="token punctuation">.</span><span class="token function">bin</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span>tickSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the offer list is not empty, the best offer may need a pointer update and the current leaf must be stored:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>335</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sor<span class="token punctuation">.</span>offerId <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>offer.prev</code> is 0, we ended the market order right at the beginning of a bin, so no write is necessary.</p>
<p>This also explains why the update below is safe when a market takes 0 offers: necessarily at this point offer.prev() is 0, since we are looking at the best offer of the offer list.</p>
<p><strong>Warning</strong>: do not locally update offer.prev() before this point, or the test wil spuriously fail and the updated offer will never be written to storage.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>342
343
344
345
346</pre></code>
          <pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>offer<span class="token punctuation">.</span><span class="token function">prev</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">.</span>offer <span class="token operator">=</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">.</span><span class="token function">prev</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token builtin">int</span> index <span class="token operator">=</span> bin<span class="token punctuation">.</span><span class="token function">leafIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This write may not be necessary if the mor.leaf was just loaded in the last <code>getNextBest</code>, but it will be a hot storage write anyway (so not expensive).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>348
349
350</pre></code>
          <pre>          offerList<span class="token punctuation">.</span>leafs<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> mor<span class="token punctuation">.</span>leaf<span class="token punctuation">.</span><span class="token function">dirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="internalMarketOrder/liftReentrancy"></a>Now that the market order is over, we can lift the lock on the book. In the same operation we</p>
<ul>
<li>lift the reentrancy lock, and</li>
<li>update the storage</li>
</ul>
<p>so we are free from out of order storage writes.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>358
359
360</pre></code>
          <pre>        sor<span class="token punctuation">.</span>local <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        offerList<span class="token punctuation">.</span>local <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>payTakerMinusFees</code> keeps the fee in Mangrove, proportional to the amount purchased, and gives the rest to the taker</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>362
363
364
365
366</pre></code>
          <pre>        <span class="token function">payTakerMinusFees</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-cleaning">Cleaning</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Cleans multiple offers, i.e. executes them and remove them from the book if they fail, transferring the failure penalty as bounty to the caller. If an offer succeeds, the execution of that offer is reverted, it stays in the book, and no bounty is paid; The <code>cleanByImpersonation</code> function itself will not revert.</p>
<p>Its second argument is a <code>CleanTarget[]</code> with each <code>CleanTarget</code> identifying an offer to clean and the execution parameters that will make it fail. The return values are the number of successfully cleaned offers and the total bounty received.</p>
<p>Note that Mangrove won’t attempt to execute an offer if the values in a <code>CleanTarget</code> don’t match its offer. To distinguish between a non-executed clean and a fail clean (due to the offer itself not failing), you must inspect the log (see <code>MgvLib.sol</code>) or check the received bounty.</p>
<p>Any <code>taker</code> can be impersonated when cleaning because:</p>
<ul>
<li>The function reverts if the offer succeeds, reverting any token transfers.</li>
<li>After a <code>clean</code> where the offer has failed, all ERC20 token transfers have also been reverted – but the sender will still have received the bounty of the failing offers.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">cleanByImpersonation</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> MgvLib<span class="token punctuation">.</span>CleanTarget<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> targets<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> successes<span class="token punctuation">,</span> <span class="token builtin">uint</span> bounty<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">emit</span> <span class="token function">CleanStart</span><span class="token punctuation">(</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> taker<span class="token punctuation">,</span> targets<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> targets<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">bytes</span> <span class="token keyword">memory</span> encodedCall<span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
          MgvLib<span class="token punctuation">.</span>CleanTarget <span class="token keyword">calldata</span> target <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          encodedCall <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>internalCleanByImpersonation<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>olKey<span class="token punctuation">,</span> target<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span> target<span class="token punctuation">.</span>tick<span class="token punctuation">,</span> target<span class="token punctuation">.</span>gasreq<span class="token punctuation">,</span> target<span class="token punctuation">.</span>takerWants<span class="token punctuation">,</span> taker<span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token builtin">bytes</span> <span class="token keyword">memory</span> retdata<span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
          <span class="token builtin">bool</span> success<span class="token punctuation">;</span>
          <span class="token punctuation">(</span>success<span class="token punctuation">,</span> retdata<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>encodedCall<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        successes<span class="token operator">++</span><span class="token punctuation">;</span>

        <span class="token punctuation">{</span>
          <span class="token punctuation">(</span><span class="token builtin">uint</span> offerBounty<span class="token punctuation">)</span> <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>retdata<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          bounty <span class="token operator">+=</span> offerBounty<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token function">sendPenalty</span><span class="token punctuation">(</span>bounty<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">emit</span> <span class="token function">CleanComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">internalCleanByImpersonation</span><span class="token punctuation">(</span>
    OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> offerId<span class="token punctuation">,</span>
    Tick tick<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span>
    <span class="token builtin">address</span> taker
  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> bounty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>internalClean</code> must be used with a call (hence the <code>external</code> modifier) so its effect can be reverted. But a call from the outside would mean the bounty would get stuck in Mangrove.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>425
426
427
428
429
430
431
432
433
434
435
436
437
438</pre></code>
          <pre>      <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/clean/protected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">;</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>tick<span class="token punctuation">.</span><span class="token function">inRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/clean/tick/outOfRange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mor<span class="token punctuation">.</span>maxTick <span class="token operator">=</span> tick<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>takerWants <span class="token operator">&lt;=</span> MAX_SAFE_VOLUME<span class="token punctuation">,</span> <span class="token string">"mgv/clean/takerWants/tooBig"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mor<span class="token punctuation">.</span>fillVolume <span class="token operator">=</span> takerWants<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      mor<span class="token punctuation">.</span>taker <span class="token operator">=</span> taker<span class="token punctuation">;</span>
      mor<span class="token punctuation">.</span>fillWants <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Initialize single order struct.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>440
441
442
443
444
445
446
447
448</pre></code>
          <pre>      MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">;</span>
      sor<span class="token punctuation">.</span>olKey <span class="token operator">=</span> olKey<span class="token punctuation">;</span>
      OfferList <span class="token keyword">storage</span> offerList<span class="token punctuation">;</span>
      <span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">,</span> offerList<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_config</span><span class="token punctuation">(</span>olKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      sor<span class="token punctuation">.</span>offerId <span class="token operator">=</span> offerId<span class="token punctuation">;</span>
      OfferData <span class="token keyword">storage</span> offerData <span class="token operator">=</span> offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span>
      sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offerData<span class="token punctuation">.</span>offer<span class="token punctuation">;</span>
      sor<span class="token punctuation">.</span>offerDetail <span class="token operator">=</span> offerData<span class="token punctuation">.</span>detail<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>For the cleaning to start, the offer list needs to be both active and not currently protected from reentrancy.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>450
451
452
453</pre></code>
          <pre>      <span class="token function">activeOfferListOnly</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">require</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>offer<span class="token punctuation">.</span><span class="token function">isLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/clean/offerNotLive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We also check that <code>gasreq</code> is not worse than specified. A taker who does not care about <code>gasreq</code> can specify any amount larger than the maximum gasreq.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>455
456
457</pre></code>
          <pre>      <span class="token keyword">require</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">.</span><span class="token function">gasreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> gasreq<span class="token punctuation">,</span> <span class="token string">"mgv/clean/gasreqTooLow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>offer<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/clean/tickMismatch"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We start be enabling the reentrancy lock for this offer list.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>459
460
461
462</pre></code>
          <pre>      sor<span class="token punctuation">.</span>local <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      offerList<span class="token punctuation">.</span>local <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">;</span>

      <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>execute</code> attempts to execute the offer by calling its maker. <code>execute</code> may modify <code>mor</code> and <code>sor</code>. It is crucial that an error due to <code>taker</code> triggers a revert. That way, if <a href="#MgvOfferTaking/statusCodes"><code>mgvData</code></a> is not <code>&quot;mgv/tradeSuccess&quot;</code>, then the maker is at fault.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Post-execution, <code>sor.takerWants</code>/<code>sor.takerGives</code> reflect how much was sent/taken by the offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>465
466
467
468</pre></code>
          <pre>        <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> makerData<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> mgvData<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">execute</span><span class="token punctuation">(</span>offerList<span class="token punctuation">,</span> mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">require</span><span class="token punctuation">(</span>mgvData <span class="token operator">!=</span> <span class="token string">"mgv/tradeSuccess"</span><span class="token punctuation">,</span> <span class="token string">"mgv/clean/offerDidNotFail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In the market order, we were able to avoid stitching back offers after every <code>execute</code> since we knew a segment starting from the best offer would be consumed. Here, we cannot do this optimisation since the offer may be anywhere in the book. So we stitch together offers immediately after <code>execute</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>470
471</pre></code>
          <pre>        <span class="token punctuation">(</span>sor<span class="token punctuation">.</span>local<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">dislodgeOffer</span><span class="token punctuation">(</span>offerList<span class="token punctuation">,</span> olKey<span class="token punctuation">.</span>tickSpacing<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">bestBin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="internalCleans/liftReentrancy"></a> Now that the current clean is over, we can lift the lock on the book. In the same operation we</p>
<ul>
<li>lift the reentrancy lock, and</li>
<li>update the storage</li>
</ul>
<p>so we are free from out of order storage writes.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>479
480
481</pre></code>
          <pre>        sor<span class="token punctuation">.</span>local <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        offerList<span class="token punctuation">.</span>local <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>No fees are paid since offer execution failed.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>After an offer execution, we may run callbacks and increase the total penalty. As that part is common to market orders and cleans, it lives in its own <code>postExecute</code> function.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>485
486
487
488
489
490
491</pre></code>
          <pre>        <span class="token function">postExecute</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> mgvData<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      bounty <span class="token operator">=</span> mor<span class="token punctuation">.</span>totalPenalty<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-general-execution">General execution</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>During a market order or a clean, offers get executed. The following code takes care of executing a single offer with parameters given by a <code>SingleOrder</code> within a larger context given by a <code>MultiOrder</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-execute">Execute</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Execution of the offer will be attempted with volume limited by the offer’s advertised volume.
<strong>Warning</strong>: The caller must ensure that the price of the offer is low enough; This is not checked here.</p>
<p>Summary of the meaning of the return values:</p>
<ul>
<li><code>gasused</code> is the gas consumed by the execution</li>
<li><code>makerData</code> is the data returned after executing the offer</li>
<li><a id="MgvOfferTaking/internalStatusCodes"></a><code>internalMgvData</code> is a status code internal to <code>execute</code>. It can hold <a href="#MgvOfferTaking/statusCodes">any value that <code>mgvData</code> can hold</a>. Within <code>execute</code>, it can additionally hold the following values:</li>
<li><code>&quot;mgv/notEnoughGasForMakerTrade&quot;</code>: cannot give maker close enough to <code>gasreq</code>. Triggers a revert of the entire order.</li>
<li><code>&quot;mgv/takerTransferFail&quot;</code>: taker could not send olKey.inbound_tkn. Triggers a revert of the entire order.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>506
507
508
509
510
511
512
513
514</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span>OfferList <span class="token keyword">storage</span> offerList<span class="token punctuation">,</span> MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> makerData<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> internalMgvData<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token punctuation">{</span>
        <span class="token builtin">uint</span> fillVolume <span class="token operator">=</span> mor<span class="token punctuation">.</span>fillVolume<span class="token punctuation">;</span>
        <span class="token builtin">uint</span> offerGives <span class="token operator">=</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">.</span><span class="token function">gives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin">uint</span> offerWants <span class="token operator">=</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">.</span><span class="token function">wants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="MgvOfferTaking/computeVolume"></a> Volume requested depends on total gives (or wants) by taker. Let <code>volume = mor.fillWants ? sor.takerWants : sor.takerGives</code>. One can check that <code>volume &lt;= fillVolume</code> in all cases.</p>
<p>Example with <code>fillWants=true</code>: if <code>offerGives &lt; fillVolume</code> the first branch of the outer <code>if</code> sets <code>volume = offerGives</code> and we are done; otherwise the 1st branch of the inner if is taken and sets <code>volume = fillVolume</code> and we are done.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>518
519
520
521
522</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mor<span class="token punctuation">.</span>fillWants <span class="token operator">&amp;&amp;</span> offerGives <span class="token operator">&lt;=</span> fillVolume<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span>mor<span class="token punctuation">.</span>fillWants <span class="token operator">&amp;&amp;</span> offerWants <span class="token operator">&lt;=</span> fillVolume<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          sor<span class="token punctuation">.</span>takerWants <span class="token operator">=</span> offerGives<span class="token punctuation">;</span>
          sor<span class="token punctuation">.</span>takerGives <span class="token operator">=</span> offerWants<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>fillWants<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>While a possible <code>offer.wants()=0</code> is the maker’s responsibility, a small enough partial fill may round to 0, so we round up. It is immaterial but more fair to the maker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>524
525
526
527
528
529
530
531</pre></code>
          <pre>            sor<span class="token punctuation">.</span>takerGives <span class="token operator">=</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inboundFromOutboundUp</span><span class="token punctuation">(</span>fillVolume<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sor<span class="token punctuation">.</span>takerWants <span class="token operator">=</span> fillVolume<span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            sor<span class="token punctuation">.</span>takerWants <span class="token operator">=</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">outboundFromInbound</span><span class="token punctuation">(</span>fillVolume<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sor<span class="token punctuation">.</span>takerGives <span class="token operator">=</span> fillVolume<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The flashloan is executed by call to <code>flashloan</code>. If the call reverts, it means the maker failed to send back <code>sor.takerWants</code> units of <code>olKey.outbound_tkn</code> to the taker. Notes :</p>
<ul>
<li><code>msg.sender</code> is Mangrove itself in those calls – all operations related to the actual caller should be done outside of this call.</li>
<li>any spurious exception due to an error in Mangrove code will be falsely blamed on the Maker, and its provision for the offer will be unfairly taken away.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>536
537
538</pre></code>
          <pre>      <span class="token builtin">bool</span> success<span class="token punctuation">;</span>
      <span class="token builtin">bytes</span> <span class="token keyword">memory</span> retdata<span class="token punctuation">;</span>
      <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Clear fields that maker must not see.</p>
<p>NB: It should be more efficient to do this in <code>makerExecute</code> instead as we would not have to restore the fields afterwards.
However, for unknown reasons that solution consumes significantly more gas, so we do it here instead.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>543
544
545
546
547
548
549</pre></code>
          <pre>        Offer offer <span class="token operator">=</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">;</span>
        sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offer<span class="token punctuation">.</span><span class="token function">clearFieldsForMaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Local local <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
        sor<span class="token punctuation">.</span>local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">clearFieldsForMaker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">(</span>success<span class="token punctuation">,</span> retdata<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flashloan<span class="token punctuation">,</span> <span class="token punctuation">(</span>sor<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>taker<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Restore cleared fields</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>551
552
553
554</pre></code>
          <pre>        sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offer<span class="token punctuation">;</span>
        sor<span class="token punctuation">.</span>local <span class="token operator">=</span> local<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>success</code> is true: trade is complete</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>556</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In case of success, <code>retdata</code> encodes the gas used by the offer, and an arbitrary 256 bits word sent by the maker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>558</pre></code>
          <pre>        <span class="token punctuation">(</span>gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">)</span> <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>retdata<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>internalMgvData</code> indicates trade success</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>560
561</pre></code>
          <pre>        internalMgvData <span class="token operator">=</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"mgv/tradeSuccess"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If configured to do so, Mangrove notifies an external contract that a successful trade has taken place.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>563
564
565
566</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">IMgvMonitor</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">.</span><span class="token function">monitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifySuccess</span><span class="token punctuation">(</span>sor<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>taker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We update the totals in the multi order based on the adjusted <code>sor.takerWants</code>/<code>sor.takerGives</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>568
569
570
571
572</pre></code>
          <pre>        mor<span class="token punctuation">.</span>totalGot <span class="token operator">+=</span> sor<span class="token punctuation">.</span>takerWants<span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalGot <span class="token operator">>=</span> sor<span class="token punctuation">.</span>takerWants<span class="token punctuation">,</span> <span class="token string">"mgv/totalGot/overflow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mor<span class="token punctuation">.</span>totalGave <span class="token operator">+=</span> sor<span class="token punctuation">.</span>takerGives<span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalGave <span class="token operator">>=</span> sor<span class="token punctuation">.</span>takerGives<span class="token punctuation">,</span> <span class="token string">"mgv/totalGot/overflow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In case of failure, <code>retdata</code> encodes an <a href="#MgvOfferTaking/internalStatusCodes">internal status code</a>, the gas used by the offer, and an arbitrary 256 bits word sent by the maker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>574</pre></code>
          <pre>        <span class="token punctuation">(</span>internalMgvData<span class="token punctuation">,</span> gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">innerDecode</span><span class="token punctuation">(</span>retdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Note that in the literals returned are bytes32 (stack values), while the revert arguments are strings (memory pointers).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>576
577
578
579</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          internalMgvData <span class="token operator">==</span> <span class="token string">"mgv/makerRevert"</span> <span class="token operator">||</span> internalMgvData <span class="token operator">==</span> <span class="token string">"mgv/makerTransferFail"</span>
            <span class="token operator">||</span> internalMgvData <span class="token operator">==</span> <span class="token string">"mgv/makerReceiveFail"</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Update (an upper bound) on gasreq required for failing offers</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>581</pre></code>
          <pre>          mor<span class="token punctuation">.</span>gasreqForFailingOffers <span class="token operator">+=</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">.</span><span class="token function">gasreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If configured to do so, Mangrove notifies an external contract that a failed trade has taken place.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>583
584
585</pre></code>
          <pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">IMgvMonitor</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">.</span><span class="token function">monitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifyFail</span><span class="token punctuation">(</span>sor<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>taker<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>It is crucial that any error code which indicates an error caused by the taker triggers a revert, because functions that call <code>execute</code> consider that when <code>internalMgvData</code> is not <code>&quot;mgv/tradeSuccess&quot;</code>, then the maker should be blamed.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>587
588
589
590
591</pre></code>
          <pre>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>internalMgvData <span class="token operator">==</span> <span class="token string">"mgv/notEnoughGasForMakerTrade"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"mgv/notEnoughGasForMakerTrade"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>internalMgvData <span class="token operator">==</span> <span class="token string">"mgv/takerTransferFail"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"mgv/takerTransferFail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This code must be unreachable except if the call to flashloan went OOG and there is enough gas to revert here. <strong>Danger</strong>: if a well-crafted offer/maker offer list can force a revert of <code>flashloan</code>, Mangrove will be stuck.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>593
594
595
596</pre></code>
          <pre>          <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"mgv/swapError"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Delete the offer. The last argument indicates whether the offer should be stripped of its provision (yes if execution failed, no otherwise). We cannot partially strip an offer provision (for instance, remove only the penalty from a failing offer and leave the rest) since the provision associated with an offer is always deduced from the (gasprice,gasbase,gasreq) parameters and not stored independently. We delete offers whether the amount remaining on offer is &gt; density or not for the sake of uniformity (code is much simpler). We also expect prices to move often enough that the maker will want to update their offer anyway. To simulate leaving the remaining volume in the offer, the maker can program their <code>makerPosthook</code> to <code>updateOffer</code> and put the remaining volume back in.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>598
599
600
601
602
603</pre></code>
          <pre>      <span class="token function">dirtyDeleteOffer</span><span class="token punctuation">(</span>
        offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">,</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">,</span> internalMgvData <span class="token operator">!=</span> <span class="token string">"mgv/tradeSuccess"</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-flashloan">Flashloan</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Externally called by <code>execute</code>, flashloan lends money to the maker then calls <code>makerExecute</code> to run the maker liquidity fetching code. If <code>makerExecute</code> is unsuccessful, <code>flashloan</code> reverts (but the larger orderbook traversal will continue).</p>
<p>In detail:</p>
<ol>
<li>Flashloans <code>takerGives</code> units of <code>sor.olKey.inbound_tkn</code> from the taker to the maker and returns false if the loan fails.</li>
<li>Runs <code>offerDetail.maker</code>’s <code>execute</code> function.</li>
<li>Returns the result of the operations, with optional <code>makerData</code> to help the maker debug.</li>
</ol>
<p>Made virtual so tests can instrument the function.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>614
615
616
617
618
619</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">flashloan</span><span class="token punctuation">(</span>MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    virtual
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> makerData<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>flashloan</code> must be used with a call (hence the <code>external</code> modifier) so its effect can be reverted. But a call from the outside would be fatal.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>621</pre></code>
          <pre>      <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/flashloan/protected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The transfer taker -&gt; maker is in 2 steps. First, taker-&gt;mgv. Then
mgv-&gt;maker. With a direct taker-&gt;maker transfer, if one of taker/maker
is blacklisted, we can’t tell which one. We need to know which one:
if we incorrectly blame the taker, a blacklisted maker can block an offer list forever; if we incorrectly blame the maker, a blacklisted taker can unfairly make makers fail all the time. Of course we assume that Mangrove is not blacklisted. This 2-step transfer is incompatible with tokens that have transfer fees (more accurately, it uselessly incurs fees twice).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>626
627
628
629
630
631
632
633
634
635
636
637</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">transferTokenFrom</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span> taker<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sor<span class="token punctuation">.</span>takerGives<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">transferToken</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">.</span><span class="token function">maker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sor<span class="token punctuation">.</span>takerGives<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">(</span>gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">makerExecute</span><span class="token punctuation">(</span>sor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"mgv/makerReceiveFail"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"mgv/takerTransferFail"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-maker-execute">Maker Execute</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Called by <code>flashloan</code>, <code>makerExecute</code> runs the maker code and checks that it can safely send the desired assets to the taker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>640
641
642
643
644
645
646
647</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">makerExecute</span><span class="token punctuation">(</span>MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> makerData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">bytes</span> <span class="token keyword">memory</span> cd <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>IMaker<span class="token punctuation">.</span>makerExecute<span class="token punctuation">,</span> <span class="token punctuation">(</span>sor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token builtin">uint</span> gasreq <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">.</span><span class="token function">gasreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">address</span> maker <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">.</span><span class="token function">maker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">uint</span> oldGas <span class="token operator">=</span> <span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We let the maker pay for the overhead of checking remaining gas and making the call, as well as handling the return data (constant gas since only the first 32 bytes of return data are read). So the <code>require</code> below is just an approximation: if the overhead of (<code>require</code> + cost of <code>CALL</code>) is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span>, the maker will receive at worst <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>gasreq</mtext><mo>−</mo><mfrac><mrow><mn>63</mn><mi>h</mi></mrow><mn>64</mn></mfrac></mrow><annotation encoding="application/x-tex">\textrm{gasreq} - \frac{63h}{64}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gasreq</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.2251079999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> gas.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>oldGas <span class="token operator">-</span> oldGas <span class="token operator">/</span> <span class="token number">64</span> <span class="token operator">>=</span> gasreq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"mgv/notEnoughGasForMakerTrade"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token builtin">bool</span> callSuccess<span class="token punctuation">;</span>
      <span class="token punctuation">(</span>callSuccess<span class="token punctuation">,</span> makerData<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">controlledCall</span><span class="token punctuation">(</span>maker<span class="token punctuation">,</span> gasreq<span class="token punctuation">,</span> cd<span class="token punctuation">)</span><span class="token punctuation">;</span>

      gasused <span class="token operator">=</span> oldGas <span class="token operator">-</span> <span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>callSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"mgv/makerRevert"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span>gasused<span class="token punctuation">)</span><span class="token punctuation">,</span> makerData<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token builtin">bool</span> transferSuccess <span class="token operator">=</span> <span class="token function">transferTokenFrom</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span> maker<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sor<span class="token punctuation">.</span>takerWants<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transferSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"mgv/makerTransferFail"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span>gasused<span class="token punctuation">)</span><span class="token punctuation">,</span> makerData<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-post-execute">Post execute</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>At this point, we know an offer execution was attempted. After executing an offer (whether in a market order or in cleans), we</p>
<ol>
<li>Call the maker’s posthook and sum the total gas used.</li>
<li>If offer failed: sum total penalty due to msg.sender and give remainder to maker.</li>
</ol>
<p>Made virtual so tests can instrument it.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>677
678
679
680
681
682
683
684
685
686</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">postExecute</span><span class="token punctuation">(</span>
    MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span>
    MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> gasused<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> makerData<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> mgvData
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> virtual <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> gasreq <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">.</span><span class="token function">gasreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We are about to call back the maker, giving it its unused gas (<code>gasreq - gasused</code>). Since the gas used so far may exceed <code>gasreq</code>, we prevent underflow in the subtraction below by bounding <code>gasused</code> above with <code>gasreq</code>. We could have decided not to call back the maker at all when there is no gas left, but we do it for uniformity.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>gasused <span class="token operator">></span> gasreq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        gasused <span class="token operator">=</span> gasreq<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token punctuation">(</span><span class="token builtin">uint</span> posthookGas<span class="token punctuation">,</span> <span class="token builtin">bool</span> callSuccess<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> posthookData<span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token function">makerPosthook</span><span class="token punctuation">(</span>sor<span class="token punctuation">,</span> gasreq <span class="token operator">-</span> gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> mgvData<span class="token punctuation">)</span><span class="token punctuation">;</span>
      gasused <span class="token operator">=</span> gasused <span class="token operator">+</span> posthookGas<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>mgvData <span class="token operator">!=</span> <span class="token string">"mgv/tradeSuccess"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint</span> penalty <span class="token operator">=</span> <span class="token function">applyPenalty</span><span class="token punctuation">(</span>sor<span class="token punctuation">,</span> gasused<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mor<span class="token punctuation">.</span>totalPenalty <span class="token operator">+=</span> penalty<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>callSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">emit</span> <span class="token function">OfferFailWithPosthookData</span><span class="token punctuation">(</span>
            sor<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mor<span class="token punctuation">.</span>taker<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>takerWants<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>takerGives<span class="token punctuation">,</span> penalty<span class="token punctuation">,</span> mgvData<span class="token punctuation">,</span> posthookData
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">emit</span> <span class="token function">OfferFail</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mor<span class="token punctuation">.</span>taker<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>takerWants<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>takerGives<span class="token punctuation">,</span> penalty<span class="token punctuation">,</span> mgvData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>callSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">emit</span> <span class="token function">OfferSuccessWithPosthookData</span><span class="token punctuation">(</span>
            sor<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mor<span class="token punctuation">.</span>taker<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>takerWants<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>takerGives<span class="token punctuation">,</span> posthookData
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">emit</span> <span class="token function">OfferSuccess</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mor<span class="token punctuation">.</span>taker<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>takerWants<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>takerGives<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-maker-posthook">Maker Posthook</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>718
719
720
721
722
723
724
725
726
727
728
729</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">makerPosthook</span><span class="token punctuation">(</span>MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasLeft<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> makerData<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> mgvData<span class="token punctuation">)</span>
    <span class="token keyword">internal</span>
    virtual
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">,</span> <span class="token builtin">bool</span> callSuccess<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> posthookData<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">bytes</span> <span class="token keyword">memory</span> cd <span class="token operator">=</span>
        abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>IMaker<span class="token punctuation">.</span>makerPosthook<span class="token punctuation">,</span> <span class="token punctuation">(</span>sor<span class="token punctuation">,</span> MgvLib<span class="token punctuation">.</span><span class="token function">OrderResult</span><span class="token punctuation">(</span><span class="token punctuation">{</span>makerData<span class="token punctuation">:</span> makerData<span class="token punctuation">,</span> mgvData<span class="token punctuation">:</span> mgvData<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token builtin">address</span> maker <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">.</span><span class="token function">maker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token builtin">uint</span> oldGas <span class="token operator">=</span> <span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We let the maker pay for the overhead of checking remaining gas and making the call. So the <code>require</code> below is just an approximation: if the overhead of (<code>require</code> + cost of <code>CALL</code>) is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span>, the maker will receive at worst <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>gasreq</mtext><mo>−</mo><mfrac><mrow><mn>63</mn><mi>h</mi></mrow><mn>64</mn></mfrac></mrow><annotation encoding="application/x-tex">\textrm{gasreq} - \frac{63h}{64}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gasreq</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.2251079999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> gas.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>731
732
733
734
735
736
737
738
739
740</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>oldGas <span class="token operator">-</span> oldGas <span class="token operator">/</span> <span class="token number">64</span> <span class="token operator">>=</span> gasLeft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"mgv/notEnoughGasForMakerPosthook"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token punctuation">(</span>callSuccess<span class="token punctuation">,</span> posthookData<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">controlledCall</span><span class="token punctuation">(</span>maker<span class="token punctuation">,</span> gasLeft<span class="token punctuation">,</span> cd<span class="token punctuation">)</span><span class="token punctuation">;</span>

      gasused <span class="token operator">=</span> oldGas <span class="token operator">-</span> <span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvoffertaking.sol-controlledcall"><code>controlledCall</code></h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Calls an external function with controlled gas expense. A direct call of the form <code>(,bytes memory retdata) = maker.call{gas}(selector,...args)</code> enables a griefing attack: the maker uses half its gas to write in its memory, then reverts with that memory segment as argument. After a low-level call, solidity automatically copies <code>returndatasize</code> bytes of <code>returndata</code> into memory. So the total gas consumed to execute a failing offer could exceed <code>gasreq + offer_gasbase</code> where <code>n</code> is the number of failing offers. In case of success, we read the first 32 bytes of returndata (the signature of <code>makerExecute</code> is <code>bytes32</code>). Otherwise, for compatibility with most errors that bubble up from contract calls and Solidity’s <code>require</code>, we read 32 bytes of returndata starting from the 69th (4 bytes of method sig + 32 bytes of offset + 32 bytes of string length).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>743
744
745
746</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">controlledCall</span><span class="token punctuation">(</span><span class="token builtin">address</span> callee<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> cd<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">bytes32</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> retdata<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>if success, read returned bytes 1…32, otherwise read returned bytes 69…100.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>748
749
750
751
752
753
754</pre></code>
          <pre>      <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        success <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span>gasreq<span class="token punctuation">,</span> callee<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>cd<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mload</span><span class="token punctuation">(</span>cd<span class="token punctuation">)</span><span class="token punctuation">,</span> retdata<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
        data <span class="token operator">:=</span> <span class="token function">mload</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token function">iszero</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">)</span><span class="token punctuation">,</span> retdata<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-penalties">Penalties</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Offers are just promises. They can fail. Penalty provisioning discourages from failing too much: we ask makers to provision more ETH than the expected gas cost of executing their offer and penalize them according to wasted gas.</p>
<p>Under normal circumstances, we should expect to see bots with a profit expectation dry-running offers locally and executing <code>cleans</code> on failing offers, collecting the penalty. The result should be a mostly clean book for actual takers (i.e. a book with only successful offers).</p>
<p><strong>Incentive issue</strong>: if the gas price increases enough after an offer has been created, there may not be an immediately profitable way to remove the fake offers. In that case, we count on 3 factors to keep the book clean:</p>
<ol>
<li>Gas price eventually comes down.</li>
<li>Other market makers want to keep Mangrove attractive and maintain their offer flow.</li>
<li>Mangrove governance (who may collect a fee) wants to keep Mangrove attractive and maximize exchange volume.</li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>After an offer failed, part of its provision is given back to the maker and the rest is stored to be sent to the taker after the entire order completes. In <code>applyPenalty</code>, we <em>only</em> credit the maker with its excess provision. So it looks like the maker is gaining something. In fact they’re just getting back a fraction of what they provisioned earlier.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Penalty application summary:</p>
<ul>
<li>If the transaction was a success, we entirely refund the maker and send nothing to the taker.</li>
<li>Otherwise, the maker loses the cost of <code>gasused + offer_gasbase</code> gas. The gas price is estimated by <code>gasprice</code>.</li>
<li>To create the offer, the maker had to provision for <code>gasreq + offer_gasbase</code> gas at a price of <code>offerDetail.gasprice</code>.</li>
<li>We do not consider the tx.gasprice.</li>
<li><code>offerDetail.gasbase</code> and <code>offerDetail.gasprice</code> are the values of Mangrove parameters <code>config.offer_gasbase</code> and <code>config.gasprice</code> when the offer was created. Without caching those values, the provision set aside could end up insufficient to reimburse the maker (or to retribute the taker).</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>776
777
778
779
780
781</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">applyPenalty</span><span class="token punctuation">(</span>MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasused<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> gasreq <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">.</span><span class="token function">gasreq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token builtin">uint</span> provision <span class="token operator">=</span> <span class="token number">1e6</span> <span class="token operator">*</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">.</span><span class="token function">gasprice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>gasreq <span class="token operator">+</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">.</span><span class="token function">offer_gasbase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We set <code>gasused = min(gasused,gasreq)</code> since <code>gasreq &lt; gasused</code> is possible e.g. with <code>gasreq = 0</code> (all calls consume nonzero gas).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>783
784
785
786</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>gasused <span class="token operator">></span> gasreq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        gasused <span class="token operator">=</span> gasreq<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>As an invariant, <code>applyPenalty</code> is only called when <code>mgvData</code> is in <code>[&quot;mgv/makerRevert&quot;,&quot;mgv/makerTransferFail&quot;,&quot;mgv/makerReceiveFail&quot;]</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>788
789
790
791
792
793</pre></code>
          <pre>      <span class="token builtin">uint</span> penalty <span class="token operator">=</span> <span class="token number">1e6</span> <span class="token operator">*</span> sor<span class="token punctuation">.</span>global<span class="token punctuation">.</span><span class="token function">gasprice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>gasused <span class="token operator">+</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">offer_gasbase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>penalty <span class="token operator">></span> provision<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        penalty <span class="token operator">=</span> provision<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Here we write to storage the new maker balance. This occurs <em>after</em> possible reentrant calls. How do we know we’re not crediting twice the same amounts? Because the <code>offer</code>’s provision was set to 0 in storage (through <code>dirtyDeleteOffer</code>) before the reentrant calls. In this function, we are working with cached copies of the offer as it was before it was consumed.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>795
796
797
798
799
800
801
802
803
804
805
806
807
808
809</pre></code>
          <pre>      <span class="token function">creditWei</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">.</span><span class="token function">maker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> provision <span class="token operator">-</span> penalty<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> penalty<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">sendPenalty</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span><span class="token builtin">bool</span> noRevert<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span>call<span class="token punctuation">{</span>value<span class="token punctuation">:</span> amount<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">require</span><span class="token punctuation">(</span>noRevert<span class="token punctuation">,</span> <span class="token string">"mgv/sendPenaltyReverted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Post-trade, <code>payTakerMinusFees</code> sends what’s due to the taker and keeps the rest (the fees). Routing through the Mangrove like that also deals with blacklisting issues (separates the maker-blacklisted and the taker-blacklisted cases).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>811
812
813
814
815
816
817
818</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">payTakerMinusFees</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> MgvLib<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> concreteFee <span class="token operator">=</span> <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalGot <span class="token operator">*</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">fee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span>_000<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>concreteFee <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mor<span class="token punctuation">.</span>totalGot <span class="token operator">-=</span> concreteFee<span class="token punctuation">;</span>
        mor<span class="token punctuation">.</span>feePaid <span class="token operator">=</span> concreteFee<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalGot <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>It should be statically provable that this transfer cannot return false under well-behaved ERC20s and a non-blacklisted, non-0 target, if governance does not call withdrawERC20 during order execution, unless the caller set a gas limit which precisely makes <code>transferToken</code> go OOG but retains enough gas to revert here.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>820
821
822
823
824</pre></code>
          <pre>        <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">transferToken</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>olKey<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>taker<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>totalGot<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/MgvFailToPayTaker"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertaking.sol-misc.-functions">Misc. functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Regular solidity reverts prepend the string argument with a <a href="https://docs.soliditylang.org/en/v0.7.6/control-structures.html#revert">function signature</a>. Since we wish to transfer data through a revert, the <code>innerRevert</code> function does a low-level revert with only the required data. <code>innerCode</code> decodes this data.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>828
829</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">innerDecode</span><span class="token punctuation">(</span><span class="token builtin">bytes</span> <span class="token keyword">memory</span> data<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes32</span> mgvData<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasused<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> makerData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>data</code> pointer is of the form <code>[mgvData,gasused,makerData]</code> where each array element is contiguous and has size 256 bits.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>831
832
833
834
835
836
837
838</pre></code>
          <pre>      <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mgvData <span class="token operator">:=</span> <span class="token function">mload</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        gasused <span class="token operator">:=</span> <span class="token function">mload</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        makerData <span class="token operator">:=</span> <span class="token function">mload</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="MgvOfferTaking/innerRevert"></a><code>innerRevert</code> reverts a raw triple of values to be interpreted by <code>innerDecode</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>840
841
842
843
844
845
846
847</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> data<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">revert</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvoffertakingwithpermit.sol" class="left filebreak">MgvOfferTakingWithPermit.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7
8</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.10</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@mgv/src/core/MgvLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvOfferTaking<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvOfferTaking.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>TickTreeLib<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/TickTreeLib.sol"</span><span class="token punctuation">;</span>

abstract <span class="token keyword">contract</span> <span class="token class-name">MgvOfferTakingWithPermit</span> <span class="token keyword">is</span> MgvOfferTaking <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>Since DOMAIN_SEPARATOR is immutable, it cannot use MgvAppendix to provide an accessor (because the value will come from code, not from storage), so we generate the accessor here.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>10
11
12</pre></code>
          <pre>  <span class="token builtin">bytes32</span> <span class="token keyword">public</span> immutable DOMAIN_SEPARATOR<span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">string</span> <span class="token keyword">memory</span> contractName<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Initialize <a href="https://eips.ethereum.org/EIPS/eip-712">EIP712</a> <code>DOMAIN_SEPARATOR</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>14
15
16
17
18
19
20
21
22
23
24</pre></code>
          <pre>    DOMAIN_SEPARATOR <span class="token operator">=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>
      abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>
        <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token string">"EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>contractName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        block<span class="token punctuation">.</span>chainid<span class="token punctuation">,</span>
        <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertakingwithpermit.sol-delegation-public-functions">Delegation public functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Adapted from <a href="https://github.com/Uniswap/uniswap-v2-core/blob/55ae25109b7918565867e5c39f1e84b7edd19b2a/contracts/UniswapV2ERC20.sol#L81">Uniswap v2 contract</a></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">permit</span><span class="token punctuation">(</span>
    <span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span>
    <span class="token builtin">address</span> owner<span class="token punctuation">,</span>
    <span class="token builtin">address</span> spender<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> value<span class="token punctuation">,</span>
    <span class="token builtin">uint</span> deadline<span class="token punctuation">,</span>
    <span class="token builtin">uint8</span> v<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> r<span class="token punctuation">,</span>
    <span class="token builtin">bytes32</span> s
  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>deadline <span class="token operator">>=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span> <span class="token string">"mgv/permit/expired"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token builtin">uint</span> nonce <span class="token operator">=</span> _nonces<span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token builtin">bytes32</span> digest <span class="token operator">=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>
        abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
          <span class="token string">"\x19\x01"</span><span class="token punctuation">,</span>
          DOMAIN_SEPARATOR<span class="token punctuation">,</span>
          <span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>_PERMIT_TYPEHASH<span class="token punctuation">,</span> outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> value<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> deadline<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">address</span> recoveredAddress <span class="token operator">=</span> <span class="token function">ecrecover</span><span class="token punctuation">(</span>digest<span class="token punctuation">,</span> v<span class="token punctuation">,</span> r<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>recoveredAddress <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> recoveredAddress <span class="token operator">==</span> owner<span class="token punctuation">,</span> <span class="token string">"mgv/permit/invalidSignature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      _allowance<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">[</span>spender<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">Approval</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">approve</span><span class="token punctuation">(</span><span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> spender<span class="token punctuation">,</span> <span class="token builtin">uint</span> value<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      _allowance<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">[</span>spender<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">Approval</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The delegate version of <code>marketOrder</code> is <code>marketOrderFor</code>, which takes a <code>taker</code> address as additional argument. Penalties incurred by failed offers will still be sent to <code>msg.sender</code>, but exchanged amounts will be transferred from and to the <code>taker</code>. If the <code>msg.sender</code>’s allowance for the given <code>outbound_tkn</code>,<code>inbound_tkn</code> and <code>taker</code> are strictly less than the total amount eventually spent by <code>taker</code>, the call will fail.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><em>Note:</em> <code>marketOrderFor</code> and <code>cleanByImpersonation</code> may emit ERC20 <code>Transfer</code> events of value 0 from <code>taker</code>, but that’s already the case with common ERC20 implementations.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">marketOrderForByVolume</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span> <span class="token builtin">bool</span> fillWants<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> takerGot<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerGave<span class="token punctuation">,</span> <span class="token builtin">uint</span> bounty<span class="token punctuation">,</span> <span class="token builtin">uint</span> feePaid<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span>takerWants<span class="token punctuation">)</span> <span class="token operator">==</span> takerWants<span class="token punctuation">,</span> <span class="token string">"mgv/mOrder/takerWants/160bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span>takerGives<span class="token punctuation">)</span> <span class="token operator">==</span> takerGives<span class="token punctuation">,</span> <span class="token string">"mgv/mOrder/takerGives/160bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">uint</span> fillVolume <span class="token operator">=</span> fillWants <span class="token operator">?</span> takerWants <span class="token punctuation">:</span> takerGives<span class="token punctuation">;</span>
      Tick tick <span class="token operator">=</span> TickLib<span class="token punctuation">.</span><span class="token function">tickFromVolumes</span><span class="token punctuation">(</span>takerGives<span class="token punctuation">,</span> takerWants<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">marketOrderForByTick</span><span class="token punctuation">(</span>olKey<span class="token punctuation">,</span> tick<span class="token punctuation">,</span> fillVolume<span class="token punctuation">,</span> fillWants<span class="token punctuation">,</span> taker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">marketOrderForByTick</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> Tick maxTick<span class="token punctuation">,</span> <span class="token builtin">uint</span> fillVolume<span class="token punctuation">,</span> <span class="token builtin">bool</span> fillWants<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span>
    <span class="token keyword">public</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> takerGot<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerGave<span class="token punctuation">,</span> <span class="token builtin">uint</span> bounty<span class="token punctuation">,</span> <span class="token builtin">uint</span> feePaid<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>takerGot<span class="token punctuation">,</span> takerGave<span class="token punctuation">,</span> bounty<span class="token punctuation">,</span> feePaid<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">generalMarketOrder</span><span class="token punctuation">(</span>olKey<span class="token punctuation">,</span> maxTick<span class="token punctuation">,</span> fillVolume<span class="token punctuation">,</span> fillWants<span class="token punctuation">,</span> taker<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The sender’s allowance is verified after the order complete so that <code>takerGave</code> rather than <code>takerGives</code> is checked against the allowance. The former may be lower.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>89
90
91
92</pre></code>
          <pre>      <span class="token function">deductSenderAllowance</span><span class="token punctuation">(</span>olKey<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span> olKey<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span> taker<span class="token punctuation">,</span> takerGave<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvoffertakingwithpermit.sol-misc.-low-level-functions-0">Misc. low-level functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Used by <code>*For</code> functions, it both checks that <code>msg.sender</code> was allowed to use the taker’s funds, and decreases the former’s allowance.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>96
97
98
99
100
101
102
103
104
105
106</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">deductSenderAllowance</span><span class="token punctuation">(</span><span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> owner<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">storage</span> curriedAllow <span class="token operator">=</span> _allowance<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token builtin">uint</span> allowed <span class="token operator">=</span> curriedAllow<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>allowed <span class="token operator">>=</span> amount<span class="token punctuation">,</span> <span class="token string">"mgv/lowAllowance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      curriedAllow<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> allowed <span class="token operator">-</span> amount<span class="token punctuation">;</span>

      <span class="token keyword">emit</span> <span class="token function">Approval</span><span class="token punctuation">(</span>outbound_tkn<span class="token punctuation">,</span> inbound_tkn<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> allowed <span class="token operator">-</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvgovernable.sol" class="left filebreak">MgvGovernable.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.10</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvLib<span class="token punctuation">,</span> IMgvMonitor<span class="token punctuation">,</span> IERC20<span class="token punctuation">,</span> Leaf<span class="token punctuation">,</span> Field<span class="token punctuation">,</span> Density<span class="token punctuation">,</span> DensityLib<span class="token punctuation">,</span> OLKey<span class="token punctuation">,</span> DirtyFieldLib<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"@mgv/src/core/MgvCommon.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Contains governance functions, to reduce Mangrove contract size</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>8</pre></code>
          <pre><span class="token keyword">contract</span> <span class="token class-name">MgvGovernable</span> <span class="token keyword">is</span> MgvCommon <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvgovernable.sol-authonly-check"><code>authOnly</code> check</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>10
11
12
13
14
15
16</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">view</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> governance <span class="token operator">||</span> msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">||</span> governance <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/unauthorized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvgovernable.sol-transfer-erc20-tokens-to-governance.">Transfer ERC20 tokens to governance.</h2>
<p>If this function is called while an order is executing, the reentrancy may prevent a taker from receiving their tokens. This is fine as the order execution will then fail, and the tx will revert. So the most a malicious governance can do is render Mangrove unusable.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>21
22
23
24
25</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">withdrawERC20</span><span class="token punctuation">(</span><span class="token builtin">address</span> tokenAddress<span class="token punctuation">,</span> <span class="token builtin">uint</span> value<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token function">transferToken</span><span class="token punctuation">(</span>tokenAddress<span class="token punctuation">,</span> governance<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/withdrawERC20Fail"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvgovernable.sol-set-configuration-and-mangrove-state">Set configuration and Mangrove state</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvgovernable.sol-locals">Locals</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>active</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>30
31
32
33</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">activate</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">uint</span> fee<span class="token punctuation">,</span> <span class="token builtin">uint</span> density96X32<span class="token punctuation">,</span> <span class="token builtin">uint</span> offer_gasbase<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">bytes32</span> olKeyHash <span class="token operator">=</span> olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>save hash-&gt;key mapping</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>35
36</pre></code>
          <pre>      _olKeys<span class="token punctuation">[</span>olKeyHash<span class="token punctuation">]</span> <span class="token operator">=</span> olKey<span class="token punctuation">;</span>
      OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKeyHash<span class="token punctuation">]</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>activate market</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>38
39
40
41
42</pre></code>
          <pre>      offerList<span class="token punctuation">.</span>local <span class="token operator">=</span> offerList<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">SetActive</span><span class="token punctuation">(</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> olKey<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span> olKey<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span> olKey<span class="token punctuation">.</span>tickSpacing<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setFee</span><span class="token punctuation">(</span>olKey<span class="token punctuation">,</span> fee<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setDensity96X32</span><span class="token punctuation">(</span>olKey<span class="token punctuation">,</span> density96X32<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setGasbase</span><span class="token punctuation">(</span>olKey<span class="token punctuation">,</span> offer_gasbase<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>warm level1s</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>44
45
46
47
48
49
50
51
52
53
54
55</pre></code>
          <pre>      offerList<span class="token punctuation">.</span>level1s<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> DirtyFieldLib<span class="token punctuation">.</span>DIRTY_EMPTY<span class="token punctuation">;</span>
      offerList<span class="token punctuation">.</span>level1s<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> DirtyFieldLib<span class="token punctuation">.</span>DIRTY_EMPTY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">deactivate</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    offerList<span class="token punctuation">.</span>local <span class="token operator">=</span> offerList<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">active</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">emit</span> <span class="token function">SetActive</span><span class="token punctuation">(</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> olKey<span class="token punctuation">.</span>outbound_tkn<span class="token punctuation">,</span> olKey<span class="token punctuation">.</span>inbound_tkn<span class="token punctuation">,</span> olKey<span class="token punctuation">.</span>tickSpacing<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>fee</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>57
58
59</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setFee</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">uint</span> fee<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>fee</code> is in basis points, i.e. in percents of a percent.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>61
62
63
64
65
66
67</pre></code>
          <pre>      <span class="token keyword">require</span><span class="token punctuation">(</span>LocalLib<span class="token punctuation">.</span><span class="token function">fee_check</span><span class="token punctuation">(</span>fee<span class="token punctuation">)</span><span class="token punctuation">,</span> LocalLib<span class="token punctuation">.</span>fee_size_error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      offerList<span class="token punctuation">.</span>local <span class="token operator">=</span> offerList<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">fee</span><span class="token punctuation">(</span>fee<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">SetFee</span><span class="token punctuation">(</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fee<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>density</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Useless if <code>global.useOracle != 0</code> and oracle returns a valid density.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Density is given as a 96.32 fixed point number. It will be stored as a 9-bit float and be approximated towards 0. The maximum error is 20%. See <code>DensityLib</code> for more information.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>71
72
73
74</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setDensity96X32</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">uint</span> density96X32<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>76</pre></code>
          <pre>      OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Checking the size of <code>density</code> is necessary to prevent overflow before storing density as a float.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>78
79
80
81
82
83
84</pre></code>
          <pre>      <span class="token keyword">require</span><span class="token punctuation">(</span>DensityLib<span class="token punctuation">.</span><span class="token function">checkDensity96X32</span><span class="token punctuation">(</span>density96X32<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/config/density96X32/wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      offerList<span class="token punctuation">.</span>local <span class="token operator">=</span> offerList<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">densityFrom96X32</span><span class="token punctuation">(</span>density96X32<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">SetDensity96X32</span><span class="token punctuation">(</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> density96X32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>gasbase</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>86
87
88</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setGasbase</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">uint</span> offer_gasbase<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Checking the size of <code>offer_gasbase</code> is necessary to prevent a) data loss when copied to an <code>OfferDetail</code> struct, and b) overflow when used in calculations.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>90</pre></code>
          <pre>      <span class="token keyword">require</span><span class="token punctuation">(</span>LocalLib<span class="token punctuation">.</span><span class="token function">kilo_offer_gasbase_check</span><span class="token punctuation">(</span>offer_gasbase <span class="token operator">/</span> <span class="token number">1e3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> LocalLib<span class="token punctuation">.</span>kilo_offer_gasbase_size_error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>require(uint24(offer_gasbase) == offer_gasbase, “mgv/config/offer_gasbase/24bits”);</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>93
94
95
96
97
98</pre></code>
          <pre>      OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      offerList<span class="token punctuation">.</span>local <span class="token operator">=</span> offerList<span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">offer_gasbase</span><span class="token punctuation">(</span>offer_gasbase<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">SetGasbase</span><span class="token punctuation">(</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offer_gasbase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="mgvgovernable.sol-globals">Globals</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>kill</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>101
102
103
104
105
106
107
108</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      internal_global <span class="token operator">=</span> internal_global<span class="token punctuation">.</span><span class="token function">dead</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">Kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>gasprice</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Useless if <code>global.useOracle is != 0</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>111
112
113
114
115</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setGasprice</span><span class="token punctuation">(</span><span class="token builtin">uint</span> gasprice<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>GlobalLib<span class="token punctuation">.</span><span class="token function">gasprice_check</span><span class="token punctuation">(</span>gasprice<span class="token punctuation">)</span><span class="token punctuation">,</span> GlobalLib<span class="token punctuation">.</span>gasprice_size_error<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>117
118
119
120
121
122</pre></code>
          <pre>
      internal_global <span class="token operator">=</span> internal_global<span class="token punctuation">.</span><span class="token function">gasprice</span><span class="token punctuation">(</span>gasprice<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">SetGasprice</span><span class="token punctuation">(</span>gasprice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>gasmax</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>124
125
126</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setGasmax</span><span class="token punctuation">(</span><span class="token builtin">uint</span> gasmax<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since any new <code>gasreq</code> is bounded above by <code>config.gasmax</code>, this check implies that all offers’ <code>gasreq</code> is 24 bits wide at most.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>128</pre></code>
          <pre>      <span class="token keyword">require</span><span class="token punctuation">(</span>GlobalLib<span class="token punctuation">.</span><span class="token function">gasmax_check</span><span class="token punctuation">(</span>gasmax<span class="token punctuation">)</span><span class="token punctuation">,</span> GlobalLib<span class="token punctuation">.</span>gasmax_size_error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>130
131
132
133
134</pre></code>
          <pre>      internal_global <span class="token operator">=</span> internal_global<span class="token punctuation">.</span><span class="token function">gasmax</span><span class="token punctuation">(</span>gasmax<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">SetGasmax</span><span class="token punctuation">(</span>gasmax<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>maxRecursionDepth</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>136
137
138
139
140
141
142
143
144</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setMaxRecursionDepth</span><span class="token punctuation">(</span><span class="token builtin">uint</span> maxRecursionDepth<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>GlobalLib<span class="token punctuation">.</span><span class="token function">maxRecursionDepth_check</span><span class="token punctuation">(</span>maxRecursionDepth<span class="token punctuation">)</span><span class="token punctuation">,</span> GlobalLib<span class="token punctuation">.</span>maxRecursionDepth_size_error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      internal_global <span class="token operator">=</span> internal_global<span class="token punctuation">.</span><span class="token function">maxRecursionDepth</span><span class="token punctuation">(</span>maxRecursionDepth<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">SetMaxRecursionDepth</span><span class="token punctuation">(</span>maxRecursionDepth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>maxGasreqForFailingOffers</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>146
147
148
149
150
151
152
153
154
155
156
157</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setMaxGasreqForFailingOffers</span><span class="token punctuation">(</span><span class="token builtin">uint</span> maxGasreqForFailingOffers<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>
        GlobalLib<span class="token punctuation">.</span><span class="token function">maxGasreqForFailingOffers_check</span><span class="token punctuation">(</span>maxGasreqForFailingOffers<span class="token punctuation">)</span><span class="token punctuation">,</span>
        GlobalLib<span class="token punctuation">.</span>maxGasreqForFailingOffers_size_error
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      internal_global <span class="token operator">=</span> internal_global<span class="token punctuation">.</span><span class="token function">maxGasreqForFailingOffers</span><span class="token punctuation">(</span>maxGasreqForFailingOffers<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">SetMaxGasreqForFailingOffers</span><span class="token punctuation">(</span>maxGasreqForFailingOffers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>governance</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>159
160
161
162
163
164
165
166
167</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setGovernance</span><span class="token punctuation">(</span><span class="token builtin">address</span> governanceAddress<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>governanceAddress <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/config/gov/not0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      governance <span class="token operator">=</span> governanceAddress<span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">SetGovernance</span><span class="token punctuation">(</span>governanceAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>monitor</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>169
170
171
172
173
174
175
176</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setMonitor</span><span class="token punctuation">(</span><span class="token builtin">address</span> monitor<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      internal_global <span class="token operator">=</span> internal_global<span class="token punctuation">.</span><span class="token function">monitor</span><span class="token punctuation">(</span>monitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">SetMonitor</span><span class="token punctuation">(</span>monitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>useOracle</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>178
179
180
181
182
183
184
185</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setUseOracle</span><span class="token punctuation">(</span><span class="token builtin">bool</span> useOracle<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      internal_global <span class="token operator">=</span> internal_global<span class="token punctuation">.</span><span class="token function">useOracle</span><span class="token punctuation">(</span>useOracle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">SetUseOracle</span><span class="token punctuation">(</span>useOracle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>notify</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>187
188
189
190
191
192
193
194</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setNotify</span><span class="token punctuation">(</span><span class="token builtin">bool</span> notify<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      internal_global <span class="token operator">=</span> internal_global<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>notify<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">emit</span> <span class="token function">SetNotify</span><span class="token punctuation">(</span>notify<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvview.sol" class="left filebreak">MgvView.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.10</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@mgv/src/core/MgvLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"@mgv/src/core/MgvCommon.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Contains view functions, to reduce Mangrove contract size</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>8</pre></code>
          <pre><span class="token keyword">contract</span> <span class="token class-name">MgvView</span> <span class="token keyword">is</span> MgvCommon <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvview.sol-configuration-reads">Configuration Reads</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Reading the configuration for an offer list involves reading the config global to all offer lists and the local one. In addition, a global parameter (<code>gasprice</code>) and a local one (<code>density</code>) may be read from the oracle.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>11
12
13
14
15
16
17</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">config</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Global _global<span class="token punctuation">,</span> Local _local<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>_global<span class="token punctuation">,</span> _local<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_config</span><span class="token punctuation">(</span>olKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>_local<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Sugar for getting only local config</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>19
20
21
22
23
24
25</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">local</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Local _local<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token punctuation">,</span> _local<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_config</span><span class="token punctuation">(</span>olKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>_local<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Reading the global configuration. In addition, a parameter (<code>gasprice</code>) may be read from the oracle.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>27
28
29
30
31
32
33
34
35
36
37
38</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">global</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Global _global<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>_global<span class="token punctuation">,</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_config</span><span class="token punctuation">(</span><span class="token function">OLKey</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span> maker<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> balance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      balance <span class="token operator">=</span> _balanceOf<span class="token punctuation">[</span>maker<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvview.sol-tick-tree-view-functions">Tick tree view functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">leafs</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">int</span> index<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Leaf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>offerList<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> offerList<span class="token punctuation">.</span>leafs<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">level3s</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">int</span> index<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      Local _local <span class="token operator">=</span> offerList<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>_local<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>_local<span class="token punctuation">.</span><span class="token function">bestBin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">level3Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _local<span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> offerList<span class="token punctuation">.</span>level3s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">level2s</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">int</span> index<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      Local _local <span class="token operator">=</span> offerList<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>_local<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>_local<span class="token punctuation">.</span><span class="token function">bestBin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">level2Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _local<span class="token punctuation">.</span><span class="token function">level2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> offerList<span class="token punctuation">.</span>level2s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">level1s</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">int</span> index<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      Local _local <span class="token operator">=</span> offerList<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>_local<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>_local<span class="token punctuation">.</span><span class="token function">bestBin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">level1Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _local<span class="token punctuation">.</span><span class="token function">level1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> offerList<span class="token punctuation">.</span>level1s<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">root</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      Local _local <span class="token operator">=</span> offerList<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>_local<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> _local<span class="token punctuation">.</span><span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvview.sol-offer-list-view-functions">Offer list view functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Function to check whether given an offer list is locked. Contrary to other offer list view functions, this does not revert if the offer list is locked.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>103
104
105
106
107
108</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">locked</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>local<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Convenience function to get best offer of the given offerList</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>110
111
112
113
114
115
116
117
118</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">best</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> offerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      Local _local <span class="token operator">=</span> offerList<span class="token punctuation">.</span>local<span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>_local<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> offerList<span class="token punctuation">.</span>leafs<span class="token punctuation">[</span>_local<span class="token punctuation">.</span><span class="token function">bestBin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">leafIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bestOfferId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Get the olKey that corresponds to a hash, only works for offer lists that have been activated &gt; 0 times</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>120
121
122
123
124
125</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">olKeys</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> olKeyHash<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      olKey <span class="token operator">=</span> _olKeys<span class="token punctuation">[</span>olKeyHash<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="mgvview.sol-offer-view-functions">Offer view functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Get an offer in packed format</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>129
130
131
132
133
134
135
136</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">offers</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">uint</span> offerId<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Offer offer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>offerList<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">.</span>offer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Get an offer detail in packed format</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>138
139
140
141
142
143
144
145</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">offerDetails</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">uint</span> offerId<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>OfferDetail offerDetail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>offerList<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">.</span>detail<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Get both offer and offer detail in packed format</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>147
148
149
150
151
152
153
154
155</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">offerData</span><span class="token punctuation">(</span>OLKey <span class="token keyword">memory</span> olKey<span class="token punctuation">,</span> <span class="token builtin">uint</span> offerId<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Offer offer<span class="token punctuation">,</span> OfferDetail offerDetail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      OfferList <span class="token keyword">storage</span> offerList <span class="token operator">=</span> offerLists<span class="token punctuation">[</span>olKey<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">unlockedOfferListOnly</span><span class="token punctuation">(</span>offerList<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
      OfferData <span class="token keyword">storage</span> _offerData <span class="token operator">=</span> offerList<span class="token punctuation">.</span>offerData<span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>_offerData<span class="token punctuation">.</span>offer<span class="token punctuation">,</span> _offerData<span class="token punctuation">.</span>detail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Permit-related view functions</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173</pre></code>
          <pre>
  <span class="token keyword">function</span> <span class="token function">allowance</span><span class="token punctuation">(</span><span class="token builtin">address</span> outbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> inbound_tkn<span class="token punctuation">,</span> <span class="token builtin">address</span> owner<span class="token punctuation">,</span> <span class="token builtin">address</span> spender<span class="token punctuation">)</span>
    <span class="token keyword">external</span>
    <span class="token keyword">view</span>
    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amount<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      amount <span class="token operator">=</span> _allowance<span class="token punctuation">[</span>outbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>inbound_tkn<span class="token punctuation">]</span><span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">[</span>spender<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">nonces</span><span class="token punctuation">(</span><span class="token builtin">address</span> owner<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> nonce<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      nonce <span class="token operator">=</span> _nonces<span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Note: the accessor for <code>DOMAIN_SEPARATOR</code> is defined in <code>MgvOfferTakingWithPermit</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>175
176
177
178
179
180</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">PERMIT_TYPEHASH</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> _PERMIT_TYPEHASH<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mgvappendix.sol" class="left filebreak">MgvAppendix.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.10</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@mgv/src/core/MgvLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvView<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/src/core/MgvView.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvGovernable<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/src/core/MgvGovernable.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>MgvAppendix</code> contract contains Mangrove functions related to:</p>
<ul>
<li>Getters (view functions)</li>
<li>Governance functions</li>
</ul>
<p>Due to bytecode size limits, not all Mangrove code can reside at the address of Mangrove. So when constructed, Mangrove creates a <code>MgvAppendix</code> instance and sets up a fallback to that instance when receiving an unknown function selector.</p>
<p>The functions moved to <code>MgvAppendix</code> have been selected because they are less gas-sensitive than core Mangrove functionality.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>15</pre></code>
          <pre><span class="token keyword">contract</span> <span class="token class-name">MgvAppendix</span> <span class="token keyword">is</span> MgvView<span class="token punctuation">,</span> MgvGovernable <span class="token punctuation">{</span><span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="mangrove.sol" class="left filebreak">Mangrove.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7
8
9
10</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.10</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@mgv/src/core/MgvLib.sol"</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvOfferMaking<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvOfferMaking.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvOfferTakingWithPermit<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./MgvOfferTakingWithPermit.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvAppendix<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/src/core/MgvAppendix.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>MgvGovernable<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/src/core/MgvGovernable.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="Mangrove"></a> The <code>Mangrove</code> contract inherits both the maker and taker functionality. It also deploys <code>MgvAppendix</code> when constructed.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>12
13
14
15
16
17
18
19
20</pre></code>
          <pre><span class="token keyword">contract</span> <span class="token class-name">Mangrove</span> <span class="token keyword">is</span> MgvOfferTakingWithPermit<span class="token punctuation">,</span> MgvOfferMaking <span class="token punctuation">{</span>
  <span class="token builtin">address</span> <span class="token keyword">internal</span> immutable APPENDIX<span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">address</span> governance<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasmax<span class="token punctuation">)</span> <span class="token function">MgvOfferTakingWithPermit</span><span class="token punctuation">(</span><span class="token string">"Mangrove"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">emit</span> <span class="token function">NewMgv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      APPENDIX <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MgvAppendix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Set initial gasprice, gasmax, recursion depth and max gasreq for failing offers.  See <code>MgvAppendix</code> for why this happens through a delegatecall.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></code>
          <pre>      <span class="token builtin">bool</span> success<span class="token punctuation">;</span>
      <span class="token punctuation">(</span>success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> APPENDIX<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>MgvGovernable<span class="token punctuation">.</span>setGasprice<span class="token punctuation">,</span> <span class="token punctuation">(</span>gasprice<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"mgv/ctor/gasprice"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span>success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> APPENDIX<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>MgvGovernable<span class="token punctuation">.</span>setGasmax<span class="token punctuation">,</span> <span class="token punctuation">(</span>gasmax<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"mgv/ctor/gasmax"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span>success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span>
        APPENDIX<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>MgvGovernable<span class="token punctuation">.</span>setMaxRecursionDepth<span class="token punctuation">,</span> <span class="token punctuation">(</span>INITIAL_MAX_RECURSION_DEPTH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"mgv/ctor/maxRecursionDepth"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">(</span>success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> APPENDIX<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>
        abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>
          MgvGovernable<span class="token punctuation">.</span>setMaxGasreqForFailingOffers<span class="token punctuation">,</span> <span class="token punctuation">(</span>INITIAL_MAX_GASREQ_FOR_FAILING_OFFERS_MULTIPLIER <span class="token operator">*</span> gasmax<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"mgv/ctor/maxGasreqForFailingOffers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Initially, governance is open to anyone so that Mangrove can set its own default parameters. After that, governance is set to the <code>governance</code> constructor argument.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>37
38
39
40
41</pre></code>
          <pre>      <span class="token punctuation">(</span>success<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> APPENDIX<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodeCall</span><span class="token punctuation">(</span>MgvGovernable<span class="token punctuation">.</span>setGovernance<span class="token punctuation">,</span> <span class="token punctuation">(</span>governance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"mgv/ctor/governance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Fallback to <code>APPENDIX</code> if function selector is unknown.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>43
44
45
46
47
48
49
50
51
52
53</pre></code>
          <pre>  <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token builtin">bytes</span> <span class="token keyword">calldata</span> callData<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes</span> <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token builtin">bool</span> success<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> res<span class="token punctuation">)</span> <span class="token operator">=</span> APPENDIX<span class="token punctuation">.</span><span class="token function">delegatecall</span><span class="token punctuation">(</span>callData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mload</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="densitylib.sol" class="left filebreak">DensityLib.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.17</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>Field<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/TickTreeLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>ONES<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/Constants.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BitLib<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/BitLib.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The density of a semibook is the number of outbound tokens per gas required. An offer must a respect a semibook’s density.</p>
<p>Density can be &lt; 1.</p>
<p>The density of a semibook is stored as a 9 bits float. For convenience, governance functions read density as a 96.32 fixed point number. The functions below give conversion utilities between the two formats</p>
<p>As a guideline, fixed-point densities should be uints and should use hungarian notation (for instance <code>uint density96X32</code>). Floating-point densities should use the Density user-defined type.</p>
<p>The float &lt;-&gt; fixed conversion is format agnostic but the expectation is that fixed points are 96x32, and floats are 2-bit mantissa, 7bit exponent with bias 32.</p>
<p>The encoding is nonstandard so the code can be simpler.</p>
<p>There are no subnormal floats in this encoding, <code>[exp][mantissa]</code> means:</p>
<pre><code>if exp is 0 or 1:   0bmantissa   * 2^-32
otherwise:          0b1.mantissa * 2^(exp-32)
</code></pre>
<p>so the small values have some holes:</p>
<pre><code>coeff   exponent  available    |   coeff   exponent  available
--------------------------------------------------------------
0b0.00                         |  0b1.10     -31
0b1.00     -32                 |  0b1.11     -31        no
0b1.01     -32        no       |  0b1.00     -30
0b1.10     -32        no       |  0b1.01     -30
0b1.11     -32        no       |  0b1.10     -30
0b1.00     -31                 |  0b1.11     -30
0b1.01     -31        no       |  0b1.00     -29
</code></pre>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>43
44
45
46
47</pre></code>
          <pre>
type Density <span class="token keyword">is</span> <span class="token builtin">uint</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token class-name">DensityLib</span> <span class="token keyword">for</span> Density global<span class="token punctuation">;</span>

<span class="token keyword">library</span> <span class="token class-name">DensityLib</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Numbers in this file assume that density is 9 bits in structs.ts</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>49
50
51
52
53
54
55
56
57
58
59
60</pre></code>
          <pre>  <span class="token builtin">uint</span> <span class="token keyword">constant</span> BITS <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span> <span class="token comment">// must match structs.ts</span>
  <span class="token builtin">uint</span> <span class="token keyword">constant</span> MANTISSA_BITS <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token builtin">uint</span> <span class="token keyword">constant</span> SUBNORMAL_LIMIT <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>ONES <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>MANTISSA_BITS<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">uint</span> <span class="token keyword">constant</span> MANTISSA_MASK <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>ONES <span class="token operator">&lt;&lt;</span> MANTISSA_BITS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">uint</span> <span class="token keyword">constant</span> MASK <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>ONES <span class="token operator">&lt;&lt;</span> BITS<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token builtin">uint</span> <span class="token keyword">constant</span> MANTISSA_INTEGER <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> MANTISSA_BITS<span class="token punctuation">;</span>
  <span class="token builtin">uint</span> <span class="token keyword">constant</span> EXPONENT_BITS <span class="token operator">=</span> BITS <span class="token operator">-</span> MANTISSA_BITS<span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">eq</span><span class="token punctuation">(</span>Density a<span class="token punctuation">,</span> Density b<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Density<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">==</span> Density<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Check the size of a fixed-point formatted density</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>62
63
64
65</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">checkDensity96X32</span><span class="token punctuation">(</span><span class="token builtin">uint</span> density96X32<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> density96X32 <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">96</span><span class="token operator">+</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>fixed-point -&gt; float conversion</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Warning: no bit cleaning (expected to be done by Local’s code), no checking that the input is on 128 bits.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>floats with <code>[exp=1]</code> are not in the image of fromFixed. They are considered noncanonical.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>69
70
71
72</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">from96X32</span><span class="token punctuation">(</span><span class="token builtin">uint</span> density96X32<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Density<span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>density96X32 <span class="token operator">&lt;=</span> MANTISSA_MASK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Density<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>density96X32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>invariant: <code>exp &gt;= 2</code> (so not 0)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>74
75
76
77</pre></code>
          <pre>    <span class="token builtin">uint</span> exp <span class="token operator">=</span> BitLib<span class="token punctuation">.</span><span class="token function">fls</span><span class="token punctuation">(</span>density96X32<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">make</span><span class="token punctuation">(</span>density96X32 <span class="token operator">>></span> <span class="token punctuation">(</span>exp<span class="token operator">-</span>MANTISSA_BITS<span class="token punctuation">)</span><span class="token punctuation">,</span>exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>float -&gt; fixed-point conversion</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>79</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">to96X32</span><span class="token punctuation">(</span>Density density<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>also accepts floats not generated by fixedToFloat, i.e. with exp=1</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>81
82
83</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Density<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> SUBNORMAL_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Density<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span> <span class="token operator">&amp;</span> MANTISSA_MASK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>assumes exp is on the right number of bits</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>invariant: <code>exp &gt;= 2</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>86
87
88
89
90
91
92
93
94
95
96
97</pre></code>
          <pre>    <span class="token builtin">uint</span> shift <span class="token operator">=</span> <span class="token punctuation">(</span>Density<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span> <span class="token operator">>></span> MANTISSA_BITS<span class="token punctuation">)</span> <span class="token operator">-</span> MANTISSA_BITS<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Density<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span> <span class="token operator">&amp;</span> MANTISSA_MASK<span class="token punctuation">)</span> <span class="token operator">|</span> MANTISSA_INTEGER<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> shift<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">mantissa</span><span class="token punctuation">(</span>Density density<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Density<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span> <span class="token operator">&amp;</span> MANTISSA_MASK<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">exponent</span><span class="token punctuation">(</span>Density density<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Density<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>density<span class="token punctuation">)</span> <span class="token operator">>></span> MANTISSA_BITS<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Make a float from a mantissa and an exponent. May make a noncanonical float.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Warning: no checks</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>100
101
102
103</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token builtin">uint</span> _mantissa<span class="token punctuation">,</span> <span class="token builtin">uint</span> _exponent<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Density<span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Density<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_exponent <span class="token operator">&lt;&lt;</span> MANTISSA_BITS<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>_mantissa <span class="token operator">&amp;</span> MANTISSA_MASK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>None of the functions below will overflow if m is 96bit wide.
Density being a 96.32 number is useful because:</p>
<ul>
<li>Most of its range is representable with the 9-bits float format chosen</li>
<li>It does not overflow when multiplied with a 96bit number, which is the size chosen to represent token amounts in Mangrove.</li>
<li>Densities below <code>2^-32</code> need <code>&gt; 4e9</code> gasreq to force gives &gt; 0, which is not realistic</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Multiply the density with m, rounded towards zero.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>May overflow if <code>|m|&gt;9</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>112
113
114</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">multiply</span><span class="token punctuation">(</span>Density density<span class="token punctuation">,</span> <span class="token builtin">uint</span> m<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>m <span class="token operator">*</span> density<span class="token punctuation">.</span><span class="token function">to96X32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">32</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Multiply the density with m, rounded towards +infinity.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>May overflow if <code>|m|&gt;96</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>117
118
119
120
121</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">multiplyUp</span><span class="token punctuation">(</span>Density density<span class="token punctuation">,</span> <span class="token builtin">uint</span> m<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> part <span class="token operator">=</span> m <span class="token operator">*</span> density<span class="token punctuation">.</span><span class="token function">to96X32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>part <span class="token operator">>></span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>part<span class="token operator">%</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">&lt;&lt;</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Convenience function: get a fixed-point density from the given parameters. Computes the price of gas in outbound tokens (base units), then multiplies by cover_factor.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Warning: you must multiply input usd prices by 100</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>not supposed to be gas optimized</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>125
126
127
128
129
130
131</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">paramsTo96X32</span><span class="token punctuation">(</span>
    <span class="token builtin">uint</span> outbound_decimals<span class="token punctuation">,</span> 
    <span class="token builtin">uint</span> gasprice_in_Mwei<span class="token punctuation">,</span> 
    <span class="token builtin">uint</span> eth_in_centiusd<span class="token punctuation">,</span> 
    <span class="token builtin">uint</span> outbound_display_in_centiusd<span class="token punctuation">,</span> 
    <span class="token builtin">uint</span> cover_factor
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>Do not use unchecked here</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>133
134</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint8</span><span class="token punctuation">(</span>outbound_decimals<span class="token punctuation">)</span> <span class="token operator">==</span> outbound_decimals<span class="token punctuation">,</span><span class="token string">"DensityLib/fixedFromParams1/decimals/wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> num <span class="token operator">=</span> cover_factor <span class="token operator">*</span> gasprice_in_Mwei <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">**</span>outbound_decimals<span class="token punctuation">)</span> <span class="token operator">*</span> eth_in_centiusd<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>use * instead of &lt;&lt; to trigger overflow check</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>136
137
138</pre></code>
          <pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>num <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>outbound_display_in_centiusd <span class="token operator">*</span> <span class="token number">1e12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Version with token in Mwei instead of usd</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>140
141
142
143
144
145</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">paramsTo96X32</span><span class="token punctuation">(</span>
    <span class="token builtin">uint</span> outbound_decimals<span class="token punctuation">,</span> 
    <span class="token builtin">uint</span> gasprice_in_Mwei<span class="token punctuation">,</span> 
    <span class="token builtin">uint</span> outbound_display_in_Mwei<span class="token punctuation">,</span> 
    <span class="token builtin">uint</span> cover_factor
  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><strong>Do not</strong> use unchecked here.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>147
148</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint8</span><span class="token punctuation">(</span>outbound_decimals<span class="token punctuation">)</span> <span class="token operator">==</span> outbound_decimals<span class="token punctuation">,</span><span class="token string">"DensityLib/fixedFromParams2/decimals/wrong"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> num <span class="token operator">=</span> cover_factor <span class="token operator">*</span> gasprice_in_Mwei <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">**</span>outbound_decimals<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>use <code>*</code> instead of <code>&lt;&lt;</code> to trigger overflow check</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>150
151
152</pre></code>
          <pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>num <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> outbound_display_in_Mwei<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="ticktreelib.sol" class="left filebreak">TickTreeLib.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7
8
9
10</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.17</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@mgv/lib/core/Constants.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Tick<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/TickLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>BitLib<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/BitLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>console2 <span class="token keyword">as</span> csf<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/forge-std/console2.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Local<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/src/preprocessed/Local.post.sol"</span><span class="token punctuation">;</span>

</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="ticktreelib.sol-libraries-for-tick-tree-manipulation">Libraries for tick tree manipulation</h1>
<p>Offers in Mangrove are structured in a tree so that offer insertion, removal, and update can happen in constant time.</p>
<p>The tree has the following structure: nodes at height 0, 1, 2 and 3 are bit fields (type <code>Field</code>) and nodes at height 4 (leaves) are arrays of pairs of offers (type <code>Leaf</code>).</p>
<ul>
<li>The root node is a 2-bit <code>Field</code> and has 2 child nodes.</li>
<li>The nodes below are called <code>level1</code> nodes and are 64-bit <code>Field</code>s, with 64 child nodes each.</li>
<li>The nodes below are called <code>level2</code> nodes and are 64-bit <code>Field</code>s with 64 child nodes each.</li>
<li>The nodes below are called <code>level3</code> nodes and are 64-bit <code>Field</code>s with 64 child nodes each.</li>
<li>The nodes below are called <code>leaf</code> nodes and are arrays of pairs of offers. Each pair of offers represents the first and last offer of a bin.</li>
<li>Bins are linked lists of offers.</li>
</ul>
<p>For each field, the i-th bit (starting from least significant) is set if there is at least one bin holding offers below the i-th child of the field.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Globally enable <code>leaf.method(...)</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>28
29
30</pre></code>
          <pre>type Leaf <span class="token keyword">is</span> <span class="token builtin">uint</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token class-name">LeafLib</span> <span class="token keyword">for</span> Leaf global<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Each <code>Leaf</code> holds information about 4 bins as follows: <code>[firstId,lastId] [firstId,lastId] [firstId,lastId] [firstId,lastId]</code>. For each bin <code>firstId</code> is used by <code>marketOrder</code> to start consuming offers in the bin (each offer contains a pointer to the next offer in the bin, until <code>lastId</code> is reacher). <code>lastId</code> is used when inserting offers in the bin: the newly inserted offer replaces the last offer.</p>
<p>Each <code>leaf</code> has an <code>index</code>: it is the number of leaves before it.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>35
36
37</pre></code>
          <pre><span class="token keyword">library</span> <span class="token class-name">LeafLib</span> <span class="token punctuation">{</span>
  Leaf <span class="token keyword">constant</span> EMPTY <span class="token operator">=</span> Leaf<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Checks if a leaf is dirty or not (see below for more on dirty leaves).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">dirty</span><span class="token punctuation">(</span>Leaf leaf<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>DirtyLeaf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        leaf <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span><span class="token function">iszero</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span><span class="token punctuation">,</span>leaf<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> DirtyLeaf<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Leaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">eq</span><span class="token punctuation">(</span>Leaf leaf1<span class="token punctuation">,</span> Leaf leaf2<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Leaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf1<span class="token punctuation">)</span> <span class="token operator">==</span> Leaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>Leaf leaf<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Leaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span> <span class="token operator">==</span> Leaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>EMPTY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>bool -&gt; int</code> cast</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>61
62
63
64
65
66
67
68</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">uint_of_bool</span><span class="token punctuation">(</span><span class="token builtin">bool</span> b<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> u<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        u <span class="token operator">:=</span> b
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Set either tick’s first (at pos<em>size) or last (at pos</em>size + 1)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>70
71
72
73
74
75
76
77
78
79
80
81</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setPosFirstOrLast</span><span class="token punctuation">(</span>Leaf leaf<span class="token punctuation">,</span> <span class="token builtin">uint</span> pos<span class="token punctuation">,</span> <span class="token builtin">uint</span> id<span class="token punctuation">,</span> <span class="token builtin">bool</span> last<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Leaf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> before <span class="token operator">=</span> OFFER_BITS <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">uint_of_bool</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token builtin">uint</span> cleanupMask <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>OFFER_MASK <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">-</span> OFFER_BITS <span class="token operator">-</span> before<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token builtin">uint</span> shiftedId <span class="token operator">=</span> id <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">-</span> OFFER_BITS <span class="token operator">-</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">uint</span> newLeaf <span class="token operator">=</span> Leaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span> <span class="token operator">&amp;</span> cleanupMask <span class="token operator">|</span> shiftedId<span class="token punctuation">;</span>
      <span class="token keyword">return</span> Leaf<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>newLeaf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Assume <code>leaf</code> is the leaf of <code>bin</code>. Set the first offer of <code>bin</code> in leaf to <code>id</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>83
84
85
86
87
88
89</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setBinFirst</span><span class="token punctuation">(</span>Leaf leaf<span class="token punctuation">,</span> Bin bin<span class="token punctuation">,</span> <span class="token builtin">uint</span> id<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Leaf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> posInLeaf <span class="token operator">=</span> bin<span class="token punctuation">.</span><span class="token function">posInLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">setPosFirstOrLast</span><span class="token punctuation">(</span>leaf<span class="token punctuation">,</span> posInLeaf<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Assume <code>leaf</code> is the leaf of <code>bin</code>. Set the last offer of <code>bin</code> in leaf to <code>id</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>91
92
93
94
95
96
97</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setBinLast</span><span class="token punctuation">(</span>Leaf leaf<span class="token punctuation">,</span> Bin bin<span class="token punctuation">,</span> <span class="token builtin">uint</span> id<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Leaf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> posInLeaf <span class="token operator">=</span> bin<span class="token punctuation">.</span><span class="token function">posInLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">setPosFirstOrLast</span><span class="token punctuation">(</span>leaf<span class="token punctuation">,</span> posInLeaf<span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Assumes <code>leaf</code> is the leaf of <code>bin</code>. Erase contents of bins in <code>leaf</code> to (not including) <code>bin</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>100
101
102
103
104
105
106</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">eraseBelow</span><span class="token punctuation">(</span>Leaf leaf<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Leaf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> mask <span class="token operator">=</span> ONES <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bin<span class="token punctuation">.</span><span class="token function">posInLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> OFFER_BITS <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Leaf<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Leaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span> <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Assumes <code>leaf</code> is the leaf of <code>bin</code>. Erase contents of bins in <code>leaf</code> from (not including) <code>bin</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>109
110
111
112
113
114
115
116</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">eraseAbove</span><span class="token punctuation">(</span>Leaf leaf<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Leaf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> mask <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>ONES <span class="token operator">>></span> <span class="token punctuation">(</span>bin<span class="token punctuation">.</span><span class="token function">posInLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> OFFER_BITS <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Leaf<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Leaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span> <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is part of the library.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return the id of the first offer in <code>bin</code>, assuming <code>bin</code>’s leaf is <code>leaf</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>119
120
121
122
123
124</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">firstOfBin</span><span class="token punctuation">(</span>Leaf leaf<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">firstOfPos</span><span class="token punctuation">(</span>leaf<span class="token punctuation">,</span> bin<span class="token punctuation">.</span><span class="token function">posInLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return the id of the last offer in <code>bin</code>, assuming <code>bin</code>’s leaf is <code>leaf</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>126
127
128
129
130
131</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">lastOfBin</span><span class="token punctuation">(</span>Leaf leaf<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">lastOfPos</span><span class="token punctuation">(</span>leaf<span class="token punctuation">,</span> bin<span class="token punctuation">.</span><span class="token function">posInLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return first offer of pair in position <code>pos</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>133
134
135
136
137
138
139</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">firstOfPos</span><span class="token punctuation">(</span>Leaf leaf<span class="token punctuation">,</span> <span class="token builtin">uint</span> pos<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> raw <span class="token operator">=</span> Leaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>raw <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>pos <span class="token operator">*</span> OFFER_BITS <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">-</span> OFFER_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return second offer of pair in position <code>pos</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>141
142
143
144
145
146
147</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">lastOfPos</span><span class="token punctuation">(</span>Leaf leaf<span class="token punctuation">,</span> <span class="token builtin">uint</span> pos<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> raw <span class="token operator">=</span> Leaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>raw <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>OFFER_BITS <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">-</span> OFFER_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return the position of the first pair of <code>leaf</code> (0, 1, 2 or 3) that has a nonzero offer.</p>
<p>Explanation:
Note that unlike in fields, have their low bin on the most significant bits.
<code>pos</code> is initially 1 if <code>leaf</code> has some nonzero bit in its MSB half, 0 otherwise. Then <code>pos</code> is <code>A | B</code>, where <code>A</code> is <code>1&lt;&lt;iszero(ret)</code>, so <code>A</code> is 0 if leaf has some nonzero bit in its MSB half, 2 otherwise. And <code>B</code> is 0 if <code>leaf &gt;&gt; (pos &lt;&lt; 7)</code> has some nonzero bit in its most significant 192 bits, 0 otherwise.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>154
155
156
157
158
159
160</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">bestNonEmptyBinPos</span><span class="token punctuation">(</span>Leaf leaf<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> pos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assembly</span><span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pos <span class="token operator">:=</span> <span class="token function">gt</span><span class="token punctuation">(</span>leaf<span class="token punctuation">,</span><span class="token number">0xffffffffffffffffffffffffffffffff</span><span class="token punctuation">)</span>
      pos <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span><span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token function">iszero</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">iszero</span><span class="token punctuation">(</span><span class="token function">gt</span><span class="token punctuation">(</span><span class="token function">shr</span><span class="token punctuation">(</span><span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span>pos<span class="token punctuation">)</span><span class="token punctuation">,</span>leaf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0xffffffffffffffff</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return the offer id of the first offer of the first non-empty pair in <code>leaf</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>162
163
164
165
166
167
168
169</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">bestOfferId</span><span class="token punctuation">(</span>Leaf leaf<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> offerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">firstOfPos</span><span class="token punctuation">(</span>leaf<span class="token punctuation">,</span><span class="token function">bestNonEmptyBinPos</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Bins are numbered from MIN_BIN to MAX_BIN (inclusive). Each bin contains the offers at a given price. For a given <code>tickSpacing</code>, bins represent the following prices (centered on the central bin):</p>
<pre><code>...
1.0001^-(tickSpacing*2)
1.0001^-(tickSpacing*1)
1.0001
1.0001^(tickSpacing*1)
1.0001^(tickSpacing*2)
...
</code></pre>
<p>There are 4 bins per leaf, <code>4 * 64</code> bins per level3, etc. The leaf of a bin is the leaf that holds its first/last offer id. The level3 of a bin is the level3 field above its leaf; the level2 of a bin is the level2 field above its level3, etc.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Globally enable <code>bin.method(...)</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200</pre></code>
          <pre>type Bin <span class="token keyword">is</span> <span class="token builtin">int</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token class-name">TickTreeLib</span> <span class="token keyword">for</span> Bin global<span class="token punctuation">;</span>

<span class="token keyword">library</span> <span class="token class-name">TickTreeLib</span> <span class="token punctuation">{</span>

  <span class="token keyword">function</span> <span class="token function">eq</span><span class="token punctuation">(</span>Bin bin1<span class="token punctuation">,</span> Bin bin2<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin1<span class="token punctuation">)</span> <span class="token operator">==</span> Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">inRange</span><span class="token punctuation">(</span>Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span> <span class="token operator">>=</span> MIN_BIN <span class="token operator">&amp;&amp;</span> Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> MAX_BIN<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is part of the library for convenience.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Not optimized for gas. Returns the bin induced by the branch formed by the arguments. Returned value will make no sense if any of the <code>Field</code> arguments are empty.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>204
205
206
207
208
209
210
211</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">bestBinFromBranch</span><span class="token punctuation">(</span><span class="token builtin">uint</span> binPosInLeaf<span class="token punctuation">,</span>Field level3<span class="token punctuation">,</span> Field level2<span class="token punctuation">,</span> Field level1<span class="token punctuation">,</span> Field root<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Bin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      Local local<span class="token punctuation">;</span>
      local <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">binPosInLeaf</span><span class="token punctuation">(</span>binPosInLeaf<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span>level3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">level2</span><span class="token punctuation">(</span>level2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">level1</span><span class="token punctuation">(</span>level1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">root</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">bestBinFromLocal</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns tick held by the <code>bin</code>, given a <code>tickSpacing</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>213
214
215
216</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">tick</span><span class="token punctuation">(</span>Bin bin<span class="token punctuation">,</span> <span class="token builtin">uint</span> tickSpacing<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Tick<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Tick<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token builtin">int</span><span class="token punctuation">(</span>tickSpacing<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the bin induced by the branch held in <code>local</code>. Returned value will make no sense if any of the fields of <code>local</code> are empty.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>218
219
220
221
222
223
224
225
226
227
228
229
230
231
232</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">bestBinFromLocal</span><span class="token punctuation">(</span>Local local<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Bin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> ubin <span class="token operator">=</span> local<span class="token punctuation">.</span><span class="token function">binPosInLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>BitLib<span class="token punctuation">.</span><span class="token function">ctz64</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>local<span class="token punctuation">.</span><span class="token function">level3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span>
          <span class="token punctuation">(</span>BitLib<span class="token punctuation">.</span><span class="token function">ctz64</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>local<span class="token punctuation">.</span><span class="token function">level2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span>
            <span class="token punctuation">(</span>BitLib<span class="token punctuation">.</span><span class="token function">ctz64</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>local<span class="token punctuation">.</span><span class="token function">level1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">|</span>
              <span class="token builtin">uint</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>BitLib<span class="token punctuation">.</span><span class="token function">ctz64</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>local<span class="token punctuation">.</span><span class="token function">root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span>ROOT_SIZE<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> LEVEL_SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">)</span> 
              <span class="token operator">&lt;&lt;</span> LEVEL_SIZE_BITS<span class="token punctuation">)</span>
            <span class="token operator">&lt;&lt;</span> LEVEL_SIZE_BITS<span class="token punctuation">)</span>
          <span class="token operator">&lt;&lt;</span> LEAF_SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Bin<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>ubin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the index of the leaf that holds <code>bin</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>234
235
236
237
238
239</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">leafIndex</span><span class="token punctuation">(</span>Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span> <span class="token operator">>></span> LEAF_SIZE_BITS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the position of <code>bin</code> in its leaf.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>241
242
243
244
245
246</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">posInLeaf</span><span class="token punctuation">(</span>Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> LEAF_SIZE_MASK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the index of <code>bin</code>’s level3</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>248
249
250
251
252
253</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">level3Index</span><span class="token punctuation">(</span>Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token punctuation">(</span>LEAF_SIZE_BITS <span class="token operator">+</span> LEVEL_SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the position of <code>bin</code>’s leaf in <code>bin</code>’s level3</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>255
256
257
258
259
260</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">posInLevel3</span><span class="token punctuation">(</span>Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>bin<span class="token punctuation">.</span><span class="token function">leafIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> LEVEL_SIZE_MASK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the index of <code>bin</code>’s level2</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>262
263
264
265
266
267</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">level2Index</span><span class="token punctuation">(</span>Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token punctuation">(</span>LEAF_SIZE_BITS <span class="token operator">+</span> <span class="token number">2</span><span class="token operator">*</span> LEVEL_SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the position of <code>bin</code>’s level3 in <code>bin</code>’s level2</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>269
270
271
272
273
274</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">posInLevel2</span><span class="token punctuation">(</span>Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>bin<span class="token punctuation">.</span><span class="token function">level3Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> LEVEL_SIZE_MASK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the index of <code>bin</code>’s level1</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>276
277
278
279
280
281</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">level1Index</span><span class="token punctuation">(</span>Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin<span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token punctuation">(</span>LEAF_SIZE_BITS <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">*</span> LEVEL_SIZE_BITS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the position of <code>bin</code>’s level2 in <code>bin</code>’s level1</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>283
284
285
286
287
288</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">posInLevel1</span><span class="token punctuation">(</span>Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>bin<span class="token punctuation">.</span><span class="token function">level2Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> LEVEL_SIZE_MASK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the position of <code>bin</code>’s level1 in root</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>290
291
292
293
294
295</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">posInRoot</span><span class="token punctuation">(</span>Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>bin<span class="token punctuation">.</span><span class="token function">level1Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> ROOT_SIZE <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>&lt;</code>, typed for bin</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>297
298
299
300
301
302</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">strictlyBetter</span><span class="token punctuation">(</span>Bin bin1<span class="token punctuation">,</span> Bin bin2<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin1<span class="token punctuation">)</span> <span class="token operator">&lt;</span> Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>&lt;=</code>, typed for bin</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>304
305
306
307
308
309
310
311</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">better</span><span class="token punctuation">(</span>Bin bin1<span class="token punctuation">,</span> Bin bin2<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin1<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> Bin<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>bin2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>  

<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Globally enable <code>field.method(...)</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>313
314
315</pre></code>
          <pre>type Field <span class="token keyword">is</span> <span class="token builtin">uint</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token class-name">FieldLib</span> <span class="token keyword">for</span> Field global<span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Fields are bit fields. Each bit position of a field corresponds to a child of the node in the tick tree. The i-th bit of a field is set iff its child is the parent of at least one non-emtpy field.</p>
<p>Using bit fields market orders can locate the next bin containing an offer in constant time: once a leaf has been emptied, one must at most walk up along the branch of the current bin, up to the first 1 in a field, then go down to the of the tree, then go down the corresponding child to the nonempty bin found.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In fields, positions are counted from the least significant bits</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>322
323
324</pre></code>
          <pre><span class="token keyword">library</span> <span class="token class-name">FieldLib</span> <span class="token punctuation">{</span>
  Field <span class="token keyword">constant</span> EMPTY <span class="token operator">=</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Checks if a field is dirty or not (see below for more on dirty fields).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">dirty</span><span class="token punctuation">(</span>Field field<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>DirtyField<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        field <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>TOPBIT<span class="token punctuation">,</span>field<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> DirtyField<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">eq</span><span class="token punctuation">(</span>Field field1<span class="token punctuation">,</span> Field field2<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field1<span class="token punctuation">)</span> <span class="token operator">==</span> Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span>Field field<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token operator">==</span> Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>EMPTY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Flip the bit at the position of <code>bin</code>’s leaf</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>348
349
350
351
352
353
354
355</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">flipBitAtLevel3</span><span class="token punctuation">(</span>Field level3<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> pos <span class="token operator">=</span> bin<span class="token punctuation">.</span><span class="token function">posInLevel3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      level3 <span class="token operator">=</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>level3<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> level3<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Flip the bit at the position of <code>bin</code>’s level3</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>357
358
359
360
361
362
363
364</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">flipBitAtLevel2</span><span class="token punctuation">(</span>Field level2<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> pos <span class="token operator">=</span> bin<span class="token punctuation">.</span><span class="token function">posInLevel2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      level2 <span class="token operator">=</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>level2<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> level2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Flip the bit at the position of <code>bin</code>’s level2</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>366
367
368
369
370
371
372
373</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">flipBitAtLevel1</span><span class="token punctuation">(</span>Field level1<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> pos <span class="token operator">=</span> bin<span class="token punctuation">.</span><span class="token function">posInLevel1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      level1 <span class="token operator">=</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>level1<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> level1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Flip the bit at the position of <code>bin</code>’s level1</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>375
376
377
378
379
380
381
382</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">flipBitAtRoot</span><span class="token punctuation">(</span>Field root<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> pos <span class="token operator">=</span> bin<span class="token punctuation">.</span><span class="token function">posInRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      root <span class="token operator">=</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> pos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> root<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Assumes <code>field</code> is the level3 of <code>bin</code>. Erase contents of field up to (not including) bin.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>385
386
387
388
389
390
391</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">eraseBelowInLevel3</span><span class="token punctuation">(</span>Field field<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> mask <span class="token operator">=</span> ONES <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>bin<span class="token punctuation">.</span><span class="token function">posInLevel3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Assumes <code>field</code> is the level3 of <code>bin</code>. Erase contents of field from (not including) bin.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>394
395
396
397
398
399
400</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">eraseAboveInLevel3</span><span class="token punctuation">(</span>Field field<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> mask <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>ONES <span class="token operator">&lt;&lt;</span> bin<span class="token punctuation">.</span><span class="token function">posInLevel3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Assumes <code>field</code> is the level2 of <code>bin</code>. Erase contents of field up to (not including) bin.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>403
404
405
406
407
408
409</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">eraseBelowInLevel2</span><span class="token punctuation">(</span>Field field<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> mask <span class="token operator">=</span> ONES <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>bin<span class="token punctuation">.</span><span class="token function">posInLevel2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Assumes <code>field</code> is the level2 of <code>bin</code>. Erase contents of field from (not including) bin.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>412
413
414
415
416
417
418</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">eraseAboveInLevel2</span><span class="token punctuation">(</span>Field field<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> mask <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>ONES <span class="token operator">&lt;&lt;</span> bin<span class="token punctuation">.</span><span class="token function">posInLevel2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Assumes <code>field</code> is the level1 of <code>bin</code>. Erase contents of field up to (not including) bin.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>421
422
423
424
425
426
427</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">eraseBelowInLevel1</span><span class="token punctuation">(</span>Field field<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> mask <span class="token operator">=</span> ONES <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>bin<span class="token punctuation">.</span><span class="token function">posInLevel1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Assumes <code>field</code> is the level1 of <code>bin</code>. Erase contents of field from (not including) bin.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>430
431
432
433
434
435
436</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">eraseAboveInLevel1</span><span class="token punctuation">(</span>Field field<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> mask <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>ONES <span class="token operator">&lt;&lt;</span> bin<span class="token punctuation">.</span><span class="token function">posInLevel1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Assumes <code>field</code> is the root of <code>bin</code>. Erase contents of field up to (not including) bin.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>439
440
441
442
443
444
445</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">eraseBelowInRoot</span><span class="token punctuation">(</span>Field field<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> mask <span class="token operator">=</span> ONES <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>bin<span class="token punctuation">.</span><span class="token function">posInRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Assumes <code>field</code> is the root of <code>bin</code>. Erase contents of field from (not including) bin.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>448
449
450
451
452
453
454</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">eraseAboveInRoot</span><span class="token punctuation">(</span>Field field<span class="token punctuation">,</span> Bin bin<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> mask <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>ONES <span class="token operator">&lt;&lt;</span> bin<span class="token punctuation">.</span><span class="token function">posInRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns first nonzero position of <code>field</code>. Will return 64 if field is empty</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>456
457
458
459
460
461</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">firstOnePosition</span><span class="token punctuation">(</span>Field field<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> BitLib<span class="token punctuation">.</span><span class="token function">ctz64</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns last nonzero position of <code>field</code>. Will return 256 if field is empty</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>464
465
466
467
468
469</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">lastOnePosition</span><span class="token punctuation">(</span>Field field<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> BitLib<span class="token punctuation">.</span><span class="token function">fls</span><span class="token punctuation">(</span>Field<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return index of the first nonempty level1 below <code>root</code> (<code>root</code> should not be empty)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>471
472
473
474
475
476</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">firstLevel1Index</span><span class="token punctuation">(</span>Field root<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">firstOnePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> ROOT_SIZE <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return index of the last nonempty level1 below <code>root</code> (root should not be empty)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>479
480
481
482
483
484</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">lastLevel1Index</span><span class="token punctuation">(</span>Field root<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">lastOnePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> ROOT_SIZE <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return index of the first nonempty level2 below <code>level1</code> assuming its index is <code>level1Index</code> (<code>level1</code> should not be empty).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>486
487
488
489
490</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">firstLevel2Index</span><span class="token punctuation">(</span>Field level1<span class="token punctuation">,</span> <span class="token builtin">int</span> level1Index<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> level1Index <span class="token operator">*</span> LEVEL_SIZE <span class="token operator">+</span> <span class="token builtin">int</span><span class="token punctuation">(</span>level1<span class="token punctuation">.</span><span class="token function">firstOnePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return index of the last nonempty level2 below <code>level1</code> assuming its index is <code>level1Index</code> (<code>level1</code> should not be empty).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>493
494
495
496
497
498</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">lastLevel2Index</span><span class="token punctuation">(</span>Field level1<span class="token punctuation">,</span> <span class="token builtin">int</span> level1Index<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> level1Index <span class="token operator">*</span> LEVEL_SIZE <span class="token operator">+</span> <span class="token builtin">int</span><span class="token punctuation">(</span>level1<span class="token punctuation">.</span><span class="token function">lastOnePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return index of the first nonempty level3 below <code>level2</code> assuming its index is <code>level2Index</code> (<code>level2</code> should not be empty).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>500
501
502
503
504
505</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">firstLevel3Index</span><span class="token punctuation">(</span>Field level2<span class="token punctuation">,</span> <span class="token builtin">int</span> level2Index<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> level2Index <span class="token operator">*</span> LEVEL_SIZE <span class="token operator">+</span> <span class="token builtin">int</span><span class="token punctuation">(</span>level2<span class="token punctuation">.</span><span class="token function">firstOnePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return index of the last nonempty level3 below <code>level2</code> assuming its index is <code>level2Index</code> (<code>level2</code> should not be empty).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>508
509
510
511
512
513</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">lastLevel3Index</span><span class="token punctuation">(</span>Field level2<span class="token punctuation">,</span> <span class="token builtin">int</span> level2Index<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> level2Index <span class="token operator">*</span> LEVEL_SIZE <span class="token operator">+</span> <span class="token builtin">int</span><span class="token punctuation">(</span>level2<span class="token punctuation">.</span><span class="token function">lastOnePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return index of the first nonempty leaf below <code>level3</code> assuming its index is <code>level3Index</code> (<code>level3</code> should not be empty).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>515
516
517
518
519
520</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">firstLeafIndex</span><span class="token punctuation">(</span>Field level3<span class="token punctuation">,</span> <span class="token builtin">int</span> level3Index<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> level3Index <span class="token operator">*</span> LEVEL_SIZE <span class="token operator">+</span> <span class="token builtin">int</span><span class="token punctuation">(</span>level3<span class="token punctuation">.</span><span class="token function">firstOnePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><em>This function is not used by Mangrove but is useful for MgvReader.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return index of the last nonempty leaf below <code>level3</code> assuming its index is <code>level3Index</code> (<code>level3</code> should not be empty).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>523
524
525
526
527
528
529
530</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">lastLeafIndex</span><span class="token punctuation">(</span>Field level3<span class="token punctuation">,</span> <span class="token builtin">int</span> level3Index<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> level3Index <span class="token operator">*</span> LEVEL_SIZE <span class="token operator">+</span> <span class="token builtin">int</span><span class="token punctuation">(</span>level3<span class="token punctuation">.</span><span class="token function">lastOnePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

 <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="ticktreelib.sol-clean%2Fdirty-fields-and-leaves">Clean/Dirty Fields and Leaves</h2>
<p>To save gas, leaves and fields at never zeroed out but written with a dirty bit. This is especially helpful when the price oscillates quickly between two nodes.</p>
<p>Leaves don’t have ‘available bits’ so an empty leaf is encoded as 1. This is not a valid leaf because for every offer pair in a leaf, either both are 0 (the bin is empty) or both are nonzero (they are the same if the bin has a single offer).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Globally enable <code>dirtyLeaf.method(...)</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>539
540
541
542
543</pre></code>
          <pre>type DirtyLeaf <span class="token keyword">is</span> <span class="token builtin">uint</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token class-name">DirtyLeafLib</span> <span class="token keyword">for</span> DirtyLeaf global<span class="token punctuation">;</span>

<span class="token keyword">library</span> <span class="token class-name">DirtyLeafLib</span> <span class="token punctuation">{</span>
  </pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return 0 if leaf is 1, leaf otherwise</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">clean</span><span class="token punctuation">(</span>DirtyLeaf leaf<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Leaf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        leaf <span class="token operator">:=</span> <span class="token function">xor</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>leaf<span class="token punctuation">,</span>ONE<span class="token punctuation">)</span><span class="token punctuation">,</span>leaf<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> Leaf<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>DirtyLeaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">isDirty</span><span class="token punctuation">(</span>DirtyLeaf leaf<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> DirtyLeaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf<span class="token punctuation">)</span> <span class="token operator">==</span> ONE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">eq</span><span class="token punctuation">(</span>DirtyLeaf leaf1<span class="token punctuation">,</span> DirtyLeaf leaf2<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> DirtyLeaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf1<span class="token punctuation">)</span> <span class="token operator">==</span> DirtyLeaf<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We use <code>TOPBIT</code> as the optimized in-storage value since 1 is a valid Field value</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>For fields, it’s simpler, since they do not use 64 bits we store the word with top bit at 1 and everything else at 0 to mark emptiness.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Globally enable <code>dirtyField.method(...)</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>570
571
572
573
574
575
576</pre></code>
          <pre>type DirtyField <span class="token keyword">is</span> <span class="token builtin">uint</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token class-name">DirtyFieldLib</span> <span class="token keyword">for</span> DirtyField global<span class="token punctuation">;</span>

<span class="token keyword">library</span> <span class="token class-name">DirtyFieldLib</span> <span class="token punctuation">{</span>
  DirtyField <span class="token keyword">constant</span> DIRTY_EMPTY <span class="token operator">=</span> DirtyField<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>TOPBIT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  DirtyField <span class="token keyword">constant</span> CLEAN_EMPTY <span class="token operator">=</span> DirtyField<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return clean field with topbit set to 0</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">clean</span><span class="token punctuation">(</span>DirtyField field<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        field <span class="token operator">:=</span> <span class="token function">and</span><span class="token punctuation">(</span>NOT_TOPBIT<span class="token punctuation">,</span>field<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> Field<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>DirtyField<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">isDirty</span><span class="token punctuation">(</span>DirtyField field<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> DirtyField<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token operator">&amp;</span> TOPBIT <span class="token operator">==</span> TOPBIT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">eq</span><span class="token punctuation">(</span>DirtyField leaf1<span class="token punctuation">,</span> DirtyField leaf2<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> DirtyField<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf1<span class="token punctuation">)</span> <span class="token operator">==</span> DirtyField<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>leaf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="ticklib.sol" class="left filebreak">TickLib.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.17</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>Bin<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/TickTreeLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"@mgv/lib/core/BitLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"@mgv/lib/core/Constants.sol"</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This file is inspired by Uniswap’s approach to ticks, with the following notable changes:</p>
<ul>
<li>directly compute ticks base 1.0001 (not base <code>sqrt(1.0001)</code>)</li>
<li>directly compute ratios (not <code>sqrt(ratio)</code>) (simpler code elsewhere when dealing with actual ratios and logs of ratios)</li>
<li>ratios are floating-point numbers, not fixed-point numbers (increases precision when computing amounts)</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="ticklib.sol-ticklib">TickLib</h1>
<p>The <code>TickLib</code> file contains tick math-related code and utilities for manipulating ticks. It also holds functions related to ratios, which are represented as (mantissa,exponent) pairs.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Globally enable <code>tick.method(...)</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></code>
          <pre>type Tick <span class="token keyword">is</span> <span class="token builtin">int</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token class-name">TickLib</span> <span class="token keyword">for</span> Tick global<span class="token punctuation">;</span>

<span class="token keyword">library</span> <span class="token class-name">TickLib</span> <span class="token punctuation">{</span>

  <span class="token keyword">function</span> <span class="token function">inRange</span><span class="token punctuation">(</span>Tick tick<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span> <span class="token operator">>=</span> MIN_TICK <span class="token operator">&amp;&amp;</span> Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> MAX_TICK<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">eq</span><span class="token punctuation">(</span>Tick tick1<span class="token punctuation">,</span> Tick tick2<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>tick1<span class="token punctuation">)</span> <span class="token operator">==</span> Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>tick2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the nearest, higher bin to the given <code>tick</code> at the given <code>tickSpacing</code></p>
<p>We do not force ticks to fit the tickSpacing (aka <code>tick%tickSpacing==0</code>). Ratios are rounded up that the maker is always paid at least what they asked for</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>39
40</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">nearestBin</span><span class="token punctuation">(</span>Tick tick<span class="token punctuation">,</span> <span class="token builtin">uint</span> tickSpacing<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Bin bin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>By default division rounds towards 0. Since <code>smod</code> is signed we get the sign of <code>tick</code> and <code>tick%tickSpacing</code> in a single instruction.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>42
43
44
45
46
47
48</pre></code>
          <pre>      <span class="token keyword">assembly</span><span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bin <span class="token operator">:=</span> <span class="token function">sdiv</span><span class="token punctuation">(</span>tick<span class="token punctuation">,</span>tickSpacing<span class="token punctuation">)</span>
        bin <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>bin<span class="token punctuation">,</span><span class="token function">sgt</span><span class="token punctuation">(</span><span class="token function">smod</span><span class="token punctuation">(</span>tick<span class="token punctuation">,</span>tickSpacing<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="ticklib.sol-conversion-functions">Conversion functions</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>(inbound,tick) → outbound</h3>
<p><code>inboundFromOutbound[Up]</code> converts an outbound amount (i.e. an <code>offer.gives</code> or a <code>takerWants</code>), to an inbound amount, following the price induced by <code>tick</code>. There’s a rounding-up and a rounding-down variant.</p>
<p><code>outboundAmt</code> should not exceed 127 bits.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>56
57
58
59
60
61
62
63
64
65
66
67</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">inboundFromOutbound</span><span class="token punctuation">(</span>Tick tick<span class="token punctuation">,</span> <span class="token builtin">uint</span> outboundAmt<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token builtin">uint</span> sig<span class="token punctuation">,</span> <span class="token builtin">uint</span> exp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">ratioFromTick</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>sig <span class="token operator">*</span> outboundAmt<span class="token punctuation">)</span> <span class="token operator">>></span> exp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">inboundFromOutboundUp</span><span class="token punctuation">(</span>Tick tick<span class="token punctuation">,</span> <span class="token builtin">uint</span> outboundAmt<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token builtin">uint</span> sig<span class="token punctuation">,</span> <span class="token builtin">uint</span> exp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">ratioFromTick</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">divExpUp</span><span class="token punctuation">(</span>sig<span class="token operator">*</span>outboundAmt<span class="token punctuation">,</span>exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>(outbound,tick) → inbound</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>outboundFromInbound[Up]</code> converts an inbound amount (i.e. an <code>offer.wants</code> or a <code>takerGives</code>), to an outbound amount, following the price induced by <code>tick</code>. There’s a rounding-up and a rounding-down variant.</p>
<p><code>inboundAmt</code> should not exceed 127 bits.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>73
74
75
76
77
78
79
80
81
82
83
84</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">outboundFromInbound</span><span class="token punctuation">(</span>Tick tick<span class="token punctuation">,</span> <span class="token builtin">uint</span> inboundAmt<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token builtin">uint</span> sig<span class="token punctuation">,</span> <span class="token builtin">uint</span> exp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">ratioFromTick</span><span class="token punctuation">(</span>Tick<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token operator">-</span>Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>sig <span class="token operator">*</span> inboundAmt<span class="token punctuation">)</span> <span class="token operator">>></span> exp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">outboundFromInboundUp</span><span class="token punctuation">(</span>Tick tick<span class="token punctuation">,</span> <span class="token builtin">uint</span> inboundAmt<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token builtin">uint</span> sig<span class="token punctuation">,</span> <span class="token builtin">uint</span> exp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">ratioFromTick</span><span class="token punctuation">(</span>Tick<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token operator">-</span>Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">divExpUp</span><span class="token punctuation">(</span>sig<span class="token operator">*</span>inboundAmt<span class="token punctuation">,</span>exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="ticklib.sol-ratio-representation">Ratio representation</h2>
<p>Ratios are represented as a (mantissa,exponent) pair which represents the number <code>mantissa * 2**-exponent</code>.</p>
<p>The exponent is negated so that, for ratios in the accepted range, the exponent is <code>&gt;= 0</code>. This simplifies the code.</p>
<p>Floats are normalized so that the mantissa uses exactly 128 bits. It enables easy comparison between floats and ensures they can be multiplied by amounts without overflow.</p>
<p>The accepted ratio range is between <code>ratioFromTick(MIN_TICK)</code> and <code>ratioFromTick(MAX_TICK)</code> (inclusive).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>(outbound,inbound) → ratio</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>ratioFromVolumes</code> converts a pair of (inbound,outbound) volumes to a floating-point, normalized ratio.</p>
<ul>
<li><code>outboundAmt = 0</code> has a special meaning and the highest possible price will be returned.</li>
<li><code>inboundAmt = 0</code> has a special meaning if <code>outboundAmt != 0</code> and the lowest possible price will be returned.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">ratioFromVolumes</span><span class="token punctuation">(</span><span class="token builtin">uint</span> inboundAmt<span class="token punctuation">,</span> <span class="token builtin">uint</span> outboundAmt<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> mantissa<span class="token punctuation">,</span> <span class="token builtin">uint</span> exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>inboundAmt <span class="token operator">&lt;=</span> MAX_SAFE_VOLUME<span class="token punctuation">,</span> <span class="token string">"mgv/ratioFromVol/inbound/tooBig"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>outboundAmt <span class="token operator">&lt;=</span> MAX_SAFE_VOLUME<span class="token punctuation">,</span> <span class="token string">"mgv/ratioFromVol/outbound/tooBig"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>outboundAmt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>MAX_RATIO_MANTISSA<span class="token punctuation">,</span><span class="token builtin">uint</span><span class="token punctuation">(</span>MAX_RATIO_EXP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inboundAmt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>MIN_RATIO_MANTISSA<span class="token punctuation">,</span><span class="token builtin">uint</span><span class="token punctuation">(</span>MIN_RATIO_EXP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token builtin">uint</span> ratio <span class="token operator">=</span> <span class="token punctuation">(</span>inboundAmt <span class="token operator">&lt;&lt;</span> MANTISSA_BITS<span class="token punctuation">)</span> <span class="token operator">/</span> outboundAmt<span class="token punctuation">;</span> 
      <span class="token builtin">uint</span> log2 <span class="token operator">=</span> BitLib<span class="token punctuation">.</span><span class="token function">fls</span><span class="token punctuation">(</span>ratio<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">require</span><span class="token punctuation">(</span>ratio <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"mgv/ratioFromVolumes/zeroRatio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>log2 <span class="token operator">></span> MANTISSA_BITS_MINUS_ONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint</span> diff <span class="token operator">=</span> log2 <span class="token operator">-</span> MANTISSA_BITS_MINUS_ONE<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>ratio <span class="token operator">>></span> diff<span class="token punctuation">,</span> MANTISSA_BITS <span class="token operator">-</span> diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token builtin">uint</span> diff <span class="token operator">=</span> MANTISSA_BITS_MINUS_ONE <span class="token operator">-</span> log2<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>ratio <span class="token operator">&lt;&lt;</span> diff<span class="token punctuation">,</span> MANTISSA_BITS <span class="token operator">+</span> diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>(outbound,inbound) → ratio</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>126
127
128
129
130</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">tickFromVolumes</span><span class="token punctuation">(</span><span class="token builtin">uint</span> inboundAmt<span class="token punctuation">,</span> <span class="token builtin">uint</span> outboundAmt<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Tick tick<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token builtin">uint</span> man<span class="token punctuation">,</span> <span class="token builtin">uint</span> exp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">ratioFromVolumes</span><span class="token punctuation">(</span>inboundAmt<span class="token punctuation">,</span> outboundAmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">tickFromNormalizedRatio</span><span class="token punctuation">(</span>man<span class="token punctuation">,</span>exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>ratio → tick</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Does not require a normalized ratio.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>133
134
135
136
137
138</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">tickFromRatio</span><span class="token punctuation">(</span><span class="token builtin">uint</span> mantissa<span class="token punctuation">,</span> <span class="token builtin">int</span> exp<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Tick<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> normalized_exp<span class="token punctuation">;</span>
    <span class="token punctuation">(</span>mantissa<span class="token punctuation">,</span> normalized_exp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">normalizeRatio</span><span class="token punctuation">(</span>mantissa<span class="token punctuation">,</span> exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">tickFromNormalizedRatio</span><span class="token punctuation">(</span>mantissa<span class="token punctuation">,</span>normalized_exp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>low-level ratio → tick</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Given <code>ratio</code>, return greatest tick <code>t</code> such that <code>ratioFromTick(t) &lt;= ratio</code>.</p>
<ul>
<li>Input ratio must be within the maximum and minimum ratios returned by the available ticks.</li>
<li>Does <em>not</em> expected a normalized float.</li>
</ul>
<p>The function works as follows:</p>
<ul>
<li>Approximate log2(ratio) to the 13th fractional digit.</li>
<li>Following <a href="https://hackmd.io/@mangrovedao/HJvl21zla">https://hackmd.io/@mangrovedao/HJvl21zla</a>, obtain <code>tickLow</code> and <code>tickHigh</code> such that <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo><mi>log</mi><mo>⁡</mo></mo><mn>1.0001</mn></msub><mo stretchy="false">(</mo><mi>r</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\log_{1.0001}(ratio)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.20696799999999996em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight">.</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">0</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.24414em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mclose">)</span></span></span></span> is between them</li>
<li>Return the highest one that yields a ratio below the input ratio.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>149
150
151
152
153
154
155
156
157
158</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">tickFromNormalizedRatio</span><span class="token punctuation">(</span><span class="token builtin">uint</span> mantissa<span class="token punctuation">,</span> <span class="token builtin">uint</span> exp<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Tick tick<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">floatLt</span><span class="token punctuation">(</span>mantissa<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> MIN_RATIO_MANTISSA<span class="token punctuation">,</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>MIN_RATIO_EXP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"mgv/tickFromRatio/tooLow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">floatLt</span><span class="token punctuation">(</span>MAX_RATIO_MANTISSA<span class="token punctuation">,</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>MAX_RATIO_EXP<span class="token punctuation">)</span><span class="token punctuation">,</span> mantissa<span class="token punctuation">,</span> exp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"mgv/tickFromRatio/tooHigh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token builtin">int</span> log2ratio <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>MANTISSA_BITS_MINUS_ONE<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">int</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">64</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> mpow <span class="token operator">=</span> mantissa <span class="token operator">>></span> MANTISSA_BITS_MINUS_ONE <span class="token operator">-</span> <span class="token number">127</span><span class="token punctuation">;</span> <span class="token comment">// give 129 bits of room left</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>How the fractional digits of the log are computed:</p>
<ul>
<li>for a given <code>n</code> compute <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>n</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">n^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141079999999999em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>.</li>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⌊</mo><msub><mo><mi>log</mi><mo>⁡</mo></mo><mn>2</mn></msub><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mo stretchy="false">⌋</mo><mo>=</mo><mn>2</mn><mo stretchy="false">⌊</mo><msub><mo><mi>log</mi><mo>⁡</mo></mo><mn>2</mn></msub><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">⌋</mo></mrow><annotation encoding="application/x-tex">\lfloor\log_2(n^2)\rfloor = 2\lfloor\log_2(n)\rfloor</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mopen">⌊</span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.20696799999999996em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.24414em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">⌋</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mopen">⌊</span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.20696799999999996em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.24414em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mclose">⌋</span></span></span></span> then the fractional part of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo><mi>log</mi><mo>⁡</mo></mo><mn>2</mn></msub><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\log_2(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.20696799999999996em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.24414em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> was <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">&lt; 0.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span></span></span></span> (first digit is 0).</li>
<li>If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⌊</mo><msub><mo><mi>log</mi><mo>⁡</mo></mo><mn>2</mn></msub><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo><mo stretchy="false">⌋</mo><mo>=</mo><mn>1</mn><mo>+</mo><mn>2</mn><mo stretchy="false">⌊</mo><msub><mo><mi>log</mi><mo>⁡</mo></mo><mn>2</mn></msub><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">⌋</mo></mrow><annotation encoding="application/x-tex">\lfloor\log_2(n^2)\rfloor = 1 + 2\lfloor\log_2(n)\rfloor</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mopen">⌊</span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.20696799999999996em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.24414em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">⌋</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2</span><span class="mopen">⌊</span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.20696799999999996em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.24414em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mclose">⌋</span></span></span></span> then the fractional part of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo><mi>log</mi><mo>⁡</mo></mo><mn>2</mn></msub><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\log_2(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.20696799999999996em;"><span style="top:-2.4558600000000004em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.24414em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> was <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≥</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">\geq 0.5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7719400000000001em;vertical-align:-0.13597em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">0</span><span class="mord">.</span><span class="mord">5</span></span></span></span> (first digit is 1).</li>
<li>Apply starting with <code>n=mpow</code> repeatedly by keeping <code>n</code> on 127 bits through right-shifts (has no impact on high fractional bits).</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>165
166</pre></code>
          <pre>
    <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>13 bits of precision</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232</pre></code>
          <pre>      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>mpow<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">let</span> highbit <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>
      log2ratio <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">,</span> highbit<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span>highbit<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>

      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>mpow<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span><span class="token punctuation">)</span>
      highbit <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>
      log2ratio <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">62</span><span class="token punctuation">,</span> highbit<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span>highbit<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>

      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>mpow<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span><span class="token punctuation">)</span>
      highbit <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>
      log2ratio <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">61</span><span class="token punctuation">,</span> highbit<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span>highbit<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>

      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>mpow<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span><span class="token punctuation">)</span>
      highbit <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>
      log2ratio <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> highbit<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span>highbit<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>

      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>mpow<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span><span class="token punctuation">)</span>
      highbit <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>
      log2ratio <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">59</span><span class="token punctuation">,</span> highbit<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span>highbit<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>

      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>mpow<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span><span class="token punctuation">)</span>
      highbit <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>
      log2ratio <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">58</span><span class="token punctuation">,</span> highbit<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span>highbit<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>

      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>mpow<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span><span class="token punctuation">)</span>
      highbit <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>
      log2ratio <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">57</span><span class="token punctuation">,</span> highbit<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span>highbit<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>

      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>mpow<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span><span class="token punctuation">)</span>
      highbit <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>
      log2ratio <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">56</span><span class="token punctuation">,</span> highbit<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span>highbit<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>

      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>mpow<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span><span class="token punctuation">)</span>
      highbit <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>
      log2ratio <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">55</span><span class="token punctuation">,</span> highbit<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span>highbit<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>

      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>mpow<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span><span class="token punctuation">)</span>
      highbit <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>
      log2ratio <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">54</span><span class="token punctuation">,</span> highbit<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span>highbit<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>

      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>mpow<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span><span class="token punctuation">)</span>
      highbit <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>
      log2ratio <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">53</span><span class="token punctuation">,</span> highbit<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span>highbit<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>

      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>mpow<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span><span class="token punctuation">)</span>
      highbit <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>
      log2ratio <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">52</span><span class="token punctuation">,</span> highbit<span class="token punctuation">)</span><span class="token punctuation">)</span>
      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span>highbit<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>

      mpow <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>mpow<span class="token punctuation">,</span> mpow<span class="token punctuation">)</span><span class="token punctuation">)</span>
      highbit <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> mpow<span class="token punctuation">)</span>
      log2ratio <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">51</span><span class="token punctuation">,</span> highbit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>Convert log base 2 to log base 1.0001 (multiply by <code>log2(1.0001)^-1 &lt;&lt; 64</code>), since log2ratio is x64 this yields a x128 number.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>234
235</pre></code>
          <pre>    <span class="token builtin">int</span> log_bp_ratio <span class="token operator">=</span> log2ratio <span class="token operator">*</span> <span class="token number">127869479499801913173571</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>tickLow is approx - maximum error</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>237</pre></code>
          <pre>    <span class="token builtin">int</span> tickLow <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>log_bp_ratio <span class="token operator">-</span> <span class="token number">1701496478404567508395759362389778998</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>tickHigh is approx + minimum error</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>239
240
241
242
243
244
245
246
247
248
249
250</pre></code>
          <pre>    <span class="token builtin">int</span> tickHigh <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>log_bp_ratio <span class="token operator">+</span> <span class="token number">289637967442836606107396900709005211253</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">(</span><span class="token builtin">uint</span> mantissaHigh<span class="token punctuation">,</span> <span class="token builtin">uint</span> expHigh<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">ratioFromTick</span><span class="token punctuation">(</span>Tick<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>tickHigh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">bool</span> ratioHighGt <span class="token operator">=</span> <span class="token function">floatLt</span><span class="token punctuation">(</span>mantissa<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> mantissaHigh<span class="token punctuation">,</span> expHigh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tickLow <span class="token operator">==</span> tickHigh <span class="token operator">||</span> ratioHighGt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tick <span class="token operator">=</span> Tick<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>tickLow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> 
      tick <span class="token operator">=</span> Tick<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>tickHigh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>tick → ratio conversion function</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns a normalized (man,exp) ratio floating-point number. The mantissa is on 128 bits to avoid overflow when mulitplying with token amounts. The exponent has no bias. for easy comparison.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>253
254
255
256
257</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">ratioFromTick</span><span class="token punctuation">(</span>Tick tick<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> man<span class="token punctuation">,</span> <span class="token builtin">uint</span> exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>man<span class="token punctuation">,</span> exp<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">nonNormalizedRatioFromTick</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin">int</span> shiftedTick <span class="token operator">=</span> Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> LOG_BP_SHIFT<span class="token punctuation">;</span>
      <span class="token builtin">int</span> log2ratio<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>floor log2 of ratio towards negative infinity</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>259
260
261
262
263
264</pre></code>
          <pre>      <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log2ratio <span class="token operator">:=</span> <span class="token function">sdiv</span><span class="token punctuation">(</span>shiftedTick<span class="token punctuation">,</span>LOG_BP_2X235<span class="token punctuation">)</span>
        log2ratio <span class="token operator">:=</span> <span class="token function">sub</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">,</span><span class="token function">slt</span><span class="token punctuation">(</span><span class="token function">smod</span><span class="token punctuation">(</span>shiftedTick<span class="token punctuation">,</span>LOG_BP_2X235<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token builtin">int</span> diff <span class="token operator">=</span> log2ratio<span class="token operator">+</span><span class="token builtin">int</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token operator">-</span><span class="token builtin">int</span><span class="token punctuation">(</span>MANTISSA_BITS_MINUS_ONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>diff <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>For |tick| &lt;= 887272, this drops at most 5 bits of precision</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>266
267
268
269</pre></code>
          <pre>        man <span class="token operator">=</span> man <span class="token operator">>></span> <span class="token builtin">uint</span><span class="token punctuation">(</span>diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        man <span class="token operator">=</span> man <span class="token operator">&lt;&lt;</span> <span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token operator">-</span>diff<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>For |tick| &lt;&lt; 887272, log2ratio &lt;= 127</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>271
272
273
274</pre></code>
          <pre>      exp <span class="token operator">=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>MANTISSA_BITS_MINUS_ONE<span class="token punctuation">)</span><span class="token operator">-</span>log2ratio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>low-level tick → ratio conversion</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Compute 1.0001^tick and returns it as a (mantissa,exponent) pair. Works by checking each set bit of <code>|tick|</code> multiplying by <code>1.0001^(-2**i)&lt;&lt;128</code> if the ith bit of tick is set. Since we inspect the absolute value of <code>tick</code>, <code>-1048576</code> is not a valid tick. If the tick is positive this computes <code>1.0001^-tick</code>, and we take the inverse at the end. For maximum precision some powers of 1.0001 are shifted until they occupy 128 bits. The <code>extra_shift</code> is recorded and added to the exponent.</p>
<p>Since the resulting mantissa is left-shifted by 128 bits, if tick was positive, we divide <code>2**256</code> by the mantissa to get the 128-bit left-shifted inverse of the mantissa.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">nonNormalizedRatioFromTick</span><span class="token punctuation">(</span>Tick tick<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> man<span class="token punctuation">,</span> <span class="token builtin">uint</span> exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> absTick <span class="token operator">=</span> Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token operator">-</span>Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>absTick <span class="token operator">&lt;=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>MAX_TICK<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"mgv/absTick/outOfBounds"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">int</span> extra_shift<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x1</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token number">0xfff97272373d413259a46990580e2139</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token number">0x100000000000000000000000000000000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x2</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xfff2e50f5f656932ef12357cf3c7fdcb</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x4</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xffe5caca7e10e4e61c3624eaa0941ccf</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x8</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xffcb9843d60f6159c9db58835c926643</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x10</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xff973b41fa98c081472e6896dfb254bf</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x20</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xff2ea16466c96a3843ec78b326b52860</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x40</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xfe5dee046a99a2a811c461f1969c3052</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x80</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xfcbe86c7900a88aedcffc83b479aa3a3</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x100</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xf987a7253ac413176f2b074cf7815e53</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x200</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xf3392b0822b70005940c7a398e4b70f2</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x400</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xe7159475a2c29b7443b29c7fa6e889d8</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x800</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xd097f3bdfd2022b8845ad8f792aa5825</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x1000</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xa9f746462d870fdf8a65dc1f90e061e4</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x2000</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xe1b0d342ada5437121767bec575e65ed</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
      extra_shift <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x4000</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xc6f84d7e5f423f66048c541550bf3e96</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
      extra_shift <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x8000</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0x9aa508b5b7a84e1c677de54f3e99bc8f</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
      extra_shift <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x10000</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xbad5f1bdb70232cd33865244bdcc089c</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
      extra_shift <span class="token operator">+=</span> <span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x20000</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0x885b9613d7e87aa498106fb7fa5edd37</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
      extra_shift <span class="token operator">+=</span> <span class="token number">18</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x40000</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0x9142e0723efb884889d1f447715afacd</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
      extra_shift <span class="token operator">+=</span> <span class="token number">37</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>absTick <span class="token operator">&amp;</span> <span class="token number">0x80000</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      man <span class="token operator">=</span> <span class="token punctuation">(</span>man <span class="token operator">*</span> <span class="token number">0xa4d9a773d61316918f140bd96e8e6814</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">128</span><span class="token punctuation">;</span>
      extra_shift <span class="token operator">+=</span> <span class="token number">75</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Tick<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>tick<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We use <a href="https://xn--2-umb.com/17/512-bit-division/#divide-2-256-by-a-given-number">Remco Bloemen’s trick</a> to divide <code>2**256</code> by <code>man</code>:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>356
357
358
359
360
361
362
363
364</pre></code>
          <pre>      <span class="token keyword">assembly</span><span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        man <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">div</span><span class="token punctuation">(</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> man<span class="token punctuation">)</span><span class="token punctuation">,</span> man<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      extra_shift <span class="token operator">=</span> <span class="token operator">-</span>extra_shift<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    exp <span class="token operator">=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token number">128</span> <span class="token operator">+</span> extra_shift<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Shift mantissa so it occupies exactly <code>MANTISSA_BITS</code> and adjust <code>exp</code> in consequence.</p>
<p>A float is normalized when its mantissa occupies exactly 128 bits. All in-range normalized floats have <code>exp &gt;= 0</code>, so we can use a <code>uint</code> for exponents everywhere we expect a normalized float.</p>
<p>When a non-normalized float is expected/used, <code>exp</code> can be negative since there is no constraint on the size of the mantissa.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">normalizeRatio</span><span class="token punctuation">(</span><span class="token builtin">uint</span> mantissa<span class="token punctuation">,</span> <span class="token builtin">int</span> exp<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">,</span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">require</span><span class="token punctuation">(</span>mantissa <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">"mgv/normalizeRatio/mantissaIs0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> log2ratio <span class="token operator">=</span> BitLib<span class="token punctuation">.</span><span class="token function">fls</span><span class="token punctuation">(</span>mantissa<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">int</span> shift <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>MANTISSA_BITS_MINUS_ONE<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">int</span><span class="token punctuation">(</span>log2ratio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shift <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mantissa <span class="token operator">=</span> mantissa <span class="token operator">>></span> <span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token operator">-</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      mantissa <span class="token operator">=</span> mantissa <span class="token operator">&lt;&lt;</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    exp <span class="token operator">=</span> exp <span class="token operator">+</span> shift<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exp <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"mgv/normalizeRatio/lowExp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>mantissa<span class="token punctuation">,</span><span class="token builtin">uint</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Return <code>a/(2**e)</code> rounded up</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>389
390
391</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">divExpUp</span><span class="token punctuation">(</span><span class="token builtin">uint</span> a<span class="token punctuation">,</span> <span class="token builtin">uint</span> e<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token builtin">uint</span> rem<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Let mask be <code>(1&lt;&lt;e)-1</code>, <code>rem</code> is 1 if <code>a &amp; mask &gt; 0</code>, and 0 otherwise.
Explanation:</p>
<ul>
<li>if a is 0 then <code>rem</code> must be 0. <code>0 &amp; mask</code> is 0.</li>
<li>else if <code>e &gt; 255</code> then <code>0 &lt; a &lt; 2^e</code>, so <code>rem</code> must be 1. <code>(1&lt;&lt;e)-1</code> is <code>type(uint).max</code>, so <code>a &amp; mask is a &gt; 0</code>.</li>
<li>else <code>a &amp; mask</code> is <code>a % 2**e</code></li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>399
400
401
402
403
404
405</pre></code>
          <pre>      <span class="token keyword">assembly</span><span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rem <span class="token operator">:=</span> <span class="token function">gt</span><span class="token punctuation">(</span><span class="token function">and</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token function">sub</span><span class="token punctuation">(</span><span class="token function">shl</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>a<span class="token operator">>></span>e<span class="token punctuation">)</span> <span class="token operator">+</span> rem<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Floats are normalized to 128 bits to ensure no overflow when multiplying with amounts, and for easier comparisons. Normalized in-range floats have <code>exp&gt;=0</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>407</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">floatLt</span><span class="token punctuation">(</span><span class="token builtin">uint</span> mantissa_a<span class="token punctuation">,</span> <span class="token builtin">uint</span> exp_a<span class="token punctuation">,</span> <span class="token builtin">uint</span> mantissa_b<span class="token punctuation">,</span> <span class="token builtin">uint</span> exp_b<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Exponents are negated (so that exponents of ratios within the accepted range as &gt;= 0, which simplifies the code), which explains the direction of the <code>exp_a &gt; exp_b</code> comparison.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>409
410
411
412</pre></code>
          <pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>exp_a <span class="token operator">></span> exp_b <span class="token operator">||</span> <span class="token punctuation">(</span>exp_a <span class="token operator">==</span> exp_b <span class="token operator">&amp;&amp;</span> mantissa_a <span class="token operator">&lt;</span> mantissa_b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="bitlib.sol" class="left filebreak">BitLib.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.17</span><span class="token punctuation">;</span>

<span class="token keyword">library</span> <span class="token class-name">BitLib</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><ul>
<li>if x is a nonzero uint64:</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>return number of zeroes in x that do not have a 1 to their right</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><ul>
<li>otherwise:</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>return 64</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>9
10
11</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">ctz64</span><span class="token punctuation">(</span><span class="token builtin">uint</span> x<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>clean</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>13
14</pre></code>
          <pre>        x<span class="token operator">:=</span> <span class="token function">and</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span><span class="token number">0xffffffffffffffff</span><span class="token punctuation">)</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>7th bit</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>16
17</pre></code>
          <pre>        c<span class="token operator">:=</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token function">iszero</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>isolate lsb</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>19
20</pre></code>
          <pre>        x <span class="token operator">:=</span> <span class="token function">and</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token function">not</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>6th bit</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>22
23</pre></code>
          <pre>        c <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>debruijn lookup</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>25
26
27
28
29
30</pre></code>
          <pre>        c <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token builtin">byte</span><span class="token punctuation">(</span><span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">251</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span><span class="token function">shr</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">0x077cb531</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            <span class="token number">0x00011c021d0e18031e16140f191104081f1b0d17151310071a0c12060b050a09</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>The fls function below is general-purpose and used by tests but not by Mangrove itself</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>Function fls is MIT License. Copyright © 2022 Solady.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>/ @dev find last set.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>/ Returns the index of the most significant bit of <code>x</code>,</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>/ counting from the least significant bit position.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>/ If <code>x</code> is zero, returns 256.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>/ Equivalent to <code>log2(x)</code>, but without reverting for the zero case.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>38
39
40
41
42
43
44
45</pre></code>
          <pre>    <span class="token keyword">function</span> <span class="token function">fls</span><span class="token punctuation">(</span><span class="token builtin">uint256</span> x<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint256</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r <span class="token operator">:=</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token function">iszero</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>

            r <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">0xffffffffffffffffffffffffffffffff</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            r <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">0xffffffffffffffff</span><span class="token punctuation">,</span> <span class="token function">shr</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            r <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">0xffffffff</span><span class="token punctuation">,</span> <span class="token function">shr</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>For the remaining 32 bits, use a De Bruijn lookup.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>47
48
49
50
51
52
53</pre></code>
          <pre>            x <span class="token operator">:=</span> <span class="token function">shr</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
            x <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
            x <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
            x <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
            x <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
            x <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>forgefmt: disable-next-item</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>55
56
57
58
59</pre></code>
          <pre>            r <span class="token operator">:=</span> <span class="token function">or</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token builtin">byte</span><span class="token punctuation">(</span><span class="token function">shr</span><span class="token punctuation">(</span><span class="token number">251</span><span class="token punctuation">,</span> <span class="token function">mul</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token function">shl</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">0x07c4acdd</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">0x0009010a0d15021d0b0e10121619031e080c141c0f111807131b17061a05041f</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="offerextra.sol" class="left filebreak">OfferExtra.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7
8</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.17</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token string">"@mgv/lib/core/TickTreeLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"@mgv/lib/core/TickLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Offer<span class="token punctuation">,</span>OfferUnpacked<span class="token punctuation">,</span>OfferLib<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/src/preprocessed/Offer.post.sol"</span><span class="token punctuation">;</span>

</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>cleanup-mask: 0s at location of fields to hide from maker, 1s elsewhere</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>10
11</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> HIDE_FIELDS_FROM_MAKER_MASK <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>OfferLib<span class="token punctuation">.</span>prev_mask_inv <span class="token operator">|</span> OfferLib<span class="token punctuation">.</span>next_mask_inv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Extra functions for the offer</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>13</pre></code>
          <pre><span class="token keyword">library</span> <span class="token class-name">OfferExtra</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Compute wants from tick and gives</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>15
16
17
18</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">wants</span><span class="token punctuation">(</span>Offer offer<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> offer<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inboundFromOutboundUp</span><span class="token punctuation">(</span>offer<span class="token punctuation">.</span><span class="token function">gives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Sugar to test offer liveness</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>20
21
22
23
24
25
26</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">isLive</span><span class="token punctuation">(</span>Offer offer<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span> resp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> gives <span class="token operator">=</span> offer<span class="token punctuation">.</span><span class="token function">gives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resp <span class="token operator">:=</span> <span class="token function">iszero</span><span class="token punctuation">(</span><span class="token function">iszero</span><span class="token punctuation">(</span>gives<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Get the bin where the offer is stored given an offer list that has <code>tickSpacing</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>28
29
30
31</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">bin</span><span class="token punctuation">(</span>Offer offer<span class="token punctuation">,</span> <span class="token builtin">uint</span> tickSpacing<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Bin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> offer<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nearestBin</span><span class="token punctuation">(</span>tickSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Removes prev/next pointers from an offer before sending it to the maker.  Ensures that the maker has no information about the state of the book when it gets called.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>33
34
35
36
37
38
39
40
41</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">clearFieldsForMaker</span><span class="token punctuation">(</span>Offer offer<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Offer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    unchecked <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Offer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
        Offer<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>offer<span class="token punctuation">)</span>
        <span class="token operator">&amp;</span> HIDE_FIELDS_FROM_MAKER_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Extra functions for the struct version of the offer</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>43</pre></code>
          <pre><span class="token keyword">library</span> <span class="token class-name">OfferUnpackedExtra</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Compute wants from tick and gives</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>45
46
47
48</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">wants</span><span class="token punctuation">(</span>OfferUnpacked <span class="token keyword">memory</span> offer<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> offer<span class="token punctuation">.</span>tick<span class="token punctuation">.</span><span class="token function">inboundFromOutboundUp</span><span class="token punctuation">(</span>offer<span class="token punctuation">.</span>gives<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Sugar to test offer liveness</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>50
51
52
53
54
55
56</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">isLive</span><span class="token punctuation">(</span>OfferUnpacked <span class="token keyword">memory</span> offer<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span> resp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">uint</span> gives <span class="token operator">=</span> offer<span class="token punctuation">.</span>gives<span class="token punctuation">;</span>
    <span class="token keyword">assembly</span> <span class="token punctuation">(</span><span class="token string">"memory-safe"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resp <span class="token operator">:=</span> <span class="token function">iszero</span><span class="token punctuation">(</span><span class="token function">iszero</span><span class="token punctuation">(</span>gives<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Removes prev/next pointers from an offer before sending it to the maker; Ensures that the maker has no information about the state of the book when it gets called.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>58
59
60
61
62</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">bin</span><span class="token punctuation">(</span>OfferUnpacked <span class="token keyword">memory</span> offer<span class="token punctuation">,</span> <span class="token builtin">uint</span> tickSpacing<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Bin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> offer<span class="token punctuation">.</span>tick<span class="token punctuation">.</span><span class="token function">nearestBin</span><span class="token punctuation">(</span>tickSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="offerdetailextra.sol" class="left filebreak">OfferDetailExtra.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.17</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>OfferDetail<span class="token punctuation">,</span>OfferDetailUnpacked<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/src/preprocessed/OfferDetail.post.sol"</span><span class="token punctuation">;</span>

</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Extra functions for the offer details</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>8
9
10
11
12
13
14
15
16</pre></code>
          <pre><span class="token keyword">library</span> <span class="token class-name">OfferDetailExtra</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">offer_gasbase</span><span class="token punctuation">(</span>OfferDetail offerDetail<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> offerDetail<span class="token punctuation">.</span><span class="token function">kilo_offer_gasbase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1e3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">offer_gasbase</span><span class="token punctuation">(</span>OfferDetail offerDetail<span class="token punctuation">,</span><span class="token builtin">uint</span> val<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>OfferDetail<span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> offerDetail<span class="token punctuation">.</span><span class="token function">kilo_offer_gasbase</span><span class="token punctuation">(</span>val<span class="token operator">/</span><span class="token number">1e3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Extra functions for the struct version of the offer details</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>18
19
20
21
22
23
24
25</pre></code>
          <pre><span class="token keyword">library</span> <span class="token class-name">OfferDetailUnpackedExtra</span> <span class="token punctuation">{</span>
  <span class="token keyword">function</span> <span class="token function">offer_gasbase</span><span class="token punctuation">(</span>OfferDetailUnpacked <span class="token keyword">memory</span> offerDetail<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> offerDetail<span class="token punctuation">.</span>kilo_offer_gasbase <span class="token operator">*</span> <span class="token number">1e3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">offer_gasbase</span><span class="token punctuation">(</span>OfferDetailUnpacked <span class="token keyword">memory</span> offerDetail<span class="token punctuation">,</span><span class="token builtin">uint</span> val<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    offerDetail<span class="token punctuation">.</span>kilo_offer_gasbase <span class="token operator">=</span> val<span class="token operator">/</span><span class="token number">1e3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="localextra.sol" class="left filebreak">LocalExtra.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7
8
9</pre></code>
          <pre><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.8.17</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>Bin<span class="token punctuation">,</span>TickTreeLib<span class="token punctuation">,</span>Field<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/TickTreeLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Density<span class="token punctuation">,</span> DensityLib<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/lib/core/DensityLib.sol"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Local<span class="token punctuation">,</span>LocalUnpacked<span class="token punctuation">,</span>LocalLib<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"@mgv/src/preprocessed/Local.post.sol"</span><span class="token punctuation">;</span>


</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>cleanup-mask: 0s at location of fields to hide from maker, 1s elsewhere</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>11
12</pre></code>
          <pre><span class="token builtin">uint</span> <span class="token keyword">constant</span> HIDE_FIELDS_FROM_MAKER_MASK <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>LocalLib<span class="token punctuation">.</span>binPosInLeaf_mask_inv <span class="token operator">|</span> LocalLib<span class="token punctuation">.</span>level3_mask_inv <span class="token operator">|</span> LocalLib<span class="token punctuation">.</span>level2_mask_inv <span class="token operator">|</span> LocalLib<span class="token punctuation">.</span>level1_mask_inv <span class="token operator">|</span> LocalLib<span class="token punctuation">.</span>root_mask_inv <span class="token operator">|</span> LocalLib<span class="token punctuation">.</span>last_mask_inv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Extra functions for local</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>14
15</pre></code>
          <pre><span class="token keyword">library</span> <span class="token class-name">LocalExtra</span> <span class="token punctuation">{</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Sets the density in fixed-point 96X32 format (it is stored in floating-point, see <code>DensityLib</code> for more information).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>17
18
19
20</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">densityFrom96X32</span><span class="token punctuation">(</span>Local local<span class="token punctuation">,</span> <span class="token builtin">uint</span> density96X32<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Local<span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> local<span class="token punctuation">.</span><span class="token function">density</span><span class="token punctuation">(</span>DensityLib<span class="token punctuation">.</span><span class="token function">from96X32</span><span class="token punctuation">(</span>density96X32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the gasbase in gas (it is stored in kilogas)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>22
23
24
25</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">offer_gasbase</span><span class="token punctuation">(</span>Local local<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> local<span class="token punctuation">.</span><span class="token function">kilo_offer_gasbase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1e3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Sets the gasbase in gas (it is stored in kilogas)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>27
28
29
30</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">offer_gasbase</span><span class="token punctuation">(</span>Local local<span class="token punctuation">,</span><span class="token builtin">uint</span> val<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Local<span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> local<span class="token punctuation">.</span><span class="token function">kilo_offer_gasbase</span><span class="token punctuation">(</span>val<span class="token operator">/</span><span class="token number">1e3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the bin that contains the best offer in `local`'s offer list</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>32
33
34
35</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">bestBin</span><span class="token punctuation">(</span>Local local<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Bin<span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> TickTreeLib<span class="token punctuation">.</span><span class="token function">bestBinFromLocal</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Erases field that give information about the current structure of the offer list.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>37
38
39
40
41
42
43</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">clearFieldsForMaker</span><span class="token punctuation">(</span>Local local<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Local<span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Local<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
      Local<span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span>
      <span class="token operator">&amp;</span> HIDE_FIELDS_FROM_MAKER_MASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Extra functions for the struct version of local</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>45</pre></code>
          <pre><span class="token keyword">library</span> <span class="token class-name">LocalUnpackedExtra</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Sets the density in fixed-point 96X32 format (it is stored in floating-point, see <code>DensityLib</code> for more information).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>47
48
49
50</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">densityFrom96X32</span><span class="token punctuation">(</span>LocalUnpacked <span class="token keyword">memory</span> local<span class="token punctuation">,</span> <span class="token builtin">uint</span> density96X32<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    local<span class="token punctuation">.</span>density <span class="token operator">=</span> DensityLib<span class="token punctuation">.</span><span class="token function">from96X32</span><span class="token punctuation">(</span>density96X32<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the gasbase in gas (it is stored in kilogas)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>52
53
54
55</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">offer_gasbase</span><span class="token punctuation">(</span>LocalUnpacked <span class="token keyword">memory</span> local<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> local<span class="token punctuation">.</span>kilo_offer_gasbase <span class="token operator">*</span> <span class="token number">1e3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Sets the gasbase in gas (it is stored in kilogas)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>57
58
59
60</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">offer_gasbase</span><span class="token punctuation">(</span>LocalUnpacked <span class="token keyword">memory</span> local<span class="token punctuation">,</span><span class="token builtin">uint</span> val<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    local<span class="token punctuation">.</span>kilo_offer_gasbase <span class="token operator">=</span> val<span class="token operator">/</span><span class="token number">1e3</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
</pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the bin that contains the best offer in `local`'s offer list</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>62
63
64
65</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">bestBin</span><span class="token punctuation">(</span>LocalUnpacked <span class="token keyword">memory</span> local<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>Bin<span class="token punctuation">)</span> <span class="token punctuation">{</span> unchecked <span class="token punctuation">{</span>
    <span class="token keyword">return</span> TickTreeLib<span class="token punctuation">.</span><span class="token function">bestBinFromBranch</span><span class="token punctuation">(</span>local<span class="token punctuation">.</span>binPosInLeaf<span class="token punctuation">,</span>local<span class="token punctuation">.</span>level3<span class="token punctuation">,</span>local<span class="token punctuation">.</span>level2<span class="token punctuation">,</span>local<span class="token punctuation">.</span>level1<span class="token punctuation">,</span>local<span class="token punctuation">.</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  </main>
  </body>
</html>
